(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[14],{"+x2w":function(t,e,i){"use strict";i.r(e),i.d(e,"Viewer",(function(){return ue}));var s=i("McF2"),r=i("zcj1"),o=i("tehY"),n=i("oDdi"),a=i("hEnr");class l extends n.a{get type(){return"Spinner"}constructor(t,e={}){super(t,e),this._canvas=e.canvas,this._element=null,this._isCustom=!1,e.elementId&&(this._element=document.getElementById(e.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+e.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const t=document.createElement("div"),e=t.style;e["z-index"]="9000",e.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const t="xeokit-spinner-css";if(document.getElementById(t))return;const e=document.createElement("style");e.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",e.id=t,document.body.appendChild(e)}_adjustPosition(){if(this._isCustom)return;const t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}set processes(t){if(t=t||0,this._processes===t)return;if(t<0)return;const e=this._processes;this._processes=t;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==e&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null)}}var h=i("bFGi");const c=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class d extends n.a{get type(){return"Canvas"}constructor(t,e={}){super(t,e),this.canvas=e.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(e);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(t){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(t){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),t.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let r=null,o=null,n=null,h=null,c=null,d=null,u=null;this._tick=this.scene.on("tick",(function(){const t=i.canvas,e=window.innerWidth!==r||window.innerHeight!==o,l=t.clientWidth!==n||t.clientHeight!==h,_=t.offsetLeft!==c||t.offsetTop!==d,p=t.parentElement;if(e||l||_||p!==u){if(i._spinner._adjustPosition(),l||_){const e=t.clientWidth,r=t.clientHeight;if(l){let e,i=0;for(const t in s.a.scenes)s.a.scenes.hasOwnProperty(t)&&(e=s.a.scenes[t],i+=e.canvas.canvas.clientWidth*e.canvas.canvas.clientHeight);a.a.memory.pixels=i,t.width=t.clientWidth,t.height=t.clientHeight}const o=i.boundary;o[0]=t.offsetLeft,o[1]=t.offsetTop,o[2]=e,o[3]=r,i.fire("boundary",o),n=e,h=r}e&&(r=window.innerWidth,o=window.innerHeight),_&&(c=t.offsetLeft,d=t.offsetTop),u=p}})),this._spinner=new l(this.scene,{canvas:this.canvas,elementId:e.spinnerElementId}),this.clearColorAmbient=e.clearColorAmbient}_createCanvas(){const t="xeokit-canvas-"+o.a.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)}_getElementXY(t){let e=0,i=0;for(;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<c.length;e++)try{this.gl=this.canvas.getContext(c[e],this.contextAttr)}catch(t){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else{if(h.a.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const t=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}if(h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth){this.gl.getExtension("EXT_frag_depth")}}}set clearColorAmbient(t){this._clearColorAmbient=!!t}get clearColorAmbient(){return this._clearColorAmbient}getSnapshot(t){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(t,e,i,s){return this.scene._renderer.readPixels(t,e,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}get spinner(){return this._spinner}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}var u=i("pVQg");class _{constructor(t){this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1}getRTCViewMatrix(t,e){let i=this._rtcViewMats[t];return i||(i=this._getNewMat(),Object(u.a)(this._scene.camera.viewMatrix,e,i),this._rtcViewMats[t]=i),i}getRTCPickViewMatrix(t,e){let i=this._rtcPickViewMats[t];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;Object(u.a)(s,e,i),this._rtcPickViewMats[t]=i}return i}_getNewMat(){let t=this._matPool[this._matPoolNextFreeIndex];return t||(t=o.a.mat4(),this._matPool[this._matPoolNextFreeIndex]=t),this._matPoolNextFreeIndex++,t}}const p=function(){const t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!t.getContext("2d").getImageData,s=!!t.toDataURL,r=!!window.btoa,o=function(t){let i="";const s=t.width,r=t.height;i+="BM";let o=s*r*4+54;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);let n=s;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256);let a=r;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),i+=e(1,0,32,0),i+=e(0,0,0,0);let l=s*r*4;i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=t.data;let c,d,u,_,p="",f=r;do{for(u=s*(f-1)*4,_="",c=0;c<s;c++)d=4*c,_+=e(h[u+d+2],h[u+d+1],h[u+d],h[u+d+3]);p+=_}while(--f);return function(t){let i,s,r="";if("string"==typeof t)r=t;else for(s=t,i=0;i<s.length;i++)r+=e(s[i]);return btoa(r)}(i+p)},n=function(t){window.open(t)||(document.location.href=t)},a=function(t,e){return"data:"+e+";base64,"+t},l=function(t){const e=document.createElement("img");return e.src=t,e},h=function(t,e,i,s){if(e&&i){const r=document.createElement("canvas");r.width=e,r.height=i,r.style.width=e+"px",r.style.height=i+"px";const o=r.getContext("2d");return s?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,-i),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,i)),r}return t};return{saveAsPNG:function(t,e,i,r,o){if(!s)return!1;const a="image/png",c=h(t,i,r,o).toDataURL(a);return e?l(c):(n(c),!0)},saveAsJPEG:function(t,e,i,r,o){if(!s)return!1;const a="image/jpeg",c=h(t,i,r,o).toDataURL(a);return 5==c.indexOf(a)&&(e?l(c):(n(c),!0))},saveAsBMP:function(t,e,c,d,u){if(!(s&&i&&r))return!1;const _="image/bmp",p=function(t){const e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(h(t,c,d,u)),f=o(p);return e?l(a(f,_)):(n(a(f,_)),!0)}}}();class f{constructor(t,e,i){i=i||{},this.gl=e,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=i.size}setSize(t){this.size=t}webglContextRestored(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let t,e;const i=this.gl;if(this.size?(t=this.size[0],e=this.size[1]):(t=i.drawingBufferWidth,e=i.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null);const r=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);const o=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,r),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,o),!i.isFramebuffer(o))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:o,renderbuf:r,texture:s,width:t,height:e},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}read(t,e){const i=t,s=this.gl.drawingBufferHeight-e,r=new Uint8Array(4),o=this.gl;return o.readPixels(i,s,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}readImage(t){const e=this.gl,i=this._getImageDataCache(),s=i.pixelData,r=i.canvas,o=i.imageData,n=i.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,s),o.data.set(s),n.putImageData(o,0,0);const a=t.width||r.width,l=t.height||r.height,h=t.format||"jpeg",c=!0;let d;switch(h){case"jpeg":d=p.saveAsJPEG(r,!0,a,l,c);break;case"png":d=p.saveAsPNG(r,!0,a,l,c);break;case"bmp":d=p.saveAsBMP(r,!0,a,l,c);break;default:console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),d=p.saveAsJPEG(r,!0,a,l,c)}return d.src}_getImageDataCache(){const t=this.buffer.width,e=this.buffer.height;let i=this._imageDataCache;if(i&&(i.width===t&&i.height===e||(this._imageDataCache=null,i=null)),!i){const s=document.createElement("canvas");s.width=t,s.height=e;const r=s.getContext("2d"),o=r.createImageData(t,e);i={pixelData:new Uint8Array(t*e*4),canvas:s,context:r,imageData:o,width:t,height:e},this._imageDataCache=i}return i}unbind(){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.bound=!1}getTexture(){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const t=this.gl;t.deleteTexture(this.buffer.texture),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null}}var g=i("jWoc");class m{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(t){t?(this._canvasPos[0]=t[0],this._canvasPos[1]=t[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(t){t?(this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(t){t?(this._direction[0]=t[0],this._direction[1]=t[1],this._direction[2]=t[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(t){t?(this._indices[0]=t[0],this._indices[1]=t[1],this._indices[2]=t[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(t){t?(this._localPos[0]=t[0],this._localPos[1]=t[1],this._localPos[2]=t[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(t){t?(this._worldPos[0]=t[0],this._worldPos[1]=t[1],this._worldPos[2]=t[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(t){t?(this._viewPos[0]=t[0],this._viewPos[1]=t[1],this._viewPos[2]=t[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(t){t?(this._bary[0]=t[0],this._bary[1]=t[1],this._bary[2]=t[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(t){t?(this._worldNormal[0]=t[0],this._worldNormal[1]=t[1],this._worldNormal[2]=t[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(t){t?(this._uv[0]=t[0],this._uv[1]=t[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}var v=i("mrKj"),b=i("f7Wv");class y{constructor(t,e){this.scene=t,this.aabb=o.a.AABB3(),this.rtcCenter=o.a.vec3(e),this.rtcCenterHash=this.rtcCenter.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(t){this.markers[t.id]=t,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(t){if(!this.markers[t.id])return;const e=this.markerIndices[t.id];this.positions[3*e+0]=t.worldPos[0],this.positions[3*e+1]=t.worldPos[1],this.positions[3*e+2]=t.worldPos[2],this.positionsDirty=!0}removeMarker(t){delete this.markers[t.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){for(var t in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(t)&&(this.markerList[this.numMarkers]=this.markers[t],this.markerIndices[t]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let t=0;for(let e=0;e<this.numMarkers;e++)if(this.markerList[e]){const i=this.markerList[e].worldPos;this.positions[t++]=i[0],this.positions[t++]=i[1],this.positions[t++]=i[2],this.indices[e]=e}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}_buildAABB(){const t=this.aabb;o.a.collapseAABB3(t),o.a.expandAABB3Points3(t,this.positions);const e=this.rtcCenter;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const t=this.scene.canvas.gl,e=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new b.a(t,t.ARRAY_BUFFER,new Float32Array(this.positions),e,3,t.STATIC_DRAW),this.indicesBuf=new b.a(t,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,t.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const t=this.scene.canvas,e=this.scene.camera.perspective.near,i=t.boundary,s=i[2],r=i[3];let o=0;this.lenOcclusionTestList=0;for(let n=0;n<this.numMarkers;n++){const t=this.markerList[n];if(t.viewPos[2]>-e){t._setVisible(!1);continue}const i=t.canvasPos,a=i[0],l=i[1];a+10<0||l+10<0||a-10>s||l-10>r?t._setVisible(!1):!t.entity||t.entity.visible?t.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=t,this.pixels[o++]=a,this.pixels[o++]=l):t._setVisible(!0):t._setVisible(!1)}}_updateActiveSectionPlanes(){const t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(let i=0;i<e;i++){const e=t[i];if(e.active){const t=o.a.planeAABB3Intersect(e.dir,e.dist,this.aabb);if(-1===t)return void(this.culledBySectionPlanes=!0);const s=0===t;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const w=o.a.vec3([1,0,0]),P=o.a.vec3();class E{constructor(t){this._scene=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0}))}addMarker(t){const e=t.rtcCenter.join();let i=this._occlusionLayers[e];i||(i=new y(this._scene,t.rtcCenter),this._occlusionLayers[i.rtcCenterHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(t),this._markersToOcclusionLayersMap[t.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(t){const e=this._markersToOcclusionLayersMap[t.id];if(!e)return void t.error("Marker has not been added to OcclusionTester");const i=t.rtcCenter.join();if(i!==e.rtcCenterHash){1===e.numMarkers?(e.destroy(),delete this._occlusionLayers[e.rtcCenterHash],this._occlusionLayersListDirty=!0):e.removeMarker(t);let s=this._occlusionLayers[i];s||(s=new y(this._scene,t.rtcCenter),this._occlusionLayers[i]=e,this._occlusionLayersListDirty=!0),s.addMarker(t),this._markersToOcclusionLayersMap[t.id]=s}else e.markerWorldPosUpdated(t)}removeMarker(t){const e=t.rtcCenter.join();let i=this._occlusionLayers[e];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.rtcCenterHash],this._occlusionLayersListDirty=!0):i.removeMarker(t),delete this._markersToOcclusionLayersMap[t.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const t=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(t!==this._shaderSourceHash&&(this._shaderSourceHash=t,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new f(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let t=0;for(let e in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(e)&&(this._occlusionLayersList[t++]=this._occlusionLayers[e]);this._occlusionLayersList.length=t}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// OcclusionTester vertex shader"),t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),e&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_Position = clipPos;"),i.push("   gl_PointSize = 20.0;"),t.logarithmicDepthBufferEnabled&&(h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("}"),i}_buildFragmentShaderSource(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// OcclusionTester fragment shader"),t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new v.a(e,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let r=0,o=i.sectionPlanes.length;r<o;r++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+r),pos:s.getLocation("sectionPlanePos"+r),dir:s.getLocation("sectionPlaneDir"+r)});this._aPosition=s.getAttribute("position"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t._sectionPlanesState,r=t.camera,o=t.camera.project;if(h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&t.logarithmicDepthBufferEnabled&&e.getExtension("EXT_frag_depth"),i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}for(let n=0,a=this._occlusionLayersList.length;n<a;n++){const t=this._occlusionLayersList[n];if(t.update(),t.culledBySectionPlanes)continue;const i=t.rtcCenter;e.uniformMatrix4fv(this._uViewMatrix,!1,Object(u.a)(r.viewMatrix,i));const o=s.sectionPlanes.length;if(o>0){const r=s.sectionPlanes;for(let s=0;s<o;s++){const o=this._uSectionPlanes[s],n=t.sectionPlanesActive[s];if(e.uniform1i(o.active,n?1:0),n){const t=r[s];e.uniform3fv(o.pos,Object(u.b)(t.dist,t.dir,i,P)),e.uniform3fv(o.dir,t.dir)}}}this._aPosition.bindArrayBuffer(t.positionsBuf);const a=t.indicesBuf;a.bind(),e.drawElements(e.POINTS,a.numItems,a.itemType,0)}}doOcclusionTest(){{const t=255*w[0],e=255*w[1],i=255*w[2];for(let s=0,r=this._occlusionLayersList.length;s<r;s++){const r=this._occlusionLayersList[s];for(let s=0;s<r.lenOcclusionTestList;s++){const o=r.occlusionTestList[s],n=2*s,a=this._readPixelBuf.read(r.pixels[n],r.pixels[n+1]),l=a[0]===t&&a[1]===e&&a[2]===i;o._setVisible(l)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const k=o.a.vec2();class M{constructor(t){this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(t){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=o.a.mat4();return()=>(t&&o.a.inverseMat4(s.camera.projMatrix,e),e)})());const e=this._scene.canvas.gl,i=this._program,s=this._scene,r=s.sao,n=e.drawingBufferWidth,a=e.drawingBufferHeight,l=s.camera.project._state,h=l.near,c=l.far,d=l.matrix,u=this._getInverseProjectMat(),_=Math.random(),p="perspective"===s.camera.projection;k[0]=n,k[1]=a,e.getExtension("OES_standard_derivatives"),e.viewport(0,0,n,a),e.clearColor(0,0,0,1),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),e.frontFace(e.CCW),e.clear(e.COLOR_BUFFER_BIT),i.bind(),e.uniform1f(this._uCameraNear,h),e.uniform1f(this._uCameraFar,c),e.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,d),e.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,u),e.uniform1i(this._uPerspective,p),e.uniform1f(this._uScale,r.scale*(c/5)),e.uniform1f(this._uIntensity,r.intensity),e.uniform1f(this._uBias,r.bias),e.uniform1f(this._uKernelRadius,r.kernelRadius),e.uniform1f(this._uMinResolution,r.minResolution),e.uniform2fv(this._uViewport,k),e.uniform1f(this._uRandomSeed,_),i.bindTexture(this._uDepthTexture,t,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),e.drawElements(e.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let t=!1;const e=this._scene.sao;if(e.numSamples!==this._numSamples&&(this._numSamples=Math.floor(e.numSamples),t=!0),!t)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new v.a(i,{vertex:["#ifdef GL_FRAGMENT_PRECISION_HIGH\n                    precision highp float;\n                    precision highp int;\n                    #else\n                    precision mediump float;\n                    precision mediump int;\n                    #endif\n                    \n                    attribute vec3 aPosition;\n                    attribute vec2 aUV;            \n                    \n                    varying vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#extension GL_OES_standard_derivatives : require\n                #ifdef GL_FRAGMENT_PRECISION_HIGH\n                precision highp float;\n                precision highp int;\n                #else\n                precision mediump float;\n                precision mediump int;\n                #endif                   \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                varying vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( v, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPos ) {\n                \treturn unpackRGBAToFloat( texture2D( uDepthTexture, screenPos ) );\n                }\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \tgl_FragColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }`]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const s=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new b.a(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._uvBuf=new b.a(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new b.a(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const D=new Float32Array(A(17,[0,1])),R=new Float32Array(A(17,[1,0])),S=new Float32Array(function(t,e){const i=[];for(let s=0;s<=t;s++)i.push(x(s,e));return i}(17,4)),C=new Float32Array(2);class T{constructor(t){this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const t=this._scene.canvas.gl;if(this._program=new v.a(t,{vertex:["#ifdef GL_FRAGMENT_PRECISION_HIGH\n                precision highp float;\n                precision highp int;\n                #else\n                precision mediump float;\n                precision mediump int;\n                #endif\n                    \n                attribute vec3 aPosition;\n                attribute vec2 aUV;\n                uniform vec2 uViewport;\n                varying vec2 vUV;\n                varying vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["#ifdef GL_FRAGMENT_PRECISION_HIGH\n                precision highp float;\n                precision highp int;\n                #else\n                precision mediump float;\n                precision mediump int;\n                #endif\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                varying vec2        vUV;\n                varying vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( v, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {\n                \treturn unpackRGBAToFloat( texture2D( uDepthTexture, screenPosition ) );\n                }\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture2D( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    gl_FragColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const e=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new b.a(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this._uvBuf=new b.a(t,t.ARRAY_BUFFER,e,e.length,2,t.STATIC_DRAW),this._indicesBuf=new b.a(t,t.ELEMENT_ARRAY_BUFFER,s,s.length,1,t.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=t.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=t.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(t,e,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=o.a.mat4();return()=>(t&&o.a.inverseMat4(n.camera.projMatrix,e),e)})());const s=this._scene.canvas.gl,r=this._program,n=this._scene,a=s.drawingBufferWidth,l=s.drawingBufferHeight,h=n.camera.project._state,c=h.near,d=h.far;s.viewport(0,0,a,l),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.bind(),C[0]=a,C[1]=l,s.uniform2fv(this._uViewport,C),s.uniform1f(this._uCameraNear,c),s.uniform1f(this._uCameraFar,d),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,R):s.uniform2fv(this._uSampleOffsets,D),s.uniform1fv(this._uSampleWeights,S),r.bindTexture(this._uDepthTexture,t,0),r.bindTexture(this._uOcclusionTexture,e,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function x(t,e){return Math.exp(-t*t/(e*e*2))/(Math.sqrt(2*Math.PI)*e)}function A(t,e){const i=[];for(let s=0;s<=t;s++)i.push(e[0]*s),i.push(e[1]*s);return i}const O=function(t,e){e=e||{};const i=new _(t),s=t.canvas.canvas,r=t.canvas.gl,n=!!e.transparent,l=e.alphaDepthMask,c=new g.a({});let d={},p={},v=!0,b=!0,y=!0,w=!0;const P=new f(s,r),k=new f(s,r),D=new f(s,r),R=new f(s,r),S=new f(s,r);let C=!1;const x=new M(t),A=new T(t);function O(){v&&(!function(){for(let t in d)if(d.hasOwnProperty(t)){const e=d[t],i=e.drawableMap,s=e.drawableListPreCull;let r=0;for(let t in i)i.hasOwnProperty(t)&&(s[r++]=i[t]);s.length=r}}(),v=!1,b=!0),b&&(!function(){for(let t in d)if(d.hasOwnProperty(t)){const e=d[t];e.isStateSortable&&e.drawableListPreCull.sort(e.stateSortCompare)}}(),b=!1,y=!0),y&&function(){for(let t in d)if(d.hasOwnProperty(t)){const e=d[t],i=e.drawableListPreCull,s=e.drawableList;let r=0;for(let t=0,o=i.length;t<o;t++){const e=i[t];e.rebuildRenderFlags(),e.renderFlags.culled||(s[r++]=e)}s.length=r}}()}function L(t){if(!t.castsShadow)return;const e=t.getShadowRenderBuf();if(e){e.bind(),i.reset(),i.backfaces=!0,i.frontface=!0,i.shadowViewMatrix=t.getShadowViewMatrix(),i.shadowProjMatrix=t.getShadowProjMatrix(),r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,1),r.enable(r.DEPTH_TEST),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);for(let t in d)if(d.hasOwnProperty(t)){const e=d[t].drawableList;for(let t=0,s=e.length;t<s;t++){const s=e[t];!1!==s.visible&&s.castsShadow&&s.drawShadow&&(s.renderFlags.colorOpaque&&s.drawShadow(i))}}e.unbind()}}this._occlusionTester=null,this.needStateSort=function(){b=!0},this.shadowsDirty=function(){w=!0},this.imageDirty=function(){y=!0},this.webglContextLost=function(){},this.webglContextRestored=function(t){R.webglContextRestored(t),S.webglContextRestored(t),P.webglContextRestored(t),k.webglContextRestored(t),D.webglContextRestored(t),x.init(),A.init(),y=!0},this.addDrawable=function(t,e){const i=e.type;if(!i)return void console.error("Renderer#addDrawable() : drawable with ID "+t+" has no 'type' - ignoring");let s=d[i];s||(s={type:e.type,count:0,isStateSortable:e.isStateSortable,stateSortCompare:e.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},d[i]=s),s.count++,s.drawableMap[t]=e,p[t]=e,v=!0},this.removeDrawable=function(t){const e=p[t];if(!e)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+t+" - ignoring");const i=e.type,s=d[i];--s.count<=0?delete d[i]:delete s.drawableMap[t],delete p[t],v=!0},this.getPickID=function(t){return c.addItem(t)},this.putPickID=function(t){c.removeItem(t)},this.clear=function(e){if(e=e||{},r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),n)r.clearColor(0,0,0,0);else{const i=e.ambientColor||t.canvas.backgroundColor||this.lights.getAmbientColor();r.clearColor(i[0],i[1],i[2],1)}r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)},this.render=function(e){(e=e||{}).force&&(y=!0),O(),y&&(!function(e){h.a.SUPPORTED_EXTENSIONS.OES_element_index_uint&&r.getExtension("OES_element_index_uint");t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.getExtension("EXT_frag_depth");t.sao.possible&&function(e){const s=t.sao;P.bind(),P.clear(),function(t){i.reset(),i.pass=t.pass,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.frontFace(r.CCW),r.enable(r.CULL_FACE),r.depthMask(!0),!1!==t.clear&&r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);for(let e in d)if(d.hasOwnProperty(e)){const t=d[e].drawableList;for(let e=0,s=t.length;e<s;e++){const s=t[e];!0!==s.culled&&!1!==s.visible&&s.drawDepth&&(s.renderFlags.colorOpaque&&s.drawDepth(i))}}}(e),P.unbind(),k.bind(),k.clear(),x.render(P.getTexture(),null),k.unbind(),s.blur&&(D.bind(),D.clear(),A.render(P.getTexture(),k.getTexture(),0),D.unbind(),k.bind(),k.clear(),A.render(P.getTexture(),D.getTexture(),1),k.unbind())}(e);(function(){let e=t._lightsState.lights;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.castsShadow&&L(i)}w=!1})(),I(e)}(e),a.a.frame.frameCount++,y=!1)};const I=function(){const e=[],s=[],o=[],c=[],u=[],_=[],p=[],f=[],g=[],m=[],v=[],b=[],y=[],w=[],P=[],E=[];return function(M){const D=t._lightsState.getAmbientColor();if(i.reset(),i.pass=M.pass,i.withSAO=!1,i.pbrEnabled=!!t.pbrEnabled,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),n)r.clearColor(0,0,0,0);else{const e=t.canvas.backgroundColor||D;r.clearColor(e[0],e[1],e[2],1)}r.enable(r.DEPTH_TEST),r.frontFace(r.CCW),r.enable(r.CULL_FACE),r.depthMask(!0),r.lineWidth(1),i.lineWidth=1;const R=t.sao.possible;let S,C,T;i.occlusionTexture=R?k.getTexture():null;const x=Date.now();!1!==M.clear&&r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);let A=0,O=0,L=0,I=0,j=0,F=0,B=0,U=0,V=0,N=0,Y=0,W=0,K=0,H=0,z=0,X=0;for(let t in d)if(d.hasOwnProperty(t)){const r=d[t].drawableList;for(S=0,C=r.length;S<C;S++){if(T=r[S],!0===T.culled||!1===T.visible)continue;const t=T.renderFlags;t.colorOpaque&&(R&&T.saoEnabled?e[A++]=T:T.drawColorOpaque(i)),t.colorTransparent&&(o[L++]=T),t.xrayedSilhouetteTransparent&&(p[B++]=T),t.xrayedSilhouetteOpaque&&(u[j++]=T),t.highlightedSilhouetteTransparent&&(v[Y++]=T),t.highlightedSilhouetteOpaque&&(g[V++]=T),t.selectedSilhouetteTransparent&&(P[z++]=T),t.selectedSilhouetteOpaque&&(y[K++]=T),t.edgesOpaque&&(s[O++]=T),t.edgesTransparent&&(c[I++]=T),t.selectedEdgesTransparent&&(E[X++]=T),t.selectedEdgesOpaque&&(w[H++]=T),t.xrayedEdgesTransparent&&(f[U++]=T),t.xrayedEdgesOpaque&&(_[F++]=T),t.highlightedEdgesTransparent&&(b[W++]=T),t.highlightedEdgesOpaque&&(m[N++]=T)}}if(A>0)for(i.withSAO=!0,S=0;S<A;S++)e[S].drawColorOpaque(i);if(O>0)for(S=0;S<O;S++)s[S].drawEdgesColorOpaque(i);if(j>0)for(S=0;S<j;S++)u[S].drawSilhouetteXRayed(i);if(F>0)for(S=0;S<F;S++)_[S].drawEdgesXRayed(i);if(B>0||U>0||L>0||I>0){if(r.enable(r.CULL_FACE),r.enable(r.BLEND),n?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):(r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)),i.backfaces=!1,l||r.depthMask(!1),U>0)for(S=0;S<U;S++)f[S].drawEdgesXRayed(i);if(B>0)for(S=0;S<B;S++)p[S].drawSilhouetteXRayed(i);if((L>0||I>0)&&r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),I>0)for(S=0;S<I;S++)T=c[S],T.drawEdgesColorTransparent(i);if(L>0)for(S=0;S<L;S++)T=o[S],T.drawColorTransparent(i);r.disable(r.BLEND),l||r.depthMask(!0)}if(V>0||N>0){if(i.lastProgramId=null,r.clear(r.DEPTH_BUFFER_BIT),N>0)for(S=0;S<N;S++)m[S].drawEdgesHighlighted(i);if(V>0)for(S=0;S<V;S++)g[S].drawSilhouetteHighlighted(i)}if(Y>0||W>0||V>0){if(i.lastProgramId=null,r.clear(r.DEPTH_BUFFER_BIT),r.enable(r.CULL_FACE),r.enable(r.BLEND),n?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),W>0)for(S=0;S<W;S++)b[S].drawEdgesHighlighted(i);if(Y>0)for(S=0;S<Y;S++)v[S].drawSilhouetteHighlighted(i);r.disable(r.BLEND)}if(K>0||H>0){if(i.lastProgramId=null,r.clear(r.DEPTH_BUFFER_BIT),H>0)for(S=0;S<H;S++)w[S].drawEdgesSelected(i);if(K>0)for(S=0;S<K;S++)y[S].drawSilhouetteSelected(i)}if(z>0||X>0){if(i.lastProgramId=null,r.clear(r.DEPTH_BUFFER_BIT),r.enable(r.CULL_FACE),r.enable(r.BLEND),n?(r.blendEquation(r.FUNC_ADD),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),X>0)for(S=0;S<X;S++)E[S].drawEdgesSelected(i);if(z>0)for(S=0;S<z;S++)P[S].drawSilhouetteSelected(i);r.disable(r.BLEND)}const G=Date.now(),Z=a.a.frame;Z.renderTime=(G-x)/1e3,Z.drawElements=i.drawElements,Z.useProgram=i.useProgram,Z.bindTexture=i.bindTexture,Z.bindArray=i.bindArray;const q=h.a.MAX_TEXTURE_UNITS;for(let t=0;t<q;t++)r.activeTexture(r.TEXTURE0+t);r.bindTexture(r.TEXTURE_CUBE_MAP,null),r.bindTexture(r.TEXTURE_2D,null);const J=h.a.MAX_VERTEX_ATTRIBS;for(let t=0;t<J;t++)r.disableVertexAttribArray(t)}}();this.pick=function(){const e=o.a.vec3(),n=o.a.mat4(),a=o.a.mat4(),l=o.a.vec3([0,1,0]),u=new m,_=o.a.vec2();return function(p,f=u){let g,m,v,b,y;f.reset(),O(),h.a.SUPPORTED_EXTENSIONS.OES_element_index_uint&&r.getExtension("OES_element_index_uint"),t.logarithmicDepthBufferEnabled&&h.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.getExtension("EXT_frag_depth");let w=null,P=null;if(f.pickSurface=p.pickSurface,p.canvasPos)g=p.canvasPos[0],m=p.canvasPos[1],w=t.camera.viewMatrix,P=t.camera.projMatrix,f.canvasPos=p.canvasPos;else{const i=o.a.frustumMat4(-1,1,-1,1,t.camera.project.near,t.camera.project.far,n);p.matrix?(w=p.matrix,P=i):(v=p.origin||o.a.vec3([0,0,0]),b=p.direction||o.a.vec3([0,0,1]),y=o.a.addVec3(v,b,e),w=o.a.lookAtMat4v(v,y,l,a),P=i,f.origin=v,f.direction=b),g=.5*s.clientWidth,m=.5*s.clientHeight}R.bind();const E=function(t,e,s,o,n){let a,l;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=s,i.pickProjMatrix=o,i.pickInvisible=!!n.pickInvisible,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const h=n.includeEntityIds,u=n.excludeEntityIds;for(let r in d)if(d.hasOwnProperty(r)){const t=d[r].drawableList;for(a=0,l=t.length;a<l;a++){const e=t[a];!e.drawPickMesh||!0===e.culled||!0!==n.pickInvisible&&!1===e.visible||!1===e.pickable||(h&&!h[e.id]||u&&u[e.id]||e.drawPickMesh(i))}}const _=R.read(Math.round(t),Math.round(e));let p=_[0]+256*_[1]+256*_[2]*256+256*_[3]*256*256;if(p<0)return;return c.items[p]}(g,m,w,P,p);if(!E)return R.unbind(),null;const k=E.delegatePickedEntity?E.delegatePickedEntity():E;return k?(p.pickSurface&&(E.canPickTriangle&&E.canPickTriangle()?(!function(t,e,s,o,n,a){if(!t.drawPickTriangles)return;i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=o,i.pickProjMatrix=n,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t.drawPickTriangles(i);const l=R.read(e,s);let h=l[0]+256*l[1]+256*l[2]*256+256*l[3]*256*256;h*=3,a.primIndex=h}(E,g,m,w,P,f),E.pickTriangleSurface(w,P,f)):E.canPickWorldPos&&E.canPickWorldPos()&&(_[0]=t.camera.project.near,_[1]=t.camera.project.far,j(E,g,m,w,P,_,f),!1!==p.pickSurfaceNormal&&function(t,e,s,n,a,l,h){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=n,i.pickProjMatrix=a,i.pickZNear=l[0],i.pickZFar=l[1],r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t.drawPickNormals(i);const c=R.read(Math.round(e),Math.round(s)),d=[c[0]/256-.5,c[1]/256-.5,c[2]/256-.5];o.a.normalizeVec3(d),h.worldNormal=d}(E,g,m,w,P,_,f))),R.unbind(),f.entity=k,f):null}}();const j=function(){const t=o.a.vec4(),e=o.a.vec4(),n=o.a.vec4(),a=o.a.vec4(),l=o.a.vec4(),h=o.a.mat4(),c=o.a.mat4(),d=o.a.mat4();return function(_,p,f,g,m,v,b){i.reset(),i.backfaces=!0,i.frontface=!0,i.pickViewMatrix=g,i.pickProjMatrix=m,i.pickZNear=v[0],i.pickZFar=v[1],r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),_.drawPickDepths(i);const y=function(t){const e=[t[0]/256,t[1]/256,t[2]/256,t[3]/256],i=[1/16777216,1/65536,1/256,1];return o.a.dotVec4(e,i)}(R.read(Math.round(p),Math.round(f))),w=(p-s.width/2)/(s.width/2),P=-(f-s.height/2)/(s.height/2),E=_.rtcCenter;let k;if(E){const t=Object(u.a)(g,E,h);k=o.a.mulMat4(m,t,c)}else k=o.a.mulMat4(m,g,c);const M=o.a.inverseMat4(k,d);t[0]=w,t[1]=P,t[2]=-1,t[3]=1;let D=o.a.transformVec4(M,t);D=o.a.mulVec4Scalar(D,1/D[3]),e[0]=w,e[1]=P,e[2]=1,e[3]=1;let S=o.a.transformVec4(M,e);S=o.a.mulVec4Scalar(S,1/S[3]);const C=o.a.subVec3(S,D,n),T=o.a.addVec3(D,o.a.mulVec4Scalar(C,y,a),l);E&&o.a.addVec3(T,E),b.worldPos=T}}();this.addMarker=function(e){this._occlusionTester=this._occlusionTester||new E(t),this._occlusionTester.addMarker(e),t.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(t){this._occlusionTester.markerWorldPosUpdated(t)},this.removeMarker=function(t){this._occlusionTester.removeMarker(t)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){O(),this._occlusionTester.bindRenderBuf(),i.reset(),i.backfaces=!0,i.frontface=!0,r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clearColor(0,0,0,0),r.enable(r.DEPTH_TEST),r.disable(r.CULL_FACE),r.disable(r.BLEND),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);for(let t in d)if(d.hasOwnProperty(t)){const e=d[t].drawableList;for(let t=0,s=e.length;t<s;t++){const s=e[t];s.drawOcclusion&&!0!==s.culled&&!1!==s.visible&&!1!==s.pickable&&s.drawOcclusion(i)}}this._occlusionTester.drawMarkers(i),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(t,e,i,s){let r,o,n,a;for(S.bind(),S.clear(),this.render({force:!0,opaqueOnly:s}),o=0;o<i;o++)n=2*o,a=4*o,r=S.read(t[n],t[n+1]),e[a]=r[0],e[a+1]=r[1],e[a+2]=r[2],e[a+3]=r[3];S.unbind(),y=!0},this.beginSnapshot=function(){S.bind(),S.clear(),C=!0},this.renderSnapshot=function(){C&&(S.clear(),this.render({force:!0,opaqueOnly:!1}),y=!0)},this.readSnapshot=function(t){return S.readImage(t)},this.endSnapshot=function(){C&&(S.unbind(),C=!1)},this.destroy=function(){d={},p={},R.destroy(),S.destroy(),P.destroy(),k.destroy(),D.destroy(),x.destroy(),A.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class L extends n.a{constructor(t,e={}){super(t,e),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=o.a.vec2(),this._bindEvents()}_bindEvents(){if(!this._eventsBound){document.addEventListener("keydown",this._keyDownListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!0:t.keyCode===this.KEY_ALT?this.altDown=!0:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[t.keyCode]=!0,this.fire("keydown",t.keyCode,!0))},!1),document.addEventListener("keyup",this._keyUpListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!1:t.keyCode===this.KEY_ALT?this.altDown=!1:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[t.keyCode]=!1,this.fire("keyup",t.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=t=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(t),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=t=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(t),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0}this._getMouseCanvasPos(t),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1}this._getMouseCanvasPos(t),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1}this._getMouseCanvasPos(t),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=t=>{this.enabled&&(this._getMouseCanvasPos(t),this.fire("mousemove",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=(t,e)=>{if(!this.enabled)return;const i=Math.max(-1,Math.min(1,40*-t.deltaY));this.fire("mousewheel",i,!0)},{passive:!0});{let t,e;const i=2;this.on("mousedown",(i=>{t=i[0],e=i[1]})),this.on("mouseup",(s=>{t>=s[0]-i&&t<=s[0]+i&&e>=s[1]-i&&e<=s[1]+i&&this.fire("mouseclicked",s,!0)}))}{const t={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0};let e,i;const s=o.a.vec3(),r=o.a.vec3(),n={orientation:null,orientationAngle:0},a={orientationAngle:0,acceleration:null,accelerationIncludingGravity:r,rotationRate:o.a.vec3(),interval:0},l={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",this._orientationchangedListener=()=>{e=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,i=e&&t[e]||0,n.orientation=e,n.orientationAngle=i,this.fire("orientationchange",n)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",this._deviceMotionListener=t=>{a.interval=t.interval,a.orientationAngle=i;const e=t.acceleration;e?(s[0]=e.x,s[1]=e.y,s[2]=e.z,a.acceleration=s):a.acceleration=null;const o=t.accelerationIncludingGravity;o?(r[0]=o.x,r[1]=o.y,r[2]=o.z,a.accelerationIncludingGravity=r):a.accelerationIncludingGravity=null,a.rotationRate=t.rotationRate,this.fire("devicemotion",a)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener=t=>{l.gamma=t.gamma,l.beta=t.beta,l.alpha=t.alpha,l.absolute=t.absolute,this.fire("deviceorientation",l)},!1)}this._eventsBound=!0}}_unbindEvents(){this._eventsBound&&(document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(t){if(t){let e=t.target,i=0,s=0;for(;e.offsetParent;)i+=e.offsetLeft,s+=e.offsetTop,e=e.offsetParent;this.mouseCanvasPos[0]=t.pageX-i,this.mouseCanvasPos[1]=t.pageY-s}else t=window.event,this.mouseCanvasPos[0]=t.x,this.mouseCanvasPos[1]=t.y}setEnabled(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)}getEnabled(){return this.enabled}setKeyboardEnabled(t){this.keyboardEnabled=t}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}var I=i("tRux");class j extends n.a{get type(){return"Viewport"}constructor(t,e={}){super(t,e),this._state=new I.a({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary}set boundary(t){if(!this._autoBoundary){if(!t){const e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(t){const e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class F extends n.a{get type(){return"Perspective"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new I.a({matrix:o.a.mat4(),inverseMatrix:o.a.mat4(),transposedMatrix:o.a.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far}_update(){const t=this.scene.viewport.boundary,e=t[2]/t[3],i=this._fovAxis;let s=this._fov;("x"===i||"min"===i&&e<1||"max"===i&&e>1)&&(s/=e),s=Math.min(s,120),o.a.perspectiveMat4(s*(Math.PI/180),e,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(t){(t=void 0!==t&&null!==t?t:60)!==this._fov&&(this._fov=t,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(t){t=t||"min",this._fovAxis!==t&&("x"!==t&&"y"!==t&&"min"!==t&&(this.error("Unsupported value for 'fovAxis': "+t+" - defaulting to 'min'"),t="min"),this._fovAxis=t,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(t){const e=void 0!==t&&null!==t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=void 0!==t&&null!==t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(o.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(o.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,l=n.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-l)/l,i[2]=e,i[3]=1,o.a.mulMat4v4(this.inverseMatrix,i,s),o.a.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,o.a.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class B extends n.a{get type(){return"Ortho"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new I.a({matrix:o.a.mat4(),inverseMatrix:o.a.mat4(),transposedMatrix:o.a.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const t=this.scene,e=.5*this._scale,i=t.viewport.boundary,s=i[2],r=i[3],n=s/r;let a,l,h,c;s>r?(a=-e,l=e,h=e/n,c=-e/n):(a=-e*n,l=e*n,h=e,c=-e),o.a.orthoMat4c(a,l,c,h,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(t){void 0!==t&&null!==t||(t=1),t<=0&&(t=.01),this._scale=t,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(t){const e=void 0!==t&&null!==t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=void 0!==t&&null!==t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(o.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(o.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,l=n.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-l)/l,i[2]=e,i[3]=1,o.a.mulMat4v4(this.inverseMatrix,i,s),o.a.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,o.a.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class U extends n.a{get type(){return"Frustum"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new I.a({matrix:o.a.mat4(),inverseMatrix:o.a.mat4(),transposedMatrix:o.a.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far}_update(){o.a.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(t){this._left=void 0!==t&&null!==t?t:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(t){this._right=void 0!==t&&null!==t?t:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(t){this._top=void 0!==t&&null!==t?t:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(t){this._bottom=void 0!==t&&null!==t?t:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(t){this._state.near=void 0!==t&&null!==t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=void 0!==t&&null!==t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(o.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(o.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,l=n.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-l)/l,i[2]=e,i[3]=1,o.a.mulMat4v4(this.inverseMatrix,i,s),o.a.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,o.a.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class V extends n.a{get type(){return"CustomProjection"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new I.a({matrix:o.a.mat4(),inverseMatrix:o.a.mat4(),transposedMatrix:o.a.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=e.matrix}set matrix(t){this._state.matrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(o.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(o.a.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const n=this.scene.canvas.canvas,a=n.offsetWidth/2,l=n.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-l)/l,i[2]=e,i[3]=1,o.a.mulMat4v4(this.inverseMatrix,i,s),o.a.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,o.a.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy()}}const N=o.a.vec3(),Y=o.a.vec3(),W=o.a.vec3(),K=o.a.vec3(),H=o.a.vec3(),z=o.a.vec3(),X=o.a.mat4(),G=o.a.mat4(),Z=o.a.vec3(),q=o.a.vec3(),J=o.a.vec3(),Q=o.a.vec3();class $ extends n.a{get type(){return"Camera"}constructor(t,e={}){super(t,e),this._state=new I.a({deviceMatrix:o.a.mat4(),hasDeviceMatrix:!1,matrix:o.a.mat4(),normalMatrix:o.a.mat4(),inverseMatrix:o.a.mat4()}),this._perspective=new F(this),this._ortho=new B(this),this._frustum=new U(this),this._customProjection=new V(this),this._project=this._perspective,this._eye=o.a.vec3([0,0,10]),this._look=o.a.vec3([0,0,0]),this._up=o.a.vec3([0,1,0]),this._worldUp=o.a.vec3([0,1,0]),this._worldRight=o.a.vec3([1,0,0]),this._worldForward=o.a.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)}))}_update(){const t=this._state;let e;"ortho"===this.projection?(o.a.subVec3(this._eye,this._look,Z),o.a.normalizeVec3(Z,q),o.a.mulVec3Scalar(q,1e3,J),o.a.addVec3(this._look,J,Q),e=Q):e=this._eye,t.hasDeviceMatrix?(o.a.lookAtMat4v(e,this._look,this._up,G),o.a.mulMat4(t.deviceMatrix,G,t.matrix)):o.a.lookAtMat4v(e,this._look,this._up,t.matrix),o.a.inverseMat4(this._state.matrix,this._state.inverseMatrix),o.a.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(t){let e=o.a.subVec3(this._eye,this._look,N);o.a.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,X),e=o.a.transformPoint3(X,e,Y),this.eye=o.a.addVec3(this._look,e,W),this.up=o.a.transformPoint3(X,this._up,K)}orbitPitch(t){if(this._constrainPitch&&(t=o.a.dotVec3(this._up,this._worldUp)/o.a.DEGTORAD)<1)return;let e=o.a.subVec3(this._eye,this._look,N);const i=o.a.cross3Vec3(o.a.normalizeVec3(e,Y),o.a.normalizeVec3(this._up,W));o.a.rotationMat4v(.0174532925*t,i,X),e=o.a.transformPoint3(X,e,K),this.up=o.a.transformPoint3(X,this._up,H),this.eye=o.a.addVec3(e,this._look,z)}yaw(t){let e=o.a.subVec3(this._look,this._eye,N);o.a.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,X),e=o.a.transformPoint3(X,e,Y),this.look=o.a.addVec3(e,this._eye,W),this._gimbalLock&&(this.up=o.a.transformPoint3(X,this._up,K))}pitch(t){if(this._constrainPitch&&(t=o.a.dotVec3(this._up,this._worldUp)/o.a.DEGTORAD)<1)return;let e=o.a.subVec3(this._look,this._eye,N);const i=o.a.cross3Vec3(o.a.normalizeVec3(e,Y),o.a.normalizeVec3(this._up,W));o.a.rotationMat4v(.0174532925*t,i,X),this.up=o.a.transformPoint3(X,this._up,z),e=o.a.transformPoint3(X,e,K),this.look=o.a.addVec3(e,this._eye,H)}pan(t){const e=o.a.subVec3(this._eye,this._look,N),i=[0,0,0];let s;if(0!==t[0]){const r=o.a.cross3Vec3(o.a.normalizeVec3(e,[]),o.a.normalizeVec3(this._up,Y));s=o.a.mulVec3Scalar(r,t[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==t[1]&&(s=o.a.mulVec3Scalar(o.a.normalizeVec3(this._up,W),t[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==t[2]&&(s=o.a.mulVec3Scalar(o.a.normalizeVec3(e,K),t[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=o.a.addVec3(this._eye,i,H),this.look=o.a.addVec3(this._look,i,z)}zoom(t){const e=o.a.subVec3(this._eye,this._look,N),i=Math.abs(o.a.lenVec3(e,Y)),s=Math.abs(i+t);if(s<.5)return;const r=o.a.normalizeVec3(e,W);this.eye=o.a.addVec3(this._look,o.a.mulVec3Scalar(r,s),K)}set eye(t){this._eye.set(t||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(t){this._look.set(t||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(t){this._up.set(t||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(t){this._state.deviceMatrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!t,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(t){t=t||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(t):this._worldAxis=o.a.vec3(t),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(t){this._gimbalLock=!1!==t,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(t){this._constrainPitch=!!t,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return o.a.lenVec3(o.a.subVec3(this._look,this._eye,N))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(t){t=t||"perspective",this._projectionType!==t&&("perspective"===t?this._project=this._perspective:"ortho"===t?this._project=this._ortho:"frustum"===t?this._project=this._frustum:"customProjection"===t?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+t+" defaulting to 'perspective'"),this._project=this._perspective,t="perspective"),this._project._update(),this._projectionType=t,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}class tt extends n.a{get type(){return"Light"}get isLight(){return!0}constructor(t,e={}){super(t,e)}}class et extends tt{get type(){return"DirLight"}constructor(t,e={}){super(t,e),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=i.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=s.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new I.a({type:"dir",dir:o.a.vec3([1,1,1]),color:o.a.vec3([.7,.7,.8]),intensity:1,space:e.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=o.a.identityMat4());const t=this.scene.camera,e=this._state.dir,i=t.look,s=[i[0]-e[0],i[1]-e[1],i[2]-e[2]],r=[0,1,0];o.a.lookAtMat4v(s,i,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=o.a.identityMat4()),o.a.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new f(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.castsShadow=e.castsShadow,this.scene._lightCreated(this)}set dir(t){this._state.dir.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const t=this.scene.camera,e=this.scene.canvas;t.off(this._onCameraViewMatrix),t.off(this._onCameraProjMatrix),e.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class it extends tt{get type(){return"AmbientLight"}constructor(t,e={}){super(t,e),this._state={type:"ambient",color:o.a.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){this._state.intensity=void 0!==t?t:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}var st=i("bY37");var rt=i("MXr8"),ot=i("3yWq");const nt={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class at extends ot.a{get type(){return"EmphasisMaterial"}get presets(){return nt}constructor(t,e={}){super(t,e),this._state=new I.a({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,void 0!==e.fill&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),void 0!==e.fillAlpha&&(this.fillAlpha=e.fillAlpha),void 0!==e.edges&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth),void 0!==e.backfaces&&(this.backfaces=e.backfaces)):(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.backfaces=e.backfaces)}set fill(t){t=!1!==t,this._state.fill!==t&&(this._state.fill=t,this.glRedraw())}get fill(){return this._state.fill}set fillColor(t){let e=this._state.fillColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.fillColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.4,e[1]=.4,e[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(t){t=void 0!==t&&null!==t?t:.2,this._state.fillAlpha!==t&&(this._state.fillAlpha=t,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=void 0!==t&&null!==t?t:.5,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set preset(t){if(t=t||"default",this._preset===t)return;const e=nt[t];e?(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(nt).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const lt={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class ht extends ot.a{get type(){return"EdgeMaterial"}get presets(){return lt}constructor(t,e={}){super(t,e),this._state=new I.a({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth),this.edges=!1!==e.edges}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=void 0!==t&&null!==t?t:1,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=lt[t];e?(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(lt).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const ct={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class dt extends n.a{constructor(t,e={}){super(t,e),this._units="meters",this._scale=1,this._origin=o.a.vec3([0,0,0]),this.units=e.units,this.scale=e.scale,this.origin=e.origin}get unitsInfo(){return ct}set units(t){t||(t="meters");ct[t]||(this.error("Unsupported value for 'units': "+t+" defaulting to 'meters'"),t="meters"),this._units=t,this.fire("units",this._units)}get units(){return this._units}set scale(t){(t=t||1)<=0?this.error("scale value should be larger than zero"):(this._scale=t,this.fire("scale",this._scale))}get scale(){return this._scale}set origin(t){if(!t)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(t,e=o.a.vec3(3)){e[0]=this._origin[0]+this._scale*t[0],e[1]=this._origin[1]+this._scale*t[1],e[2]=this._origin[2]+this._scale*t[2]}realToWorldPos(t,e=o.a.vec3(3)){return e[0]=(t[0]-this._origin[0])/this._scale,e[1]=(t[1]-this._origin[1])/this._scale,e[2]=(t[2]-this._origin[2])/this._scale,e}}class ut extends n.a{constructor(t,e={}){super(t,e),this._supported=h.a.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=e.enabled,this.kernelRadius=e.kernelRadius,this.intensity=e.intensity,this.bias=e.bias,this.scale=e.scale,this.minResolution=e.minResolution,this.numSamples=e.numSamples,this.blur=e.blur,this.blendCutoff=e.blendCutoff,this.blendFactor=e.blendFactor}get supported(){return this._supported}set enabled(t){t=!!t,this._enabled!==t&&(this._enabled=t,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported)return!1;if(!this._enabled)return!1;const t=this.scene.camera.projection;return"customProjection"!==t&&"frustum"!==t}get active(){return this._active}set kernelRadius(t){void 0!==t&&null!==t||(t=100),this._kernelRadius!==t&&(this._kernelRadius=t,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(t){void 0!==t&&null!==t||(t=.15),this._intensity!==t&&(this._intensity=t,this.glRedraw())}get intensity(){return this._intensity}set bias(t){void 0!==t&&null!==t||(t=.5),this._bias!==t&&(this._bias=t,this.glRedraw())}get bias(){return this._bias}set scale(t){void 0!==t&&null!==t||(t=1),this._scale!==t&&(this._scale=t,this.glRedraw())}get scale(){return this._scale}set minResolution(t){void 0!==t&&null!==t||(t=0),this._minResolution!==t&&(this._minResolution=t,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(t){void 0!==t&&null!==t||(t=10),this._numSamples!==t&&(this._numSamples=t,this.glRedraw())}get numSamples(){return this._numSamples}set blur(t){t=!1!==t,this._blur!==t&&(this._blur=t,this.glRedraw())}get blur(){return this._blur}set blendCutoff(t){void 0!==t&&null!==t||(t=.3),this._blendCutoff!==t&&(this._blendCutoff=t,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(t){void 0!==t&&null!==t||(t=1),this._blendFactor!==t&&(this._blendFactor=t,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}const _t={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class pt extends ot.a{get type(){return"PointsMaterial"}get presets(){return _t}constructor(t,e={}){super(t,e),this._state=new I.a({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null}),e.preset?(this.preset=e.preset,void 0!==e.pointSize&&(this.pointSize=e.pointSize),void 0!==e.roundPoints&&(this.roundPoints=e.roundPoints),void 0!==e.perspectivePoints&&(this.perspectivePoints=e.perspectivePoints),void 0!==e.minPerspectivePointSize&&(this.minPerspectivePointSize=e.minPerspectivePointSize),void 0!==e.maxPerspectivePointSize&&(this.maxPerspectivePointSize=e.minPerspectivePointSize)):(this._preset="default",this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize)}set pointSize(t){this._state.pointSize=t||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(t){t=!1!==t,this._state.roundPoints!==t&&(this._state.roundPoints=t,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(t){t=!1!==t,this._state.perspectivePoints!==t&&(this._state.perspectivePoints=t,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(t){this._state.minPerspectivePointSize=t||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(t){this._state.maxPerspectivePointSize=t||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set preset(t){if(t=t||"default",this._preset===t)return;const e=_t[t];e?(this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(_t).join(", "))}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize].join(";")}destroy(){super.destroy(),this._state.destroy()}}const ft={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class gt extends ot.a{get type(){return"LinesMaterial"}get presets(){return ft}constructor(t,e={}){super(t,e),this._state=new I.a({type:"LinesMaterial",lineWidth:null}),e.preset?(this.preset=e.preset,void 0!==e.lineWidth&&(this.lineWidth=e.lineWidth)):(this._preset="default",this.lineWidth=e.lineWidth)}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=ft[t];e?(this.lineWidth=e.lineWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(ft).join(", "))}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function mt(t,e){const i={};let s,r;for(let o=0,n=e.length;o<n;o++)s=e[o],r=t.component[s],r?r.isEntity?i[s]=!0:t.warn("pick(): Component is not an Entity: "+s):t.warn("pick(): Component not found: "+s);return i}class vt extends n.a{get type(){return"Scene"}constructor(t,e={}){super(null,e);const i=e.canvasElement||document.getElementById(e.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";const r=!!e.transparent,n=!!e.alphaDepthMask;this._aabbDirty=!0,this.viewer=t,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.realWorldOffset=e.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new d(this,{dontClear:!0,canvas:i,spinnerElementId:e.spinnerElementId,transparent:r,backgroundColor:e.backgroundColor,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},clearColorAmbient:e.clearColorAmbient,premultipliedAlpha:e.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw()})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!")})),this._renderer=new O(this,{transparent:r,alphaDepthMask:n}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;let t=null;this.getHash=function(){if(t)return t;const e=this.sectionPlanes;if(0===e.length)return this.hash=";";let i;const s=[];for(let t=0,r=e.length;t<r;t++)i=e[t],s.push("cp");return s.push(";"),t=s.join(""),t},this.addSectionPlane=function(e){this.sectionPlanes.push(e),t=null},this.removeSectionPlane=function(e){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===e.id)return this.sectionPlanes.splice(i,1),void(t=null)}},this._lightsState=new function(){const t=o.a.vec3([0,0,0]),e=o.a.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const t=[],e=this.lights;let s;for(let i=0,r=e.length;i<r;i++)s=e[i],t.push("/"),t.push(s.type),t.push("world"===s.space?"w":"v"),s.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join(""),i},this.addLight=function(t){this.lights.push(t),s=null,i=null},this.removeLight=function(t){for(let e=0,r=this.lights.length;e<r;e++){if(this.lights[e].id===t.id)return this.lights.splice(e,1),s&&s.id===t.id&&(s=null),void(i=null)}},this.addReflectionMap=function(t){this.reflectionMaps.push(t),i=null},this.removeReflectionMap=function(t){for(let e=0,s=this.reflectionMaps.length;e<s;e++)if(this.reflectionMaps[e].id===t.id)return this.reflectionMaps.splice(e,1),void(i=null)},this.addLightMap=function(t){this.lightMaps.push(t),i=null},this.removeLightMap=function(t){for(let e=0,s=this.lightMaps.length;e<s;e++)if(this.lightMaps[e].id===t.id)return this.lightMaps.splice(e,1),void(i=null)},this.getAmbientColor=function(){if(!s)for(let t=0,e=this.lights.length;t<e;t++){const e=this.lights[t];if("ambient"===e.type){s=e;break}}if(s){const t=s.color,i=s.intensity;return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}return t}},this.input=new L(this,{dontClear:!0,element:this.canvas.canvas}),this.metrics=new dt(this,{units:e.units,scale:e.scale,origin:e.origin}),this.sao=new ut(this,{enabled:e.saoEnabled}),this.ticksPerRender=e.ticksPerRender,this.ticksPerOcclusionTest=e.ticksPerOcclusionTest,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor,this._entityOffsetsEnabled=!!e.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!e.logarithmicDepthBufferEnabled,this._pbrEnabled=!!e.pbrEnabled,s.a._addScene(this),this._initDefaults(),this._viewport=new j(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new $(this,{id:"default.camera",dontClear:!0}),new it(this,{color:[.9,.9,.9],intensity:.9}),new et(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new et(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty()}))}_initDefaults(){let t;t=this.geometry,t=this.material,t=this.xrayMaterial,t=this.edgeMaterial,t=this.selectedMaterial,t=this.highlightMaterial}_addComponent(t){if(t.id&&this.components[t.id]&&(this.error("Component "+r.a.inQuotes(t.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),t.id=null),!t.id)for(void 0===window.nextID&&(window.nextID=0),t.id="__"+window.nextID++;this.components[t.id];)t.id=o.a.createUUID();this.components[t.id]=t;const e=t.type;let i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.compile&&(this._compilables[t.id]=t),t.isDrawable&&(this._renderer.addDrawable(t.id,t),this._collidables[t.id]=t)}_removeComponent(t){var e=t.id,i=t.type;delete this.components[e];const s=this.types[i];s&&(delete s[e],r.a.isEmptyObject(s)&&delete this.types[i]),t.compile&&delete this._compilables[t.id],t.isDrawable&&(this._renderer.removeDrawable(t.id),delete this._collidables[t.id])}_sectionPlaneCreated(t){this.sectionPlanes[t.id]=t,this.scene._sectionPlanesState.addSectionPlane(t._state),this.scene.fire("sectionPlaneCreated",t,!0),this._needRecompile=!0}_lightCreated(t){this.lights[t.id]=t,this.scene._lightsState.addLight(t._state),this._needRecompile=!0}_lightMapCreated(t){this.lightMaps[t.id]=t,this.scene._lightsState.addLightMap(t._state),this._needRecompile=!0}_reflectionMapCreated(t){this.reflectionMaps[t.id]=t,this.scene._lightsState.addReflectionMap(t._state),this._needRecompile=!0}_sectionPlaneDestroyed(t){delete this.sectionPlanes[t.id],this.scene._sectionPlanesState.removeSectionPlane(t._state),this.scene.fire("sectionPlaneDestroyed",t,!0),this._needRecompile=!0}_lightDestroyed(t){delete this.lights[t.id],this.scene._lightsState.removeLight(t._state),this._needRecompile=!0}_lightMapDestroyed(t){delete this.lightMaps[t.id],this.scene._lightsState.removeLightMap(t._state),this._needRecompile=!0}_reflectionMapDestroyed(t){delete this.reflectionMaps[t.id],this.scene._lightsState.removeReflectionMap(t._state),this._needRecompile=!0}_registerModel(t){this.models[t.id]=t,this._modelIds=null}_deregisterModel(t){delete this.models[t.id],this._modelIds=null}_registerObject(t){this.objects[t.id]=t,this._numObjects++,this._objectIds=null}_deregisterObject(t){delete this.objects[t.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(t,e=!0){t.visible?(this.visibleObjects[t.id]=t,this._numVisibleObjects++):(delete this.visibleObjects[t.id],this._numVisibleObjects--),this._visibleObjectIds=null,e&&this.fire("objectVisibility",t,!0)}_objectXRayedUpdated(t){t.xrayed?(this.xrayedObjects[t.id]=t,this._numXRayedObjects++):(delete this.xrayedObjects[t.id],this._numXRayedObjects--),this._xrayedObjectIds=null}_objectHighlightedUpdated(t){t.highlighted?(this.highlightedObjects[t.id]=t,this._numHighlightedObjects++):(delete this.highlightedObjects[t.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_objectSelectedUpdated(t){t.selected?(this.selectedObjects[t.id]=t,this._numSelectedObjects++):(delete this.selectedObjects[t.id],this._numSelectedObjects--),this._selectedObjectIds=null}_objectColorizeUpdated(t,e){e?(this.colorizedObjects[t.id]=t,this._numColorizedObjects++):(delete this.colorizedObjects[t.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_objectOpacityUpdated(t,e){e?(this.opacityObjects[t.id]=t,this._numOpacityObjects++):(delete this.opacityObjects[t.id],this._numOpacityObjects--),this._opacityObjectIds=null}_objectOffsetUpdated(t,e){!e||0===e[0]&&0===e[1]&&0===e[2]?(this.offsetObjects[t.id]=t,this._numOffsetObjects++):(delete this.offsetObjects[t.id],this._numOffsetObjects--),this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const t in this.components)if(this.components.hasOwnProperty(t)){const e=this.components[t];e._webglContextLost&&e._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const t=this.canvas.gl;for(const e in this.components)if(this.components.hasOwnProperty(e)){const i=this.components[e];i._webglContextRestored&&i._webglContextRestored(t)}this._renderer.webglContextRestored(t),this.canvas.spinner.processes--}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set pbrEnabled(t){this._pbrEnabled=!!t,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(t){t&&s.a.runTasks();const e={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.sceneId=this.id;const i=this._passes,r=this._clearEachPass;let o,n;for(o=0;o<i;o++)e.pass=o,this.fire("rendering",e,!0),n=r||0===o,this._renderer.render({pass:o,clear:n,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()}_recompile(){for(const t in this._compilables)this._compilables.hasOwnProperty(t)&&this._compilables[t].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const t=this.canvas;if(t.transparent||t.backgroundImage||t.backgroundColor)this._lastAmbientColor=null;else{const e=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===e[0]&&this._lastAmbientColor[1]===e[1]&&this._lastAmbientColor[2]===e[2]&&this._lastAmbientColor[3]===e[3]||(t.backgroundColor=e,this._lastAmbientColor||(this._lastAmbientColor=o.a.vec4([0,0,0,1])),this._lastAmbientColor.set(e))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(t){void 0===t||null===t?t=1:(!r.a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(t){void 0===t||null===t?t=20:(!r.a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+t+"' - should be an integer greater than zero."),t=20),t!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=t)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(t){void 0===t||null===t?t=1:(!r.a.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this.glRedraw())}get passes(){return this._passes}set clearEachPass(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(t){(t=!1!==t)!==this._renderer.gammaInput&&(this._renderer.gammaInput=t,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(t){(t=!!t)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=t,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(t){(t=void 0===t||null===t?2.2:t)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=t,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||function(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=t.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const o=t.center,n=o?o[0]:0,a=o?o[1]:0,l=o?o[2]:0,h=-e+n,c=-i+a,d=-s+l,u=e+n,_=i+a,p=s+l;return r.a.apply(t,{positions:[u,_,p,h,_,p,h,c,p,u,c,p,u,_,p,u,c,p,u,c,d,u,_,d,u,_,p,u,_,d,h,_,d,h,_,p,h,_,p,h,_,d,h,c,d,h,c,p,h,c,d,u,c,d,u,c,p,h,c,p,u,c,d,h,c,d,h,_,d,u,_,d],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}(st.a)}get material(){return this.components["default.material"]||new rt.a(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new at(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new at(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new at(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new ht(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new pt(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new gt(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=o.a.vec3());const t=this.aabb;this._center[0]=(t[0]+t[3])/2,this._center[1]=(t[1]+t[4])/2,this._center[2]=(t[2]+t[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=o.a.AABB3());let t,e=o.a.MAX_DOUBLE,i=o.a.MAX_DOUBLE,s=o.a.MAX_DOUBLE,r=o.a.MIN_DOUBLE,n=o.a.MIN_DOUBLE,a=o.a.MIN_DOUBLE;const l=this._collidables;let h,c=!1;for(const o in l)if(l.hasOwnProperty(o)){if(h=l[o],!1===h.collidable)continue;t=h.aabb,t[0]<e&&(e=t[0]),t[1]<i&&(i=t[1]),t[2]<s&&(s=t[2]),t[3]>r&&(r=t[3]),t[4]>n&&(n=t[4]),t[5]>a&&(a=t[5]),c=!0}c||(e=-100,i=-100,s=-100,r=100,n=100,a=100),this._aabb[0]=e,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=n,this._aabb[5]=a,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(t,e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(t=t||{}).pickSurface=t.pickSurface||t.rayPick,t.canvasPos||t.matrix||t.origin&&t.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=t.includeEntities||t.include;i&&(t.includeEntityIds=mt(this,i));const s=t.excludeEntities||t.exclude;return s&&(t.excludeEntityIds=mt(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(e=this._renderer.pick(t,e))?(e.entity&&e.entity.fire&&e.entity.fire("picked",e),e):void 0}clear(){var t;for(const e in this.components)this.components.hasOwnProperty(e)&&((t=this.components[e])._dontClear||t.destroy())}clearLights(){const t=Object.keys(this.lights);for(let e=0,i=t.length;e<i;e++)this.lights[t[e]].destroy()}clearSectionPlanes(){const t=Object.keys(this.sectionPlanes);for(let e=0,i=t.length;e<i;e++)this.sectionPlanes[t[e]].destroy()}getAABB(t){if(void 0===t)return this.aabb;if(r.a.isString(t)){const e=this.objects[t];if(e&&e.aabb)return e.aabb;t=[t]}if(0===t.length)return this.aabb;let e,i=o.a.MAX_DOUBLE,s=o.a.MAX_DOUBLE,n=o.a.MAX_DOUBLE,a=o.a.MIN_DOUBLE,l=o.a.MIN_DOUBLE,h=o.a.MIN_DOUBLE;if(this.withObjects(t,(t=>{if(t.collidable){const r=t.aabb;r[0]<i&&(i=r[0]),r[1]<s&&(s=r[1]),r[2]<n&&(n=r[2]),r[3]>a&&(a=r[3]),r[4]>l&&(l=r[4]),r[5]>h&&(h=r[5]),e=!0}})),e){const t=o.a.AABB3();return t[0]=i,t[1]=s,t[2]=n,t[3]=a,t[4]=l,t[5]=h,t}return this.aabb}setObjectsVisible(t,e){return this.withObjects(t,(t=>{const i=t.visible!==e;return t.visible=e,i}))}setObjectsCollidable(t,e){return this.withObjects(t,(t=>{const i=t.collidable!==e;return t.collidable=e,i}))}setObjectsCulled(t,e){return this.withObjects(t,this.objects,(t=>{const i=t.culled!==e;return t.culled=e,i}))}setObjectsSelected(t,e){return this.withObjects(t,(t=>{const i=t.selected!==e;return t.selected=e,i}))}setObjectsHighlighted(t,e){return this.withObjects(t,(t=>{const i=t.highlighted!==e;return t.highlighted=e,i}))}setObjectsXRayed(t,e){return this.withObjects(t,(t=>{const i=t.xrayed!==e;return t.xrayed=e,i}))}setObjectsEdges(t,e){return this.withObjects(t,(t=>{const i=t.edges!==e;return t.edges=e,i}))}setObjectsColorized(t,e){return this.withObjects(t,(t=>{t.colorize=e}))}setObjectsOpacity(t,e){return this.withObjects(t,(t=>{const i=t.opacity!==e;return t.opacity=e,i}))}setObjectsPickable(t,e){return this.withObjects(t,(t=>{const i=t.pickable!==e;return t.pickable=e,i}))}setObjectsOffset(t,e){this.withObjects(t,(t=>{t.offset=e}))}withObjects(t,e){r.a.isString(t)&&(t=[t]);let i=!1;for(let s=0,r=t.length;s<r;s++){const r=t[s];let n=this.objects[r];if(n)i=e(n)||i;else{const t=this.modelIds;for(let s=0,a=t.length;s<a;s++){const a=t[s],l=o.a.globalizeObjectId(a,r);n=this.objects[l],n&&(i=e(n)||i)}}}return i}destroy(){super.destroy();for(const t in this.components)this.components.hasOwnProperty(t)&&this.components[t].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const bt=o.a.vec3(),yt=o.a.vec3(),wt=o.a.vec3(),Pt=o.a.vec3(),Et=o.a.vec3();class kt extends n.a{get type(){return"CameraFlightAnimation"}constructor(t,e={}){super(t,e),this._look1=o.a.vec3(),this._eye1=o.a.vec3(),this._up1=o.a.vec3(),this._look2=o.a.vec3(),this._eye2=o.a.vec3(),this._up2=o.a.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail}flyTo(t,e,i){t=t||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=e,this._callbackScope=i;const n=this.scene.camera,a=!!t.projection&&t.projection!==n.projection;let l,h,c,d,u;if(this._eye1[0]=n.eye[0],this._eye1[1]=n.eye[1],this._eye1[2]=n.eye[2],this._look1[0]=n.look[0],this._look1[1]=n.look[1],this._look1[2]=n.look[2],this._up1[0]=n.up[0],this._up1[1]=n.up[1],this._up1[2]=n.up[2],this._orthoScale1=n.ortho.scale,this._orthoScale2=t.orthoScale||this._orthoScale1,t.aabb)l=t.aabb;else if(6===t.length)l=t;else if(t.eye&&t.look||t.up)h=t.eye,c=t.look,d=t.up;else if(t.eye)h=t.eye;else if(t.look)c=t.look;else{let s=t;if((r.a.isNumeric(s)||r.a.isString(s))&&(u=s,s=this.scene.components[u],!s))return this.error("Component not found: "+r.a.inQuotes(u)),void(e&&(i?e.call(i):e()));a||(l=s.aabb||this.scene.aabb)}const _=t.poi;if(l){if(l[3]<l[0]||l[4]<l[1]||l[5]<l[2])return;if(l[3]===l[0]&&l[4]===l[1]&&l[5]===l[2])return;l=l.slice();const e=o.a.getAABB3Center(l);this._look2=_||e;const i=o.a.subVec3(this._eye1,this._look1,bt),s=o.a.normalizeVec3(i),r=_?o.a.getAABB3DiagPoint(l,_):o.a.getAABB3Diag(l),n=t.fitFOV||this._fitFOV,a=Math.abs(r/Math.tan(n*o.a.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*a,this._eye2[1]=this._look2[1]+s[1]*a,this._eye2[2]=this._look2[2]+s[2]*a,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(h||c||d)&&(this._flyingEyeLookUp=!!h&&!!c&&!!d,this._flyingEye=!!h&&!c,this._flyingLook=!!c&&!h,h&&(this._eye2[0]=h[0],this._eye2[1]=h[1],this._eye2[2]=h[2]),c&&(this._look2[0]=c[0],this._look2[1]=c[1],this._look2[2]=c[2]),d&&(this._up2[0]=d[0],this._up2[1]=d[1],this._up2[2]=d[2]));a?("ortho"===t.projection&&"ortho"!==n.projection&&(this._projection2="ortho",this._projMatrix1=n.projMatrix.slice(),n.ortho.scale=this._orthoScale2,this._projMatrix2=n.ortho.matrix.slice(),n.projection="customProjection"),"perspective"===t.projection&&"perspective"!==n.projection&&(this._projection2="perspective",this._projMatrix1=n.projMatrix.slice(),this._projMatrix2=n.perspective.matrix.slice(),n.projection="customProjection")):this._projection2=null,this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,s.a.scheduleTask(this._update,this)}jumpTo(t){this._jumpTo(t)}_jumpTo(t){this._flying&&this.stop();const e=this.scene.camera;var i,s,n,a,l;if(t.aabb)i=t.aabb;else if(6===t.length)i=t;else if(t.eye||t.look||t.up)n=t.eye,a=t.look,l=t.up;else{let e=t;if((r.a.isNumeric(e)||r.a.isString(e))&&(s=e,e=this.scene.components[s],!e))return void this.error("Component not found: "+r.a.inQuotes(s));i=e.aabb||this.scene.aabb}const h=t.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var c=h?o.a.getAABB3DiagPoint(i,h):o.a.getAABB3Diag(i);let s;a=h||o.a.getAABB3Center(i,a),this._trail?o.a.subVec3(e.look,a,Et):o.a.subVec3(e.eye,e.look,Et),o.a.normalizeVec3(Et);s=(void 0!==t.fit?t.fit:this._fit)?Math.abs(c/Math.tan((t.fitFOV||this._fitFOV)*o.a.DEGTORAD)):o.a.lenVec3(o.a.subVec3(e.eye,e.look,bt)),o.a.mulVec3Scalar(Et,s),e.eye=o.a.addVec3(a,Et,bt),e.look=a,this.scene.camera.ortho.scale=1.1*c}else(n||a||l)&&(n&&(e.eye=n),a&&(e.look=a),l&&(e.up=l));t.projection&&(e.projection=t.projection)}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const e=t>=1;t>1&&(t=1);const i=this.easing?kt._ease(t,0,1,1):t,r=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(o.a.subVec3(r.eye,r.look,Et),r.eye=o.a.lerpVec3(i,0,1,this._eye1,this._eye2,wt),r.look=o.a.subVec3(wt,Et,yt)):this._flyingLook&&(r.look=o.a.lerpVec3(i,0,1,this._look1,this._look2,yt),r.up=o.a.lerpVec3(i,0,1,this._up1,this._up2,Pt)):this._flyingEyeLookUp&&(r.eye=o.a.lerpVec3(i,0,1,this._eye1,this._eye2,wt),r.look=o.a.lerpVec3(i,0,1,this._look1,this._look2,yt),r.up=o.a.lerpVec3(i,0,1,this._up1,this._up2,Pt)),this._projection2){const e="ortho"===this._projection2?kt._easeOutExpo(t,0,1,1):kt._easeInCubic(t,0,1,1);r.customProjection.matrix=o.a.lerpMat4(e,0,1,this._projMatrix1,this._projMatrix2)}else r.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);e?this.stop():s.a.scheduleTask(this._update,this)}static _ease(t,e,i,s){return-i*(t/=s)*(t-2)+e}static _easeInCubic(t,e,i,s){return i*(t/=s)*t*t+e}static _easeOutExpo(t,e,i,s){return i*(1-Math.pow(2,-10*t/s))+e}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(t){this._duration=t?1e3*t:500,this.stop()}get duration(){return this._duration/1e3}set fit(t){this._fit=!1!==t}get fit(){return this._fit}set fitFOV(t){this._fitFOV=t||45}get fitFOV(){return this._fitFOV}set trail(t){this._trail=!!t}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}const Mt=o.a.vec4(),Dt=o.a.vec4(),Rt=o.a.vec3(),St=o.a.vec3(),Ct=o.a.vec3(),Tt=o.a.vec4(),xt=o.a.vec4(),At=o.a.vec4();class Ot{constructor(t){this._scene=t}dollyToCanvasPos(t,e,i){let s=!1;const r=this._scene.camera;if(t){const e=o.a.subVec3(t,r.eye,Rt);s=o.a.lenVec3(e)<i}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-i;const s=this._unproject(e,Tt),n=o.a.subVec3(s,r.eye,At),a=o.a.mulVec3Scalar(o.a.normalizeVec3(n),-i,[]);if(r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]],t){const e=o.a.subVec3(t,r.eye,Rt),i=o.a.lenVec3(e),s=o.a.mulVec3Scalar(o.a.normalizeVec3(o.a.subVec3(r.look,r.eye,St)),i);r.look=[r.eye[0]+s[0],r.eye[1]+s[1],r.eye[2]+s[2]]}}else if("ortho"===r.projection){const t=this._unproject(e,Tt);r.ortho.scale=r.ortho.scale-i,r.ortho._update();const s=this._unproject(e,xt),n=o.a.subVec3(s,t,At),a=o.a.mulVec3Scalar(o.a.normalizeVec3(o.a.subVec3(r.look,r.eye,Rt)),-i,St),l=o.a.addVec3(n,a,Ct);r.eye=[r.eye[0]-l[0],r.eye[1]-l[1],r.eye[2]-l[2]],r.look=[r.look[0]-l[0],r.look[1]-l[1],r.look[2]-l[2]]}return s}_unproject(t,e){const i=this._scene.camera,s=i.project.transposedMatrix,r=s.subarray(8,12),n=s.subarray(12),a=[0,0,-1,1],l=o.a.dotVec4(a,r)/o.a.dotVec4(a,n);return i.project.unproject(t,l,Mt,Dt,e),e}destroy(){}}const Lt=o.a.vec3(),It=o.a.vec3(),jt=o.a.vec3(),Ft=o.a.vec4(),Bt=o.a.vec4(),Ut=o.a.vec4();class Vt{constructor(t,e){this._scene=t,this._configs=e,this._pivotWorldPos=o.a.vec3(),this._cameraOffset=o.a.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=o.a.vec4(),this._pivotProjPos=o.a.vec4(),this._pivotCanvasPos=o.a.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement()}))}updatePivotElement(){const t=this._scene.camera,e=this._scene.canvas;if(this._pivoting&&this._cameraDirty){o.a.transformPoint3(t.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,o.a.transformPoint4(t.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=e.boundary,s=i[2],r=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2);const n=e.canvas.getBoundingClientRect();this._pivotElement&&(this._pivotElement.style.left=Math.floor(n.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(n.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}setPivotElement(t){this._pivotElement=t}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const t=this._scene.camera;let e=o.a.lookAtMat4v(t.eye,t.look,t.worldUp);o.a.transformPoint3(e,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=o.a.distVec3(t.eye,i),e=o.a.inverseMat4(e);const s=o.a.transformVec3(e,this._cameraOffset),r=o.a.vec3();if(o.a.subVec3(t.eye,i,r),o.a.addVec3(r,s),t.zUp){const t=r[1];r[1]=r[2],r[2]=t}this._radius=o.a.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0}_cameraLookingDownwards(){const t=this._scene.camera,e=o.a.normalizeVec3(o.a.subVec3(t.look,t.eye,Lt)),i=o.a.cross3Vec3(e,t.worldUp,It);return o.a.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(t){this._pivotWorldPos.set(t),this._pivotPosSet=!0}setCanvasPivotPos(t){const e=this._scene.camera,i=Math.abs(o.a.distVec3(this._scene.center,e.eye)),s=e.project.transposedMatrix,r=s.subarray(8,12),n=s.subarray(12),a=[0,0,-1,1],l=o.a.dotVec4(a,r)/o.a.dotVec4(a,n),h=Ft;e.project.unproject(t,l,Bt,Ut,h);const c=o.a.normalizeVec3(o.a.subVec3(h,e.eye,Lt)),d=o.a.addVec3(e.eye,o.a.mulVec3Scalar(c,i,It),jt);this.setPivotPos(d)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(t,e){if(!this._pivoting)return;if(0===t&&0===e)return;const i=this._scene.camera;var s=-t;const r=-e;1===i.worldUp[2]&&(s=-s),this._azimuth+=.01*-s,this._polar+=.01*r,this._polar=o.a.clamp(this._polar,.001,Math.PI-.001);const n=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){const t=n[1];n[1]=n[2],n[2]=t}const a=o.a.lenVec3(o.a.subVec3(i.look,i.eye,o.a.vec3())),l=this.getPivotPos();o.a.addVec3(n,l);let h=o.a.lookAtMat4v(n,l,i.worldUp);h=o.a.inverseMat4(h);const c=o.a.transformVec3(h,this._cameraOffset);h[12]-=c[0],h[13]-=c[1],h[14]-=c[2];const d=[h[8],h[9],h[10]];i.eye=[h[12],h[13],h[14]],o.a.subVec3(i.eye,o.a.mulVec3Scalar(d,a),i.look),i.up=[h[4],h[5],h[6]],this.showPivot()}showPivot(){this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((()=>{this.hidePivot()}),1e3)))}hidePivot(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class Nt{constructor(t,e){this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(t){t.preventDefault()},this._configs=e,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=o.a.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=t,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){const t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){const t=this.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=t),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}}destroy(){}}const Yt=o.a.vec2();class Wt{constructor(t,e,i,s,r){this._scene=t;const n=e.pickController;let a,l,h,c=0,d=0,u=0,_=0,p=0,f=0;this._down=!1;let g=!1;const m=o.a.vec3();let v=!0;const b=this._scene.canvas.canvas,y=[];function w(t=!0){b.style.cursor="move",p=0,f=0,c=s.pointerCanvasPos[0],d=s.pointerCanvasPos[1],u=s.pointerCanvasPos[0],_=s.pointerCanvasPos[1],t&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(g=!0,m.set(n.pickResult.worldPos)):g=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;y[s]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;y[s]=!1}),b.addEventListener("mousedown",this._mouseDownHandler=e=>{if(i.active&&i.pointerEnabled){switch(this._down=!0,e.which){case 1:y[t.input.KEY_SHIFT]||i.planView?w():(a=!0,w(!1));break;case 2:l=!0,i.panRightClick||w();break;case 3:h=!0,i.panRightClick&&w()}document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{const e=t.canvas.boundary,n=e[2]-e[0],a=e[3]-e[1],u=s.pointerCanvasPos[0],_=s.pointerCanvasPos[1];if(y[t.input.KEY_SHIFT]||i.planView||!i.panRightClick&&l||i.panRightClick&&h){const e=u-c,i=_-d,s=t.camera;if("perspective"===s.projection){const n=Math.abs(g?o.a.lenVec3(o.a.subVec3(m,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*e*n/a,r.panDeltaY+=1.5*i*n/a}else r.panDeltaX+=.5*s.ortho.scale*(e/a),r.panDeltaY+=.5*s.ortho.scale*(i/a)}else l||h||i.planView||(i.firstPerson?(r.rotateDeltaY-=(u-c)/n*i.dragRotationRate/2,r.rotateDeltaX+=(_-d)/a*(i.dragRotationRate/4)):(r.rotateDeltaY-=(u-c)/n*(1.5*i.dragRotationRate),r.rotateDeltaX+=(_-d)/a*(1.5*i.dragRotationRate)));c=u,d=_})}}),b.addEventListener("mousemove",this._canvasMouseMoveHandler=t=>{i.active&&i.pointerEnabled&&s.mouseover&&(r.inputFromMouse=!0,v=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{if(i.active&&i.pointerEnabled){switch(t.which){case 1:a=!1;break;case 2:l=!1;break;case 3:h=!1}p=0,f=0,this._down=!1,document.removeEventListener("mousemove",this._documentMouseMoveHandler)}}),b.addEventListener("mouseup",this._mouseUpHandler=t=>{if(i.active&&i.pointerEnabled){switch(t.which){case 3:!function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y}(t,Yt);const i=Yt[0],s=Yt[1];Math.abs(i-u)<3&&Math.abs(s-_)<3&&e.cameraControl.fire("rightClick",{canvasPos:Yt,event:t},!0)}b.style.removeProperty("cursor")}}),b.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled&&(p=0,f=0,this._down=!1)});const P=1/60;let E=null;b.addEventListener("wheel",this._mouseWheelHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=performance.now()/1e3;var o=null!==E?e-E:0;E=e,o>.05&&(o=.05),o<P&&(o=P);const n=Math.max(-1,Math.min(1,40*-t.deltaY));if(0===n)return;const a=n/Math.abs(n);r.dollyDelta+=-a*o*i.mouseWheelDollyRate,v&&(s.followPointerDirty=!0,v=!1),t.preventDefault()})}reset(){this._down=!1}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),t.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),t.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._mouseUpHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("wheel",this._mouseWheelHandler)}}const Kt=o.a.vec3(),Ht=o.a.vec3(),zt=o.a.vec3(),Xt=o.a.vec3(),Gt=o.a.vec3(),Zt={eye:o.a.vec3(),look:o.a.vec3(),up:o.a.vec3()};class qt{constructor(t,e,i,s,r){this._scene=t;const n=e.cameraControl,a=t.camera;t.input.on("keydown",this._documentKeyDownHandler=r=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const l=n._isKeyDownForAction(n.AXIS_VIEW_RIGHT),h=n._isKeyDownForAction(n.AXIS_VIEW_BACK),c=n._isKeyDownForAction(n.AXIS_VIEW_LEFT),d=n._isKeyDownForAction(n.AXIS_VIEW_FRONT),u=n._isKeyDownForAction(n.AXIS_VIEW_TOP),_=n._isKeyDownForAction(n.AXIS_VIEW_BOTTOM);if(!l&&!h&&!c&&!d&&!u&&!_)return;const p=t.aabb,f=o.a.getAABB3Diag(p);o.a.getAABB3Center(p,Kt);const g=Math.abs(f/Math.tan(e.cameraFlight.fitFOV*o.a.DEGTORAD)),m=1.1*f;Zt.orthoScale=m,l?(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldRight,g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(a.worldUp)):h?(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldForward,g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(a.worldUp)):c?(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldRight,-g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(a.worldUp)):d?(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldForward,-g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(a.worldUp)):u?(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldUp,g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(o.a.normalizeVec3(o.a.mulVec3Scalar(a.worldForward,1,zt),Xt))):_&&(Zt.eye.set(o.a.addVec3(Kt,o.a.mulVec3Scalar(a.worldUp,-g,Ht),Gt)),Zt.look.set(Kt),Zt.up.set(o.a.normalizeVec3(o.a.mulVec3Scalar(a.worldForward,-1,zt)))),!i.firstPerson&&i.followPointer&&e.pivotController.setPivotPos(Kt),e.cameraFlight.duration>0?e.cameraFlight.flyTo(Zt,(()=>{e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot()})):(e.cameraFlight.jumpTo(Zt),e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot())})}reset(){}destroy(){document.removeEventListener("keydown",this._documentKeyDownHandler)}}class Jt{constructor(t,e,i,s,r){this._scene=t;const n=e.pickController,a=e.pivotController,l=e.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let h=!1,c=!1;const d=this._scene.canvas.canvas,u=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i&&i.entity?i.entity.aabb:t.aabb;if(s){const i=t.camera;o.a.subVec3(i.eye,i.look,[]);e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};d.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(h||c)return;const r=l.hasSubs("hover"),o=l.hasSubs("hoverOut"),a=l.hasSubs("hoverOff"),d=l.hasSubs("hoverSurface");if(r||o||a||d)if(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=d,n.update(),n.pickResult){const e=n.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&l.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),l.fire("hoverEnter",n.pickResult,!0),this._lastPickedEntityId=e),l.fire("hover",n.pickResult,!0),n.pickResult.worldPos&&l.fire("hoverSurface",n.pickResult,!0)}else void 0!==this._lastPickedEntityId&&(l.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),l.fire("hoverOff",{canvasPos:n.pickCursorPos},!0)}),d.addEventListener("mousedown",this._canvasMouseDownHandler=e=>{1===e.which&&(h=!0),3===e.which&&(c=!0);if(1===e.which&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=e.clientX,s.mouseDownClientY=e.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),1===e.which))){const e=n.pickResult;e&&e.worldPos?(a.setPivotPos(e.worldPos),a.startPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),a.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{1===t.which&&(h=!1),3===t.which&&(c=!1)}),d.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!i.active||!i.pointerEnabled)return;if(!(1===r.which))return;if(a.hidePivot(),Math.abs(r.clientX-s.mouseDownClientX)>3||Math.abs(r.clientY-s.mouseDownClientY)>3)return;const h=l.hasSubs("picked"),c=l.hasSubs("pickedNothing"),d=l.hasSubs("pickedSurface"),_=l.hasSubs("doublePicked"),p=l.hasSubs("doublePickedSurface"),f=l.hasSubs("doublePickedNothing");if(!i.doublePickFlyTo&&!_&&!p&&!f)return(h||c||d)&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=!0,n.schedulePickSurface=d,n.update(),n.pickResult?(l.fire("picked",n.pickResult,!0),n.pickedSurface&&l.fire("pickedSurface",n.pickResult,!0)):l.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks)this._timeout=setTimeout((()=>{n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=i.doublePickFlyTo,n.schedulePickSurface=d,n.update(),n.pickResult?(l.fire("picked",n.pickResult,!0),n.pickedSurface&&(l.fire("pickedSurface",n.pickResult,!0),!i.firstPerson&&i.followPointer&&(e.pivotController.setPivotPos(n.pickResult.worldPos),e.pivotController.startPivot()&&e.pivotController.showPivot()))):l.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0}),250);else{if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),n.pickCursorPos=s.pointerCanvasPos,n.schedulePickEntity=i.doublePickFlyTo||_||p,n.schedulePickSurface=n.schedulePickEntity&&p,n.update(),n.pickResult){if(l.fire("doublePicked",n.pickResult,!0),n.pickedSurface&&l.fire("doublePickedSurface",n.pickResult,!0),i.doublePickFlyTo&&(u(n.pickResult),!i.firstPerson&&i.followPointer)){const t=n.pickResult.entity.aabb,i=o.a.getAABB3Center(t);e.pivotController.setPivotPos(i),e.pivotController.startPivot()&&e.pivotController.showPivot()}}else if(l.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(u(),!i.firstPerson&&i.followPointer)){const i=t.aabb,s=o.a.getAABB3Center(i);e.pivotController.setPivotPos(s),e.pivotController.startPivot()&&e.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("mousemove",this._canvasMouseMoveHandler),t.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class Qt{constructor(t,e,i,s,r){this._scene=t;const o=t.input,n=[],a=t.canvas.canvas;e.pickController;let l=!0;document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{l=!0}),document.addEventListener("keydown",this._documentKeyDownHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const r=e.keyCode;n[r]=!0,r===o.KEY_SHIFT&&(a.style.cursor="move")}),document.addEventListener("keyup",this._documentKeyUpHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const r=e.keyCode;n[r]=!1,r===o.KEY_SHIFT&&(a.style.cursor=null)}),this._onTick=t.on("tick",(a=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const h=e.cameraControl,c=a.deltaTime/1e3;if(!i.planView){const t=h._isKeyDownForAction(h.ROTATE_Y_POS,n),s=h._isKeyDownForAction(h.ROTATE_Y_NEG,n),o=h._isKeyDownForAction(h.ROTATE_X_POS,n),a=h._isKeyDownForAction(h.ROTATE_X_NEG,n),l=c*i.keyboardRotationRate;(t||s||o||a)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),t?r.rotateDeltaY+=l:s&&(r.rotateDeltaY-=l),o?r.rotateDeltaX+=l:a&&(r.rotateDeltaX-=l),!i.firstPerson&&i.followPointer&&e.pivotController.startPivot())}if(!n[o.KEY_CTRL]&&!n[o.KEY_ALT]){const t=h._isKeyDownForAction(h.DOLLY_BACKWARDS,n),o=h._isKeyDownForAction(h.DOLLY_FORWARDS,n);if(t||o){const n=c*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),o?r.dollyDelta-=n:t&&(r.dollyDelta+=n),l&&(s.followPointerDirty=!0,l=!1)}}const d=h._isKeyDownForAction(h.PAN_FORWARDS,n),u=h._isKeyDownForAction(h.PAN_BACKWARDS,n),_=h._isKeyDownForAction(h.PAN_LEFT,n),p=h._isKeyDownForAction(h.PAN_RIGHT,n),f=h._isKeyDownForAction(h.PAN_UP,n),g=h._isKeyDownForAction(h.PAN_DOWN,n),m=(n[o.KEY_ALT]?.3:1)*c*i.keyboardPanRate;(d||u||_||p||f||g)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),g?r.panDeltaY+=m:f&&(r.panDeltaY+=-m),p?r.panDeltaX+=-m:_&&(r.panDeltaX+=m),u?r.panDeltaZ+=m:d&&(r.panDeltaZ+=-m))}))}reset(){}destroy(){this._scene.off(this._onTick),document.removeEventListener("mousemove",this._documentMouseMoveHandler),document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler)}}const $t=.001,te=o.a.vec3();class ee{constructor(t,e,i,s,r){this._scene=t;const n=t.camera,a=e.pickController,l=e.pivotController,h=e.panController;let c=1,d=1,u=null;this._onTick=t.on("tick",(()=>{if(!i.active||!i.pointerEnabled)return;let e="default";if(Math.abs(r.dollyDelta)<$t&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<$t&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<$t&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),i.followPointer&&--c<=0&&(c=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&i.followPointer&&s.followPointerDirty&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?u=a.pickResult.worldPos:(d=1,u=null),s.followPointerDirty=!1),u){const e=Math.abs(o.a.lenVec3(o.a.subVec3(u,t.camera.eye,te)));d=e/i.dollyProximityThreshold}d<i.dollyMinSpeed&&(d=i.dollyMinSpeed)}const _=r.dollyDelta*d;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!i.firstPerson&&i.followPointer&&l.getPivoting()?(l.continuePivot(r.rotateDeltaY,r.rotateDeltaX),l.showPivot()):(0!==r.rotateDeltaX&&(i.firstPerson?n.pitch(-r.rotateDeltaX):n.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(i.firstPerson?n.yaw(r.rotateDeltaY):n.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=i.rotationInertia,r.rotateDeltaY*=i.rotationInertia,e="grabbing"),Math.abs(r.panDeltaX)<$t&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<$t&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<$t&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const t=o.a.vec3();let s,a;if(t[0]=r.panDeltaX,t[1]=r.panDeltaY,t[2]=r.panDeltaZ,i.constrainVertical){n.xUp?(s=n.eye[0],a=n.look[0]):n.yUp?(s=n.eye[1],a=n.look[1]):n.zUp&&(s=n.eye[2],a=n.look[2]),n.pan(t);const e=n.eye,i=n.look;n.xUp?(e[0]=s,i[0]=a):n.yUp?(e[1]=s,i[1]=a):n.zUp&&(e[2]=s,i[2]=a),n.eye=e,n.look=i}else n.pan(t);e="grabbing"}if(r.panDeltaX*=i.panInertia,r.panDeltaY*=i.panInertia,r.panDeltaZ*=i.panInertia,0!==_){if(e=_<0?"zoom-in":"zoom-out",i.firstPerson){let t,e;if(i.constrainVertical&&(n.xUp?(t=n.eye[0],e=n.look[0]):n.yUp?(t=n.eye[1],e=n.look[1]):n.zUp&&(t=n.eye[2],e=n.look[2])),i.followPointer){h.dollyToCanvasPos(u,s.pointerCanvasPos,-_)&&(s.followPointerDirty=!0)}else n.pan([0,0,_]),n.ortho.scale=n.ortho.scale-_;if(i.constrainVertical){const i=n.eye,s=n.look;n.xUp?(i[0]=t,s[0]=e):n.yUp?(i[1]=t,s[1]=e):n.zUp&&(i[2]=t,s[2]=e),n.eye=i,n.look=s}}else if(i.planView)if(i.followPointer){h.dollyToCanvasPos(u,s.pointerCanvasPos,-_)&&(s.followPointerDirty=!0)}else n.ortho.scale=n.ortho.scale+_,n.zoom(_);else if(i.followPointer){h.dollyToCanvasPos(u,s.pointerCanvasPos,-_)&&(s.followPointerDirty=!0)}else n.ortho.scale=n.ortho.scale+_,n.zoom(_);r.dollyDelta*=i.dollyInertia}a.fireEvents(),r.inputFromMouse=!1,document.body.style.cursor=e}))}destroy(){this._scene.off(this._onTick)}}class ie{constructor(t,e,i,s,r){this._scene=t;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=t=>{se(t,o,s.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=t=>{i.active&&i.pointerEnabled&&(se(t,o,s.pointerCanvasPos),s.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=t=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("mouseleave",this._mouseLeaveHandler),t.removeEventListener("mousedown",this._mouseDownHandler),t.removeEventListener("mouseup",this._mouseUpHandler)}}function se(t,e,i){if(t){const{x:s,y:r}=e.getBoundingClientRect();i[0]=t.clientX-s,i[1]=t.clientY-r}else t=window.event,i[0]=t.x,i[1]=t.y;return i}const re=function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e};class oe{constructor(t,e,i,s,r){this._scene=t;const n=e.pickController,a=e.pivotController,l=o.a.vec2(),h=o.a.vec2(),c=o.a.vec2(),d=o.a.vec2(),u=[],_=this._scene.canvas.canvas;let p=0,f=-1,g=!1;this._onTick=t.on("tick",(()=>{g=!1})),_.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!i.active||!i.pointerEnabled)return;e.stopPropagation(),e.preventDefault();const r=e.touches,h=e.changedTouches;for(s.touchStartTime=Date.now(),1===r.length&&1===h.length?(f=s.touchStartTime,re(r[0],l),i.followPointer&&(n.pickCursorPos=l,n.schedulePickSurface=!0,n.update(),i.planView||(n.picked&&n.pickedSurface&&n.pickResult&&n.pickResult.worldPos?(a.setPivotPos(n.pickResult.worldPos),!i.firstPerson&&a.startPivot()&&a.showPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),!i.firstPerson&&a.startPivot()&&a.showPivot())))):f=-1;u.length<r.length;)u.push(o.a.vec2());for(let t=0,i=r.length;t<i;++t)re(r[t],u[t]);p=r.length}),_.addEventListener("touchmove",this._canvasTouchMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(e.stopPropagation(),e.preventDefault(),g)return;g=!0;const a=t.canvas.boundary,l=a[2]-a[0],_=a[3]-a[1],f=e.touches;if(e.touches.length===p){if(1===p){re(f[0],h),o.a.subVec2(h,u[0],d);const e=d[0],s=d[1];if(i.planView){const n=t.camera;if("perspective"===n.projection){const a=!1,l=[0,0,0],h=Math.abs(a?o.a.lenVec3(o.a.subVec3(l,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(n.perspective.fov/2*Math.PI/180);r.panDeltaX+=e*h/_*i.touchPanRate,r.panDeltaY+=s*h/_*i.touchPanRate}else r.panDeltaX+=.5*n.ortho.scale*(e/_)*i.touchPanRate,r.panDeltaY+=.5*n.ortho.scale*(s/_)*i.touchPanRate}else r.rotateDeltaY-=e/l*(1*i.dragRotationRate),r.rotateDeltaX+=s/_*(1.5*i.dragRotationRate)}else if(2===p){const e=f[0],a=f[1];re(e,h),re(a,c);const l=o.a.geometricMeanVec2(u[0],u[1]),d=o.a.geometricMeanVec2(h,c),p=o.a.vec2();o.a.subVec2(l,d,p);const g=p[0],m=p[1],v=t.camera,b=o.a.distVec2([e.pageX,e.pageY],[a.pageX,a.pageY]),y=(o.a.distVec2(u[0],u[1])-b)*i.touchDollyRate;if(r.dollyDelta=y,Math.abs(y)<1)if("perspective"===v.projection){const e=n.pickResult?n.pickResult.worldPos:t.center,s=Math.abs(o.a.lenVec3(o.a.subVec3(e,t.camera.eye,[])))*Math.tan(v.perspective.fov/2*Math.PI/180);r.panDeltaX-=g*s/_*i.touchPanRate,r.panDeltaY-=m*s/_*i.touchPanRate}else r.panDeltaX-=.5*v.ortho.scale*(g/_)*i.touchPanRate,r.panDeltaY-=.5*v.ortho.scale*(m/_)*i.touchPanRate;s.pointerCanvasPos=d}for(let t=0;t<p;++t)re(f[t],u[t])}})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}class ne{constructor(t,e,i,s,r){this._scene=t;const n=e.pickController,a=(e.pivotController,e.cameraControl);let l;const h=[],c=new Float32Array(2);let d=-1,u=-1;const _=this._scene.canvas.canvas,p=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i?i.entity.aabb:t.aabb;if(s){const i=t.camera;o.a.subVec3(i.eye,i.look,[]);e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};_.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=t.touches,s=t.changedTouches;for(l=Date.now(),1===e.length&&1===s.length?(d=l,c[0]=e[0].pageX,c[1]=e[0].pageY):d=-1;h.length<e.length;)h.push(new Float32Array(2));for(let i=0,r=e.length;i<r;++i)h[i][0]=e[i].pageX,h[i][1]=e[i].pageY;h.length=e.length,t.stopPropagation()},{passive:!0}),_.addEventListener("touchend",this._canvasTouchEndHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=Date.now(),s=t.touches,r=t.changedTouches,l=(a.hasSubs("picked"),a.hasSubs("pickedNothing"),a.hasSubs("pickedSurface"));a.hasSubs("doublePicked"),a.hasSubs("doublePickedSurface"),a.hasSubs("doublePickedNothing");0===s.length&&1===r.length&&d>-1&&e-d<150&&(u>-1&&d-u<325?(n.pickCursorPos[0]=Math.round(r[0].clientX),n.pickCursorPos[1]=Math.round(r[0].clientY),n.schedulePickEntity=!0,n.schedulePickSurface=l,n.update(),n.pickResult?(a.fire("doublePicked",n.pickResult),n.pickedSurface&&a.fire("doublePickedSurface",n.pickResult),i.doublePickFlyTo&&p(n.pickResult)):(a.fire("doublePickedNothing"),i.doublePickFlyTo&&p()),u=-1):o.a.distVec2(h[0],c)<4&&(n.pickCursorPos[0]=Math.round(r[0].clientX),n.pickCursorPos[1]=Math.round(r[0].clientY),n.schedulePickEntity=!0,n.schedulePickSurface=l,n.update(),n.pickResult?(a.fire("picked",n.pickResult),n.pickedSurface&&a.fire("pickedSurface",n.pickResult)):a.fire("pickedNothing"),u=e),d=-1),h.length=s.length;for(let i=0,o=s.length;i<o;++i)h[i][0]=s[i].pageX,h[i][1]=s[i].pageY;t.stopPropagation()},{passive:!0})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchend",this._canvasTouchEndHandler)}}class ae extends n.a{constructor(t,e={}){super(t,e),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=t=>{t.preventDefault()},this._configs={tapInterval:150,doubleTapInterval:325,tapDistanceThreshold:4,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:o.a.vec2(),mouseover:!1,inputFromMouse:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:o.a.vec2(),tapStartTime:-1,lastTapTime:-1},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new Nt(this,this._configs),pivotController:new Vt(i,this._configs),panController:new Ot(i),cameraFlight:new kt(this,{duration:.5})},this._handlers=[new ie(this.scene,this._controllers,this._configs,this._states,this._updates),new oe(this.scene,this._controllers,this._configs,this._states,this._updates),new Wt(this.scene,this._controllers,this._configs,this._states,this._updates),new qt(this.scene,this._controllers,this._configs,this._states,this._updates),new Jt(this.scene,this._controllers,this._configs,this._states,this._updates),new ne(this.scene,this._controllers,this._configs,this._states,this._updates),new Qt(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new ee(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=e.navMode,e.planView&&(this.planView=e.planView),this.constrainVertical=e.constrainVertical,e.keyboardLayout?this.keyboardLayout=e.keyboardLayout:this.keyMap=e.keyMap,this.doublePickFlyTo=e.doublePickFlyTo,this.panRightClick=e.panRightClick,this.active=e.active,this.followPointer=e.followPointer,this.rotationInertia=e.rotationInertia,this.keyboardPanRate=e.keyboardPanRate,this.touchPanRate=e.touchPanRate,this.keyboardRotationRate=e.keyboardRotationRate,this.dragRotationRate=e.dragRotationRate,this.touchDollyRate=e.touchDollyRate,this.dollyInertia=e.dollyInertia,this.dollyProximityThreshold=e.dollyProximityThreshold,this.dollyMinSpeed=e.dollyMinSpeed,this.panInertia=e.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=e.keyboardDollyRate,this.mouseWheelDollyRate=e.mouseWheelDollyRate}set keyMap(t){if(t=t||"qwerty",r.a.isString(t)){const e=this.scene.input,i={};switch(t){default:this.error("Unsupported value for 'keyMap': "+t+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[e.KEY_A],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_Z],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_W,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_Q,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[e.KEY_Q],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_W],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_Z,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_A,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6]}this._keyMap=i}else{const e=t;this._keyMap=e}}get keyMap(){return this._keyMap}_isKeyDownForAction(t,e){const i=this._keyMap[t];if(!i)return!1;e||(e=this.scene.input.keyDown);for(let s=0,r=i.length;s<r;s++){if(e[i[s]])return!0}return!1}set pivotElement(t){this._controllers.pivotController.setPivotElement(t)}set active(t){this._configs.active=!1!==t}get active(){return this._configs.active}set navMode(t){"firstPerson"!==(t=t||"orbit")&&"orbit"!==t&&"planView"!==t&&(this.error("Unsupported value for navMode: "+t+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),t="orbit"),this._configs.firstPerson="firstPerson"===t,this._configs.planView="planView"===t,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=t}get navMode(){return this._configs.navMode}set pointerEnabled(t){this._reset(),this._configs.pointerEnabled=!!t}_reset(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.reset&&e.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(t){this._configs.followPointer=!1!==t}get followPointer(){return this._configs.followPointer}set pivotPos(t){this._controllers.pivotController.setPivotPos(t)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(t){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=t}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(t){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(t){this._configs.planView=!!t,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(t){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!t,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(t){this._configs.constrainVertical=!!t}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(t){this._configs.doublePickFlyTo=!1!==t}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(t){this._configs.panRightClick=!1!==t}get panRightClick(){return this._configs.panRightClick}set rotationInertia(t){this._configs.rotationInertia=void 0!==t&&null!==t?t:0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(t){this._configs.keyboardPanRate=null!==t&&void 0!==t?t:5}set touchPanRate(t){this._configs.touchPanRate=null!==t&&void 0!==t?t:1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(t){this._configs.keyboardRotationRate=null!==t&&void 0!==t?t:90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(t){this._configs.dragRotationRate=null!==t&&void 0!==t?t:360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(t){this._configs.keyboardDollyRate=null!==t&&void 0!==t?t:15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(t){this._configs.touchDollyRate=null!==t&&void 0!==t?t:.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(t){this._configs.mouseWheelDollyRate=null!==t&&void 0!==t?t:100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(t){this._configs.dollyInertia=void 0!==t&&null!==t?t:0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(t){this._configs.dollyProximityThreshold=void 0!==t&&null!==t?t:35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(t){this._configs.dollyMinSpeed=void 0!==t&&null!==t?t:.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(t){this._configs.panInertia=void 0!==t&&null!==t?t:.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(t){"qwerty"!==(t=t||"qwerty")&&"azerty"!==t&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),t="qwerty"),this._configs.keyboardLayout=t,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}set smartPivot(t){this._configs.smartPivot=!1!==t}get smartPivot(){return this._configs.smartPivot}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.destroy&&e.destroy()}}_destroyControllers(){for(let t=0,e=this._controllers.length;t<e;t++){const e=this._controllers[t];e.destroy&&e.destroy()}}}class le{constructor(t,e,i,s,r,o,n,a,l){this.id=e,this.projectId=i,this.revisionId=s,this.author=r,this.createdAt=o,this.creatingApplication=n,this.schema=a,this.metaScene=t,this.rootMetaObject=l}getJSON(){var t=[];return function e(i){var s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),t.push(s);var r=i.children;if(r)for(var o=0,n=r.length;o<n;o++)e(r[o])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:t}}}class he{constructor(t,e,i,s,r,o,n,a,l){this.metaModel=t,this.id=e,this.originalSystemId=i,this.name=s,this.type=r,o&&(this.properties=o),void 0!==n&&null!==n&&(this.parent=n),void 0!==a&&null!==a&&(this.children=a),void 0!==l&&null!==l&&(this.external=l)}getObjectIDsInSubtree(){const t=[];return function e(i){if(!i)return;t.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this),t}withMetaObjectsInSubtree(t){!function e(i){if(!i)return;t(i);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this)}getObjectIDsInSubtreeByType(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=t[i];const r=[];return function t(i){if(!i)return;e[i.type]&&r.push(i.id);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)t(s[o])}(this),r}getJSON(){var t={id:this.id,type:this.type,name:this.name};return this.parent&&(t.parent=this.parent.id),t}}class ce{constructor(t,e){this.viewer=t,this.scene=e,this.metaModels={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let s=0,r=i.length;s<r;s++)i[s](e)}off(t){}createMetaModel(t,e,i={}){const s=e.projectId||"none",r=e.revisionId||"none",n=e.metaObjects,a=e.author,l=e.createdAt,h=e.creatingApplication,c=e.schema;var d;const u=new le(this,t,s,r,a,l,h,c,null);this.metaModels[t]=u;for(let _=0,p=n.length;_<p;_++){const e=n[_],s=e.type;d;const r=i.globalizeObjectIds?o.a.globalizeObjectId(t,e.id):e.id,a=e.id,l=e.name,h=e.properties,c=null,p=null,f=e.external,g=new he(u,r,a,l,s,h,c,p,f);this.metaObjects[r]=g,(this.metaObjectsByType[s]||(this.metaObjectsByType[s]={}))[r]=g,void 0===this._typeCounts[s]?this._typeCounts[s]=1:this._typeCounts[s]++}for(let _=0,p=n.length;_<p;_++){const e=n[_],s=i.globalizeObjectIds?o.a.globalizeObjectId(t,e.id):e.id,r=this.metaObjects[s];if(r)if(void 0===e.parent||null===e.parent)u.rootMetaObject=r;else if(e.parent){const s=i.globalizeObjectIds?o.a.globalizeObjectId(t,e.parent):e.parent;let n=this.metaObjects[s];n&&(r.parent=n,n.children=n.children||[],n.children.push(r))}}return this.fire("metaModelCreated",t),u}destroyMetaModel(t){const e=this.metaModels[t];e&&(this._removeMetaModel(e),this.fire("metaModelDestroyed",t))}_removeMetaModel(t){const e=this.metaObjects,i=this.metaObjectsByType;let s=t=>{delete e[t.id];const r=i[t.type];r&&r[t.id]&&(delete r[t.id],0===--this._typeCounts[t.type]&&(delete this._typeCounts[t.type],delete i[t.type]));const o=t.children;if(o)for(let e=0,i=o.length;e<i;e++){const t=o[e];s(t)}};s(t.rootMetaObject),delete this.metaModels[t.id]}getObjectIDsByType(t){const e=this.metaObjectsByType[t];return e?Object.keys(e):[]}getObjectIDsInSubtree(t,e,i){const s=[],r=this.metaObjects[t],o=e&&e.length>0?de(e):null,n=i&&i.length>0?de(i):null;return function t(e){if(!e)return;var i=!0;(n&&n[e.type]||o&&!o[e.type])&&(i=!1),i&&s.push(e.id);const r=e.children;if(r)for(var a=0,l=r.length;a<l;a++)t(r[a])}(r),s}withMetaObjectsInSubtree(t,e){const i=this.metaObjects[t];i&&i.withMetaObjectsInSubtree(e)}}function de(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=!0;return e}class ue{constructor(t){this.language="en",this.scene=new vt(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,clearColorAmbient:t.clearColorAmbient,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled}),this.metaScene=new ce(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new kt(this.scene,{duration:.5}),this.cameraControl=new ae(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let s=0,r=i.length;s<r;s++)i[s](e)}off(t){}log(t){console.log(`[xeokit viewer ${this.id}]: ${t}`)}error(t){console.error(`[xeokit viewer ${this.id}]: ${t}`)}addPlugin(t){this._plugins.push(t)}removePlugin(t){for(let e=0,i=this._plugins.length;e<i;e++){const i=this._plugins[e];if(i===t)return i.clear&&i.clear(),void this._plugins.splice(e,1)}}sendToPlugins(t,e){for(let i=0,s=this._plugins.length;i<s;i++){const s=this._plugins[i];s.send&&s.send(t,e)}}clear(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(t={}){const e=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),t.includeGizmos||this.sendToPlugins("snapshotStarting");const i=void 0!==t.width&&void 0!==t.height,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,n=s.style.width,a=s.style.height,l=t.width?Math.floor(t.width):s.width,h=t.height?Math.floor(t.height):s.height;i&&(s.style.width=l+"px",s.style.height=h+"px"),this.scene._renderer.renderSnapshot();const c=this.scene._renderer.readSnapshot(t);return i&&(s.style.width=n,s.style.height=a,s.width=r,s.height=o,this.scene.glRedraw()),t.includeGizmos||this.sendToPlugins("snapshotFinished"),e&&this.endSnapshot(),c}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const t=this._plugins.slice();for(let e=0,i=t.length;e<i;e++){t[e].destroy()}this.scene.destroy()}}}}]);