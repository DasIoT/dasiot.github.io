(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[15],{rvOK:function(e,t,i){"use strict";i.r(t),i.d(t,"ImagePlane",(function(){return Ae}));var s=i("oDdi"),a=i("zcj1"),r=i("tehY");const o=r.a.vec4(4),l=r.a.vec4(),n=r.a.vec4(),h=r.a.vec3([1,0,0]),u=r.a.vec3([0,1,0]),c=r.a.vec3([0,0,1]),p=r.a.vec3(3),d=r.a.vec3(3),_=r.a.identityMat4();class m extends s.a{constructor(e,t={}){if(super(e,t),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=r.a.vec3(),this._quaternion=r.a.identityQuaternion(),this._rotation=r.a.vec3(),this._position=r.a.vec3(),this._offset=r.a.vec3(),this._localMatrix=r.a.identityMat4(),this._worldMatrix=r.a.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this.rtcCenter=t.rtcCenter,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.children){const e=t.children;for(let i=0,s=e.length;i<s;i++)this.addChild(e[i],t.inheritStates)}if(t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'")}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set rtcCenter(e){e?(this._rtcCenter||(this._rtcCenter=r.a.vec3()),this._rtcCenter.set(e)):this._rtcCenter&&(this._rtcCenter=null);for(let t=0,i=this._children.length;t<i;t++)this._children[t].rtcCenter=e}get rtcCenter(){return this._rtcCenter}get numTriangles(){return this._numTriangles}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}get visible(){return this._visible}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}get xrayed(){return this._xrayed}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}get highlighted(){return this._highlighted}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let i=0,s=this._children.length;i<s;i++)this._children[i].colorize=t;if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t)}}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!==e&&void 0!==e?e:1;for(let i=0,s=this._children.length;i<s;i++)this._children[i].opacity=e;if(this._isObject){const t=null!==e&&void 0!==e;this.scene._objectOpacityUpdated(this,t)}}get opacity(){return this._colorize[3]}set castsShadow(e){e=!!e,this._castsShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}get castsShadow(){return this._castsShadow}set receivesShadow(e){e=!!e,this._receivesShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,i=this._children.length;t<i;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)r.a.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._children)for(let t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=r.a.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{let e;r.a.collapseAABB3(this._aabb);for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e.collidable&&r.a.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}addChild(e,t){if(a.a.isNumeric(e)||a.a.isString(e)){const t=e;if(!(e=this.scene.component[t]))return void this.warn("Component not found: "+a.a.inQuotes(t));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+t)}else{if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e)}}e.id;if(e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id)}removeChild(e){for(let t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}removeChildren(){let e;for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(e){if(a.a.isNumeric(e)||a.a.isString(e)){const t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+a.a.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id)}get parent(){return this._parentNode}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),r.a.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),r.a.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=r.a.identityMat4()),this._localMatrix.set(e||_),r.a.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=r.a.identityMat4()),r.a.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=t*r.a.DEGTORAD,r.a.angleAxisToQuaternion(o,l),r.a.mulQuaternions(this.quaternion,l,n),this.quaternion=n,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=t*r.a.DEGTORAD,r.a.angleAxisToQuaternion(o,l),r.a.mulQuaternions(l,this.quaternion,l),this}rotateX(e){return this.rotate(h,e)}rotateY(e){return this.rotate(u,e)}rotateZ(e){return this.rotate(c,e)}translate(e,t){return r.a.vec3ApplyQuaternion(this.quaternion,e,p),r.a.mulVec3Scalar(p,t,d),r.a.addVec3(this.position,d,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(h,e)}translateY(e){return this.translate(u,e)}translateZ(e){return this.translate(c,e)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const e=this._children.splice();let t;for(let i=0,s=e.length;i<s;i++)t=e[i],t.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}var f=i("tRux"),g=i("jWoc");const M=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene._lightsState,a=e._geometry._state,r=e._state.billboard,o=e._state.stationary,l=i.sectionPlanes.length>0,n=!!a.compressGeometry,h=[];h.push("// Lambertian drawing vertex shader"),t.logarithmicDepthBufferEnabled&&h.push("#extension GL_EXT_frag_depth : enable");h.push("attribute vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),n&&h.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),h.push("varying float vFragDepth;"));l&&h.push("varying vec4 vWorldPosition;");if(h.push("uniform vec4 lightAmbient;"),h.push("uniform vec4 materialColor;"),h.push("uniform vec3 materialEmissive;"),a.normalsBuf){h.push("attribute vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(h.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&h.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&h.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(h.push("uniform vec3 lightPos"+e+";"),h.push("uniform vec3 lightDir"+e+";")))}n&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"))}h.push("varying vec4 vColor;"),"points"===a.primitiveName&&h.push("uniform float pointSize;");"spherical"!==r&&"cylindrical"!==r||(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===r&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),n&&h.push("localPosition = positionsDecodeMatrix * localPosition;");a.normalsBuf&&(n?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),o&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),a.normalsBuf&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.normalsBuf&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),a.normalsBuf)for(let u=0,c=s.lights.length;u<c;u++){const e=s.lights[u];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?h.push("viewLightDir = normalize(lightDir"+u+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+u+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?h.push("viewLightDir = -normalize(lightPos"+u+" - viewPosition.xyz);"):h.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+u+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?h.push("viewLightDir = normalize(lightDir"+u+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+u+", 0.0)).xyz);")}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+u+".rgb * lightColor"+u+".a);")}}h.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),l&&h.push("vWorldPosition = worldPosition;");"points"===a.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&h.push("vFragDepth = 1.0 + clipPos.w;");return h.push("gl_Position = clipPos;"),h.push("}"),h}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=(e._material._state,e._geometry._state),a=i.sectionPlanes.length>0,r=!1,o=t.gammaOutput,l=[];l.push("// Lambertian drawing fragment shader"),t.logarithmicDepthBufferEnabled&&l.push("#extension GL_EXT_frag_depth : enable");l.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),l.push("precision highp float;"),l.push("precision highp int;"),l.push("#else"),l.push("precision mediump float;"),l.push("precision mediump int;"),l.push("#endif"),t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("varying float vFragDepth;"));if(a){l.push("varying vec4 vWorldPosition;"),l.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)l.push("uniform bool sectionPlaneActive"+e+";"),l.push("uniform vec3 sectionPlanePos"+e+";"),l.push("uniform vec3 sectionPlaneDir"+e+";")}l.push("varying vec4 vColor;"),o&&(l.push("uniform float gammaFactor;"),l.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),l.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),l.push("}"));if(l.push("void main(void) {"),a){l.push("if (clippable) {"),l.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)l.push("if (sectionPlaneActive"+e+") {"),l.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),l.push("}");l.push("  if (dist > 0.0) { discard; }"),r&&(l.push("  if (gl_FrontFacing == false) {"),l.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),l.push("     return;"),l.push("  }")),l.push("}")}"points"===s.primitiveName&&(l.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),l.push("float r = dot(cxy, cxy);"),l.push("if (r > 1.0) {"),l.push("   discard;"),l.push("}"));t.logarithmicDepthBufferEnabled&&l.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");o?l.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):l.push("gl_FragColor = vColor;");return l.push("}"),l}(e)):(this.vertex=function(e){const t=e.scene,i=e._material,s=e._state,a=t._sectionPlanesState,r=e._geometry._state,o=t._lightsState;let l;const n=s.billboard,h=s.stationary,u=function(e){if(!e._geometry._state.uvBuf)return!1;const t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),c=b(e),p=a.sectionPlanes.length>0,d=x(e),_=!!r.compressGeometry,m=[];m.push("// Drawing vertex shader"),c&&i._normalMap&&m.push("#extension GL_OES_standard_derivatives : enable");t.logarithmicDepthBufferEnabled&&m.push("#extension GL_EXT_frag_depth : enable");m.push("attribute  vec3 position;"),_&&m.push("uniform mat4 positionsDecodeMatrix;");m.push("uniform  mat4 modelMatrix;"),m.push("uniform  mat4 viewMatrix;"),m.push("uniform  mat4 projMatrix;"),m.push("varying  vec3 vViewPosition;"),m.push("uniform  vec3 offset;"),p&&m.push("varying vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(m.push("uniform float logDepthBufFC;"),m.push("varying float vFragDepth;"));o.lightMaps.length>0&&m.push("varying    vec3 vWorldNormal;");if(c){m.push("attribute  vec3 normal;"),m.push("uniform    mat4 modelNormalMatrix;"),m.push("uniform    mat4 viewNormalMatrix;"),m.push("varying    vec3 vViewNormal;");for(let e=0,t=o.lights.length;e<t;e++)l=o.lights[e],"ambient"!==l.type&&("dir"===l.type&&m.push("uniform vec3 lightDir"+e+";"),"point"===l.type&&m.push("uniform vec3 lightPos"+e+";"),"spot"===l.type&&(m.push("uniform vec3 lightPos"+e+";"),m.push("uniform vec3 lightDir"+e+";")),"dir"===l.type&&"view"===l.space||m.push("varying vec4 vViewLightReverseDirAndDist"+e+";"));_&&(m.push("vec3 octDecode(vec2 oct) {"),m.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),m.push("    if (v.z < 0.0) {"),m.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),m.push("    }"),m.push("    return normalize(v);"),m.push("}"))}u&&(m.push("attribute vec2 uv;"),m.push("varying vec2 vUV;"),_&&m.push("uniform mat3 uvDecodeMatrix;"));r.colors&&(m.push("attribute vec4 color;"),m.push("varying vec4 vColor;"));"points"===r.primitiveName&&m.push("uniform float pointSize;");"spherical"!==n&&"cylindrical"!==n||(m.push("void billboard(inout mat4 mat) {"),m.push("   mat[0][0] = 1.0;"),m.push("   mat[0][1] = 0.0;"),m.push("   mat[0][2] = 0.0;"),"spherical"===n&&(m.push("   mat[1][0] = 0.0;"),m.push("   mat[1][1] = 1.0;"),m.push("   mat[1][2] = 0.0;")),m.push("   mat[2][0] = 0.0;"),m.push("   mat[2][1] = 0.0;"),m.push("   mat[2][2] =1.0;"),m.push("}"));if(d){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(m.push("uniform mat4 shadowViewMatrix"+e+";"),m.push("uniform mat4 shadowProjMatrix"+e+";"),m.push("varying vec4 vShadowPosFromLight"+e+";"))}m.push("void main(void) {"),m.push("vec4 localPosition = vec4(position, 1.0); "),m.push("vec4 worldPosition;"),_&&m.push("localPosition = positionsDecodeMatrix * localPosition;");c&&(_?m.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):m.push("vec4 localNormal = vec4(normal, 0.0); "),m.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),m.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));m.push("mat4 viewMatrix2           = viewMatrix;"),m.push("mat4 modelMatrix2          = modelMatrix;"),h&&m.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(m.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),m.push("billboard(modelMatrix2);"),m.push("billboard(viewMatrix2);"),m.push("billboard(modelViewMatrix);"),c&&(m.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),m.push("billboard(modelNormalMatrix2);"),m.push("billboard(viewNormalMatrix2);"),m.push("billboard(modelViewNormalMatrix);")),m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(c){m.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&m.push("vWorldNormal = worldNormal;"),m.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),m.push("vec3 tmpVec3;"),m.push("float lightDist;");for(let e=0,t=o.lights.length;e<t;e++)l=o.lights[e],"ambient"!==l.type&&("dir"===l.type&&"world"===l.space&&(m.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),m.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===l.type&&("world"===l.space?(m.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")):(m.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")),m.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")))}u&&(_?m.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):m.push("vUV = uv;"));r.colors&&m.push("vColor = color;");"points"===r.primitiveName&&m.push("gl_PointSize = pointSize;");p&&m.push("vWorldPosition = worldPosition;");m.push("   vViewPosition = viewPosition.xyz;"),m.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&m.push("vFragDepth = 1.0 + clipPos.w;");if(m.push("gl_Position = clipPos;"),d){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),m.push("vec4 tempx; ");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&m.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ")}return m.push("}"),m}(e),this.fragment=function(e){const t=e.scene,i=(t.canvas.gl,e._material),s=e._geometry._state,a=e.scene._sectionPlanesState,r=e.scene._lightsState,o=e._material._state,l=a.sectionPlanes.length>0,n=b(e),h=s.uvBuf,u=!1,c="PhongMaterial"===o.type,p="MetallicMaterial"===o.type,d="SpecularMaterial"===o.type,_=x(e),m=(t.gammaInput,t.gammaOutput);const f=[];f.push("// Drawing fragment shader"),t.logarithmicDepthBufferEnabled&&f.push("#extension GL_EXT_frag_depth : enable");n&&i._normalMap&&f.push("#extension GL_OES_standard_derivatives : enable");f.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),f.push("precision highp float;"),f.push("precision highp int;"),f.push("#else"),f.push("precision mediump float;"),f.push("precision mediump int;"),f.push("#endif"),t.logarithmicDepthBufferEnabled&&(f.push("uniform float logDepthBufFC;"),f.push("varying float vFragDepth;"));_&&(f.push("float unpackDepth (vec4 color) {"),f.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),f.push("  return dot(color, bitShift);"),f.push("}"));f.push("uniform float gammaFactor;"),f.push("vec4 linearToLinear( in vec4 value ) {"),f.push("  return value;"),f.push("}"),f.push("vec4 sRGBToLinear( in vec4 value ) {"),f.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),f.push("}"),f.push("vec4 gammaToLinear( in vec4 value) {"),f.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),f.push("}"),m&&(f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}"));if(l){f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;");for(var g=0;g<a.sectionPlanes.length;g++)f.push("uniform bool sectionPlaneActive"+g+";"),f.push("uniform vec3 sectionPlanePos"+g+";"),f.push("uniform vec3 sectionPlaneDir"+g+";")}n&&(r.lightMaps.length>0&&(f.push("uniform samplerCube lightMap;"),f.push("uniform mat4 viewNormalMatrix;")),r.reflectionMaps.length>0&&f.push("uniform samplerCube reflectionMap;"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&f.push("uniform mat4 viewMatrix;"),f.push("#define PI 3.14159265359"),f.push("#define RECIPROCAL_PI 0.31830988618"),f.push("#define RECIPROCAL_PI2 0.15915494"),f.push("#define EPSILON 1e-6"),f.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),f.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),f.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),f.push("}"),f.push("struct IncidentLight {"),f.push("   vec3 color;"),f.push("   vec3 direction;"),f.push("};"),f.push("struct ReflectedLight {"),f.push("   vec3 diffuse;"),f.push("   vec3 specular;"),f.push("};"),f.push("struct Geometry {"),f.push("   vec3 position;"),f.push("   vec3 viewNormal;"),f.push("   vec3 worldNormal;"),f.push("   vec3 viewEyeDir;"),f.push("};"),f.push("struct Material {"),f.push("   vec3    diffuseColor;"),f.push("   float   specularRoughness;"),f.push("   vec3    specularColor;"),f.push("   float   shine;"),f.push("};"),c&&((r.lightMaps.length>0||r.reflectionMaps.length>0)&&(f.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(f.push("   vec3 irradiance = "+v[r.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),f.push("   radiance *= PI;"),f.push("   reflectedLight.specular     += radiance;")),f.push("}")),f.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),f.push("   vec3 irradiance = dotNL * directLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),f.push("}")),(p||d)&&(f.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),f.push("   float r = ggxRoughness + 0.0001;"),f.push("   return (2.0 / (r * r) - 2.0);"),f.push("}"),f.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),f.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),f.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),f.push("}"),r.reflectionMaps.length>0&&(f.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),f.push("   vec3 envMapColor = "+v[r.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),f.push("  return envMapColor;"),f.push("}")),f.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),f.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),f.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),f.push("}"),f.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   return 1.0 / ( gl * gv );"),f.push("}"),f.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   return 0.5 / max( gv + gl, EPSILON );"),f.push("}"),f.push("float D_GGX(const in float alpha, const in float dotNH) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),f.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float alpha = ( roughness * roughness );"),f.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),f.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),f.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),f.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),f.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),f.push("   vec3  F = F_Schlick( specularColor, dotLH );"),f.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),f.push("   float D = D_GGX( alpha, dotNH );"),f.push("   return F * (G * D);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),f.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),f.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),f.push("   vec4 r = roughness * c0 + c1;"),f.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),f.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),f.push("   return specularColor * AB.x + AB.y;"),f.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(f.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(f.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),f.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),f.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),f.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),f.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),f.push("}")),f.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),f.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),f.push("}")));f.push("varying vec3 vViewPosition;"),s.colors&&f.push("varying vec4 vColor;");h&&(n&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&f.push("varying vec2 vUV;");n&&(r.lightMaps.length>0&&f.push("varying vec3 vWorldNormal;"),f.push("varying vec3 vViewNormal;"));o.ambient&&f.push("uniform vec3 materialAmbient;");o.baseColor&&f.push("uniform vec3 materialBaseColor;");void 0!==o.alpha&&null!==o.alpha&&f.push("uniform vec4 materialAlphaModeCutoff;");o.emissive&&f.push("uniform vec3 materialEmissive;");o.diffuse&&f.push("uniform vec3 materialDiffuse;");void 0!==o.glossiness&&null!==o.glossiness&&f.push("uniform float materialGlossiness;");void 0!==o.shininess&&null!==o.shininess&&f.push("uniform float materialShininess;");o.specular&&f.push("uniform vec3 materialSpecular;");void 0!==o.metallic&&null!==o.metallic&&f.push("uniform float materialMetallic;");void 0!==o.roughness&&null!==o.roughness&&f.push("uniform float materialRoughness;");void 0!==o.specularF0&&null!==o.specularF0&&f.push("uniform float materialSpecularF0;");h&&i._ambientMap&&(f.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&f.push("uniform mat4 ambientMapMatrix;"));h&&i._baseColorMap&&(f.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&f.push("uniform mat4 baseColorMapMatrix;"));h&&i._diffuseMap&&(f.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&f.push("uniform mat4 diffuseMapMatrix;"));h&&i._emissiveMap&&(f.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&f.push("uniform mat4 emissiveMapMatrix;"));n&&h&&i._metallicMap&&(f.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&f.push("uniform mat4 metallicMapMatrix;"));n&&h&&i._roughnessMap&&(f.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&f.push("uniform mat4 roughnessMapMatrix;"));n&&h&&i._metallicRoughnessMap&&(f.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&f.push("uniform mat4 metallicRoughnessMapMatrix;"));n&&i._normalMap&&(f.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&f.push("uniform mat4 normalMapMatrix;"),f.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),f.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),f.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),f.push("      vec2 st0 = dFdx( uv.st );"),f.push("      vec2 st1 = dFdy( uv.st );"),f.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),f.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),f.push("      vec3 N = normalize( surf_norm );"),f.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),f.push("      mat3 tsn = mat3( S, T, N );"),f.push("      return normalize( tsn * mapN );"),f.push("}"));h&&i._occlusionMap&&(f.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&f.push("uniform mat4 occlusionMapMatrix;"));h&&i._alphaMap&&(f.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&f.push("uniform mat4 alphaMapMatrix;"));n&&h&&i._specularMap&&(f.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&f.push("uniform mat4 specularMapMatrix;"));n&&h&&i._glossinessMap&&(f.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&f.push("uniform mat4 glossinessMapMatrix;"));n&&h&&i._specularGlossinessMap&&(f.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&f.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));n&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(f.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),f.push("    float fr = abs(dot(eyeDir, normal));"),f.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),f.push("    return pow(finalFr, power);"),f.push("}"),i._diffuseFresnel&&(f.push("uniform float  diffuseFresnelCenterBias;"),f.push("uniform float  diffuseFresnelEdgeBias;"),f.push("uniform float  diffuseFresnelPower;"),f.push("uniform vec3   diffuseFresnelCenterColor;"),f.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(f.push("uniform float  specularFresnelCenterBias;"),f.push("uniform float  specularFresnelEdgeBias;"),f.push("uniform float  specularFresnelPower;"),f.push("uniform vec3   specularFresnelCenterColor;"),f.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(f.push("uniform float  alphaFresnelCenterBias;"),f.push("uniform float  alphaFresnelEdgeBias;"),f.push("uniform float  alphaFresnelPower;"),f.push("uniform vec3   alphaFresnelCenterColor;"),f.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(f.push("uniform float  materialSpecularF0FresnelCenterBias;"),f.push("uniform float  materialSpecularF0FresnelEdgeBias;"),f.push("uniform float  materialSpecularF0FresnelPower;"),f.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),f.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(f.push("uniform float  emissiveFresnelCenterBias;"),f.push("uniform float  emissiveFresnelEdgeBias;"),f.push("uniform float  emissiveFresnelPower;"),f.push("uniform vec3   emissiveFresnelCenterColor;"),f.push("uniform vec3   emissiveFresnelEdgeColor;")));if(f.push("uniform vec4   lightAmbient;"),n)for(let M=0,v=r.lights.length;M<v;M++){const e=r.lights[M];"ambient"!==e.type&&(f.push("uniform vec4 lightColor"+M+";"),"point"===e.type&&f.push("uniform vec3 lightAttenuation"+M+";"),"dir"===e.type&&"view"===e.space&&f.push("uniform vec3 lightDir"+M+";"),"point"===e.type&&"view"===e.space?f.push("uniform vec3 lightPos"+M+";"):f.push("varying vec4 vViewLightReverseDirAndDist"+M+";"))}if(_)for(let M=0,v=r.lights.length;M<v;M++)r.lights[M].castsShadow&&(f.push("varying vec4 vShadowPosFromLight"+M+";"),f.push("uniform sampler2D shadowMap"+M+";"));if(f.push("uniform vec4 colorize;"),f.push("void main(void) {"),l){f.push("if (clippable) {"),f.push("  float dist = 0.0;");for(g=0;g<a.sectionPlanes.length;g++)f.push("if (sectionPlaneActive"+g+") {"),f.push("   dist += clamp(dot(-sectionPlaneDir"+g+".xyz, vWorldPosition.xyz - sectionPlanePos"+g+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),u&&(f.push("  if (gl_FrontFacing == false) {"),f.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),f.push("     return;"),f.push("  }")),f.push("}")}"points"===s.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}"));f.push("float occlusion = 1.0;"),o.ambient?f.push("vec3 ambientColor = materialAmbient;"):f.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");o.diffuse?f.push("vec3 diffuseColor = materialDiffuse;"):o.baseColor?f.push("vec3 diffuseColor = materialBaseColor;"):f.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");s.colors&&f.push("diffuseColor *= vColor.rgb;");o.emissive?f.push("vec3 emissiveColor = materialEmissive;"):f.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");o.specular?f.push("vec3 specular = materialSpecular;"):f.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==o.alpha?f.push("float alpha = materialAlphaModeCutoff[0];"):f.push("float alpha = 1.0;");s.colors&&f.push("alpha *= vColor.a;");void 0!==o.glossiness?f.push("float glossiness = materialGlossiness;"):f.push("float glossiness = 1.0;");void 0!==o.metallic?f.push("float metallic = materialMetallic;"):f.push("float metallic = 1.0;");void 0!==o.roughness?f.push("float roughness = materialRoughness;"):f.push("float roughness = 1.0;");void 0!==o.specularF0?f.push("float specularF0 = materialSpecularF0;"):f.push("float specularF0 = 1.0;");h&&(n&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(f.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),f.push("vec2 textureCoord;"));h&&i._ambientMap&&(i._ambientMap._state.matrix?f.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),f.push("ambientTexel = "+v[i._ambientMap._state.encoding]+"(ambientTexel);"),f.push("ambientColor *= ambientTexel.rgb;"));h&&i._diffuseMap&&(i._diffuseMap._state.matrix?f.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),f.push("diffuseTexel = "+v[i._diffuseMap._state.encoding]+"(diffuseTexel);"),f.push("diffuseColor *= diffuseTexel.rgb;"),f.push("alpha *= diffuseTexel.a;"));h&&i._baseColorMap&&(i._baseColorMap._state.matrix?f.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),f.push("baseColorTexel = "+v[i._baseColorMap._state.encoding]+"(baseColorTexel);"),f.push("diffuseColor *= baseColorTexel.rgb;"),f.push("alpha *= baseColorTexel.a;"));h&&i._emissiveMap&&(i._emissiveMap._state.matrix?f.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),f.push("emissiveTexel = "+v[i._emissiveMap._state.encoding]+"(emissiveTexel);"),f.push("emissiveColor = emissiveTexel.rgb;"));h&&i._alphaMap&&(i._alphaMap._state.matrix?f.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("alpha *= texture2D(alphaMap, textureCoord).r;"));h&&i._occlusionMap&&(i._occlusionMap._state.matrix?f.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(n&&(r.lights.length>0||r.lightMaps.length>0||r.reflectionMaps.length>0)){h&&i._normalMap?(i._normalMap._state.matrix?f.push("textureCoord = (normalMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):f.push("vec3 viewNormal = normalize(vViewNormal);"),h&&i._specularMap&&(i._specularMap._state.matrix?f.push("textureCoord = (specularMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("specular *= texture2D(specularMap, textureCoord).rgb;")),h&&i._glossinessMap&&(i._glossinessMap._state.matrix?f.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),h&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?f.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),f.push("specular *= specGlossRGB.rgb;"),f.push("glossiness *= specGlossRGB.a;")),h&&i._metallicMap&&(i._metallicMap._state.matrix?f.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("metallic *= texture2D(metallicMap, textureCoord).r;")),h&&i._roughnessMap&&(i._roughnessMap._state.matrix?f.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),h&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?f.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),f.push("metallic *= metalRoughRGB.b;"),f.push("roughness *= metalRoughRGB.g;")),f.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(f.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),f.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(f.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),f.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(f.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),f.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(f.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),f.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),f.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),f.push("   discard;"),f.push("}"),f.push("IncidentLight  light;"),f.push("Material       material;"),f.push("Geometry       geometry;"),f.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),f.push("vec3           viewLightDir;"),c&&(f.push("material.diffuseColor      = diffuseColor;"),f.push("material.specularColor     = specular;"),f.push("material.shine             = materialShininess;")),d&&(f.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),f.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),f.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),f.push("material.specularColor     = specular;")),p&&(f.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),f.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),f.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),f.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),f.push("geometry.position      = vViewPosition;"),r.lightMaps.length>0&&f.push("geometry.worldNormal   = normalize(vWorldNormal);"),f.push("geometry.viewNormal    = viewNormal;"),f.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(r.lightMaps.length>0||r.reflectionMaps.length>0)&&f.push("computePhongLightMapping(geometry, material, reflectedLight);"),(d||p)&&(r.lightMaps.length>0||r.reflectionMaps.length>0)&&f.push("computePBRLightMapping(geometry, material, reflectedLight);"),f.push("float shadow = 1.0;"),f.push("float shadowAcneRemover = 0.007;"),f.push("vec3 fragmentDepth;"),f.push("float texelSize = 1.0 / 1024.0;"),f.push("float amountInLight = 0.0;"),f.push("vec3 shadowCoord;"),f.push("vec4 rgbaDepth;"),f.push("float depth;");for(let e=0,t=r.lights.length;e<t;e++){const t=r.lights[e];"ambient"!==t.type&&("dir"===t.type&&"view"===t.space?f.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===t.type&&"view"===t.space?f.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):f.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),_&&t.castsShadow?(f.push("shadow = 0.0;"),f.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),f.push("fragmentDepth.z -= shadowAcneRemover;"),f.push("for (int x = -3; x <= 3; x++) {"),f.push("  for (int y = -3; y <= 3; y++) {"),f.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),f.push("      if (fragmentDepth.z < texelDepth) {"),f.push("          shadow += 1.0;"),f.push("      }"),f.push("  }"),f.push("}"),f.push("shadow = shadow / 9.0;"),f.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * shadow);")):f.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),f.push("light.direction = viewLightDir;"),c&&f.push("computePhongLighting(light, geometry, material, reflectedLight);"),(d||p)&&f.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?f.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):f.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else f.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),f.push("vec3 outgoingLight = emissiveColor + ambientColor;");f.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),m&&f.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");t.logarithmicDepthBufferEnabled&&f.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return f.push("}"),f}(e))},v={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function x(e){if(!e.receivesShadow)return!1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(let i=0,s=t.length;i<s;i++)if(t[i].castsShadow)return!0;return!1}function b(e){const t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}var P=i("mrKj"),y=i("hEnr"),w=i("bFGi"),C=i("pVQg");const E=r.a.vec3(),D=new g.a({}),S=function(e,t){this.id=D.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new M(t),this._allocate(t)},L={};S.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";");let s=L[i];if(!s){if(s=new S(i,e),s.errors)return console.log(s.errors.join("\n")),null;L[i]=s,y.a.memory.programs++}return s._useCount++,s},S.prototype.put=function(){0===--this._useCount&&(D.removeItem(this.id),this._program&&this._program.destroy(),delete L[this._hash],y.a.memory.programs--)},S.prototype.webglContextRestored=function(){this._program=null},S.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=w.a.MAX_TEXTURE_UNITS,s=t.scene,a=t._material,r=s.canvas.gl,o=this._program,l=t._state,n=t._material._state,h=t._geometry._state,u=s.camera,c=t.rtcCenter;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(l.rtcCenterHash,c):u.viewMatrix),r.uniformMatrix4fv(this._uViewNormalMatrix,!1,u.viewNormalMatrix),l.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,a=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],s=a.sectionPlanesActivePerLayer[t];if(r.uniform1i(e.active,s?1:0),s){const s=i[t];r.uniform3fv(e.pos,c?Object(C.b)(s.dist,s.dir,c,E):s.pos),r.uniform3fv(e.dir,s.dir)}}}}if(n.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=n.backfaces;e.backfaces!==t&&(t?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=t);const s=n.frontface;switch(e.frontface!==s&&(s?r.frontFace(r.CCW):r.frontFace(r.CW),e.frontface=s),e.lineWidth!==n.lineWidth&&(r.lineWidth(n.lineWidth),e.lineWidth=n.lineWidth),this._uPointSize&&r.uniform1f(this._uPointSize,n.pointSize),n.type){case"LambertMaterial":this._uMaterialAmbient&&r.uniform3fv(this._uMaterialAmbient,n.ambient),this._uMaterialColor&&r.uniform4f(this._uMaterialColor,n.color[0],n.color[1],n.color[2],n.alpha),this._uMaterialEmissive&&r.uniform3fv(this._uMaterialEmissive,n.emissive);break;case"PhongMaterial":this._uMaterialShininess&&r.uniform1f(this._uMaterialShininess,n.shininess),this._uMaterialAmbient&&r.uniform3fv(this._uMaterialAmbient,n.ambient),this._uMaterialDiffuse&&r.uniform3fv(this._uMaterialDiffuse,n.diffuse),this._uMaterialSpecular&&r.uniform3fv(this._uMaterialSpecular,n.specular),this._uMaterialEmissive&&r.uniform3fv(this._uMaterialEmissive,n.emissive),this._uAlphaModeCutoff&&r.uniform4f(this._uAlphaModeCutoff,1*n.alpha,1===n.alphaMode?1:0,n.alphaCutoff,0),a._ambientMap&&a._ambientMap._state.texture&&this._uMaterialAmbientMap&&(o.bindTexture(this._uMaterialAmbientMap,a._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&r.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,a._ambientMap._state.matrix)),a._diffuseMap&&a._diffuseMap._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,a._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&r.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,a._diffuseMap._state.matrix)),a._specularMap&&a._specularMap._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,a._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&r.uniformMatrix4fv(this._uSpecularMapMatrix,!1,a._specularMap._state.matrix)),a._emissiveMap&&a._emissiveMap._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,a._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&r.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,a._emissiveMap._state.matrix)),a._alphaMap&&a._alphaMap._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,a._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&r.uniformMatrix4fv(this._uAlphaMapMatrix,!1,a._alphaMap._state.matrix)),a._reflectivityMap&&a._reflectivityMap._state.texture&&this._uReflectivityMap&&(o.bindTexture(this._uReflectivityMap,a._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&r.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,a._reflectivityMap._state.matrix)),a._normalMap&&a._normalMap._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,a._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&r.uniformMatrix4fv(this._uNormalMapMatrix,!1,a._normalMap._state.matrix)),a._occlusionMap&&a._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,a._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&r.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,a._occlusionMap._state.matrix)),a._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&r.uniform1f(this._uDiffuseFresnelEdgeBias,a._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&r.uniform1f(this._uDiffuseFresnelCenterBias,a._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&r.uniform3fv(this._uDiffuseFresnelEdgeColor,a._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&r.uniform3fv(this._uDiffuseFresnelCenterColor,a._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&r.uniform1f(this._uDiffuseFresnelPower,a._diffuseFresnel.power)),a._specularFresnel&&(this._uSpecularFresnelEdgeBias&&r.uniform1f(this._uSpecularFresnelEdgeBias,a._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&r.uniform1f(this._uSpecularFresnelCenterBias,a._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&r.uniform3fv(this._uSpecularFresnelEdgeColor,a._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&r.uniform3fv(this._uSpecularFresnelCenterColor,a._specularFresnel.centerColor),this._uSpecularFresnelPower&&r.uniform1f(this._uSpecularFresnelPower,a._specularFresnel.power)),a._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&r.uniform1f(this._uAlphaFresnelEdgeBias,a._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&r.uniform1f(this._uAlphaFresnelCenterBias,a._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&r.uniform3fv(this._uAlphaFresnelEdgeColor,a._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&r.uniform3fv(this._uAlphaFresnelCenterColor,a._alphaFresnel.centerColor),this._uAlphaFresnelPower&&r.uniform1f(this._uAlphaFresnelPower,a._alphaFresnel.power)),a._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&r.uniform1f(this._uReflectivityFresnelEdgeBias,a._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&r.uniform1f(this._uReflectivityFresnelCenterBias,a._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&r.uniform3fv(this._uReflectivityFresnelEdgeColor,a._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&r.uniform3fv(this._uReflectivityFresnelCenterColor,a._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&r.uniform1f(this._uReflectivityFresnelPower,a._reflectivityFresnel.power)),a._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&r.uniform1f(this._uEmissiveFresnelEdgeBias,a._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&r.uniform1f(this._uEmissiveFresnelCenterBias,a._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&r.uniform3fv(this._uEmissiveFresnelEdgeColor,a._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&r.uniform3fv(this._uEmissiveFresnelCenterColor,a._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&r.uniform1f(this._uEmissiveFresnelPower,a._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&r.uniform3fv(this._uBaseColor,n.baseColor),this._uMaterialMetallic&&r.uniform1f(this._uMaterialMetallic,n.metallic),this._uMaterialRoughness&&r.uniform1f(this._uMaterialRoughness,n.roughness),this._uMaterialSpecularF0&&r.uniform1f(this._uMaterialSpecularF0,n.specularF0),this._uMaterialEmissive&&r.uniform3fv(this._uMaterialEmissive,n.emissive),this._uAlphaModeCutoff&&r.uniform4f(this._uAlphaModeCutoff,1*n.alpha,1===n.alphaMode?1:0,n.alphaCutoff,0);const t=a._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(o.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&r.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const s=a._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(o.bindTexture(this._uMetallicMap,s._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&r.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const l=a._roughnessMap;l&&l._state.texture&&this._uRoughnessMap&&(o.bindTexture(this._uRoughnessMap,l._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&r.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,l._state.matrix));const h=a._metallicRoughnessMap;h&&h._state.texture&&this._uMetallicRoughnessMap&&(o.bindTexture(this._uMetallicRoughnessMap,h._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&r.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,h._state.matrix)),(p=a._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&r.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(d=a._occlusionMap)&&a._occlusionMap._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&r.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,d._state.matrix)),(_=a._alphaMap)&&_._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&r.uniformMatrix4fv(this._uAlphaMapMatrix,!1,_._state.matrix)),(m=a._normalMap)&&m._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&r.uniformMatrix4fv(this._uNormalMapMatrix,!1,m._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&r.uniform3fv(this._uMaterialDiffuse,n.diffuse),this._uMaterialSpecular&&r.uniform3fv(this._uMaterialSpecular,n.specular),this._uMaterialGlossiness&&r.uniform1f(this._uMaterialGlossiness,n.glossiness),this._uMaterialReflectivity&&r.uniform1f(this._uMaterialReflectivity,n.reflectivity),this._uMaterialEmissive&&r.uniform3fv(this._uMaterialEmissive,n.emissive),this._uAlphaModeCutoff&&r.uniform4f(this._uAlphaModeCutoff,1*n.alpha,1===n.alphaMode?1:0,n.alphaCutoff,0);const u=a._diffuseMap;u&&u._state.texture&&this._uDiffuseMap&&(o.bindTexture(this._uDiffuseMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&r.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,u._state.matrix));const c=a._specularMap;c&&c._state.texture&&this._uSpecularMap&&(o.bindTexture(this._uSpecularMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&r.uniformMatrix4fv(this._uSpecularMapMatrix,!1,c._state.matrix));const f=a._glossinessMap;f&&f._state.texture&&this._uGlossinessMap&&(o.bindTexture(this._uGlossinessMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&r.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,f._state.matrix));const g=a._specularGlossinessMap;var p,d,_,m;g&&g._state.texture&&this._uSpecularGlossinessMap&&(o.bindTexture(this._uSpecularGlossinessMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&r.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,g._state.matrix)),(p=a._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(o.bindTexture(this._uEmissiveMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&r.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(d=a._occlusionMap)&&d._state.texture&&this._uOcclusionMap&&(o.bindTexture(this._uOcclusionMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&r.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,d._state.matrix)),(_=a._alphaMap)&&_._state.texture&&this._uAlphaMap&&(o.bindTexture(this._uAlphaMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&r.uniformMatrix4fv(this._uAlphaMapMatrix,!1,_._state.matrix)),(m=a._normalMap)&&m._state.texture&&this._uNormalMap&&(o.bindTexture(this._uNormalMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&r.uniformMatrix4fv(this._uNormalMapMatrix,!1,m._state.matrix))}this._lastMaterialId=n.id}if(r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,t.worldMatrix),this._uModelNormalMatrix&&r.uniformMatrix4fv(this._uModelNormalMatrix,r.FALSE,t.worldNormalMatrix),this._uClippable&&r.uniform1i(this._uClippable,l.clippable),this._uColorize){const e=l.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(r.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3])}r.uniform3fv(this._uOffset,l.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&r.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),e.bindArray++),h.indicesBuf&&(h.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=h.id),h.indicesBuf?(r.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positions&&(r.drawArrays(r.TRIANGLES,0,h.positions.numItems),e.drawArrays++)},S.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=e._material,a=t._lightsState,r=t._sectionPlanesState,o=e._material._state;if(this._program=new P.a(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const l=this._program;this._uPositionsDecodeMatrix=l.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=l.getLocation("uvDecodeMatrix"),this._uModelMatrix=l.getLocation("modelMatrix"),this._uModelNormalMatrix=l.getLocation("modelNormalMatrix"),this._uViewMatrix=l.getLocation("viewMatrix"),this._uViewNormalMatrix=l.getLocation("viewNormalMatrix"),this._uProjMatrix=l.getLocation("projMatrix"),this._uGammaFactor=l.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=l.getLocation("logDepthBufFC"));const n=a.lights;let h;for(var u=0,c=n.length;u<c;u++){switch(h=n[u],h.type){case"ambient":this._uLightAmbient[u]=l.getLocation("lightAmbient");break;case"dir":this._uLightColor[u]=l.getLocation("lightColor"+u),this._uLightPos[u]=null,this._uLightDir[u]=l.getLocation("lightDir"+u);break;case"point":this._uLightColor[u]=l.getLocation("lightColor"+u),this._uLightPos[u]=l.getLocation("lightPos"+u),this._uLightDir[u]=null,this._uLightAttenuation[u]=l.getLocation("lightAttenuation"+u);break;case"spot":this._uLightColor[u]=l.getLocation("lightColor"+u),this._uLightPos[u]=l.getLocation("lightPos"+u),this._uLightDir[u]=l.getLocation("lightDir"+u),this._uLightAttenuation[u]=l.getLocation("lightAttenuation"+u)}h.castsShadow&&(this._uShadowViewMatrix[u]=l.getLocation("shadowViewMatrix"+u),this._uShadowProjMatrix[u]=l.getLocation("shadowProjMatrix"+u))}a.lightMaps.length>0&&(this._uLightMap="lightMap"),a.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(u=0,c=r.sectionPlanes.length;u<c;u++)this._uSectionPlanes.push({active:l.getLocation("sectionPlaneActive"+u),pos:l.getLocation("sectionPlanePos"+u),dir:l.getLocation("sectionPlaneDir"+u)});switch(this._uPointSize=l.getLocation("pointSize"),o.type){case"LambertMaterial":this._uMaterialColor=l.getLocation("materialColor"),this._uMaterialEmissive=l.getLocation("materialEmissive"),this._uAlphaModeCutoff=l.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=l.getLocation("materialAmbient"),this._uMaterialDiffuse=l.getLocation("materialDiffuse"),this._uMaterialSpecular=l.getLocation("materialSpecular"),this._uMaterialEmissive=l.getLocation("materialEmissive"),this._uAlphaModeCutoff=l.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=l.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=l.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=l.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=l.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=l.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=l.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=l.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=l.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=l.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=l.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=l.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=l.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=l.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=l.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=l.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=l.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=l.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=l.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=l.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=l.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=l.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=l.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=l.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=l.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=l.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=l.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=l.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=l.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=l.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=l.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=l.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=l.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=l.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=l.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=l.getLocation("materialBaseColor"),this._uMaterialMetallic=l.getLocation("materialMetallic"),this._uMaterialRoughness=l.getLocation("materialRoughness"),this._uMaterialSpecularF0=l.getLocation("materialSpecularF0"),this._uMaterialEmissive=l.getLocation("materialEmissive"),this._uAlphaModeCutoff=l.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=l.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=l.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=l.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=l.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=l.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=l.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=l.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=l.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=l.getLocation("materialDiffuse"),this._uMaterialSpecular=l.getLocation("materialSpecular"),this._uMaterialGlossiness=l.getLocation("materialGlossiness"),this._uMaterialReflectivity=l.getLocation("reflectivityFresnel"),this._uMaterialEmissive=l.getLocation("materialEmissive"),this._uAlphaModeCutoff=l.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=l.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=l.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=l.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=l.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=l.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=l.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=l.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=l.getLocation("normalMapMatrix"))}this._aPosition=l.getAttribute("position"),this._aNormal=l.getAttribute("normal"),this._aUV=l.getAttribute("uv"),this._aColor=l.getAttribute("color"),this._aFlags=l.getAttribute("flags"),this._uClippable=l.getLocation("clippable"),this._uColorize=l.getLocation("colorize"),this._uOffset=l.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},S.prototype._bindProgram=function(e){const t=w.a.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,a=i._lightsState,r=i.camera.project;let o;const l=this._program;if(l.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}for(var n=0,h=a.lights.length;n<h;n++)if(o=a.lights[n],this._uLightAmbient[n])s.uniform4f(this._uLightAmbient[n],o.color[0],o.color[1],o.color[2],o.intensity);else if(this._uLightColor[n]&&s.uniform4f(this._uLightColor[n],o.color[0],o.color[1],o.color[2],o.intensity),this._uLightPos[n]&&(s.uniform3fv(this._uLightPos[n],o.pos),this._uLightAttenuation[n]&&s.uniform1f(this._uLightAttenuation[n],o.attenuation)),this._uLightDir[n]&&s.uniform3fv(this._uLightDir[n],o.dir),o.castsShadow){this._uShadowViewMatrix[n]&&s.uniformMatrix4fv(this._uShadowViewMatrix[n],!1,o.getShadowViewMatrix()),this._uShadowProjMatrix[n]&&s.uniformMatrix4fv(this._uShadowProjMatrix[n],!1,o.getShadowProjMatrix());const i=o.getShadowRenderBuf();i&&(l.bindTexture("shadowMap"+n,i.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++)}a.lightMaps.length>0&&a.lightMaps[0].texture&&this._uLightMap&&(l.bindTexture(this._uLightMap,a.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),a.reflectionMaps.length>0&&a.reflectionMaps[0].texture&&this._uReflectionMap&&(l.bindTexture(this._uReflectionMap,a.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=e.textureUnit};class F{constructor(e){this.vertex=function(e){const t=e.scene,i=t._lightsState,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),a=t._sectionPlanesState.sectionPlanes.length>0,r=!!e._geometry._state.compressGeometry,o=e._state.billboard,l=e._state.stationary,n=[];n.push("// EmphasisFillShaderSource vertex shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable");n.push("attribute vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec4 colorize;"),n.push("uniform vec3 offset;"),r&&n.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("varying float vFragDepth;"));a&&n.push("varying vec4 vWorldPosition;");if(n.push("uniform vec4   lightAmbient;"),n.push("uniform vec4   fillColor;"),s){n.push("attribute vec3 normal;"),n.push("uniform mat4 modelNormalMatrix;"),n.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&n.push("uniform vec3 lightPos"+e+";"))}r&&(n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"))}n.push("varying vec4 vColor;"),("spherical"===o||"cylindrical"===o)&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===o&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),r&&n.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(r?n.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):n.push("vec4 localNormal = vec4(normal, 0.0); "),n.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),n.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),l&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),s&&(n.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),n.push("billboard(modelNormalMatrix2);"),n.push("billboard(viewNormalMatrix2);"),n.push("billboard(modelViewNormalMatrix);")),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&n.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),s)for(let h=0,u=i.lights.length;h<u;h++){const e=i.lights[h];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?n.push("viewLightDir = normalize(lightDir"+h+");"):n.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else{if("point"!==e.type)continue;"view"===e.space?n.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):n.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}n.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),a&&n.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&n.push("gl_PointSize = pointSize;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?n.push("vFragDepth = 1.0 + clipPos.w;"):(n.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),n.push("clipPos.z *= clipPos.w;")));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,a=i.sectionPlanes.length>0,r=[];r.push("// Lambertian drawing fragment shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));s&&(r.push("uniform float gammaFactor;"),r.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),r.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),r.push("}"));if(a){r.push("varying vec4 vWorldPosition;"),r.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),a){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}"points"===e._geometry._state.primitiveName&&(r.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("float r = dot(cxy, cxy);"),r.push("if (r > 1.0) {"),r.push("   discard;"),r.push("}"));t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");s?r.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):r.push("gl_FragColor = vColor;");return r.push("}"),r}(e)}}const A=new g.a({}),R=r.a.vec3(),T=function(e,t){this.id=A.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new F(t),this._allocate(t)},B={};T.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=B[t];return i||(i=new T(t,e),B[t]=i,y.a.memory.programs++),i._useCount++,i},T.prototype.put=function(){0===--this._useCount&&(A.removeItem(this.id),this._program&&this._program.destroy(),delete B[this._hash],y.a.memory.programs--)},T.prototype.webglContextRestored=function(){this._program=null},T.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,a=s.camera,r=s.canvas.gl,o=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,l=t._state,n=t._geometry._state,h=t.rtcCenter;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uViewMatrix,!1,h?e.getRTCViewMatrix(l.rtcCenterHash,h):a.viewMatrix),r.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),l.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,a=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],s=a.sectionPlanesActivePerLayer[t];if(r.uniform1i(e.active,s?1:0),s){const s=i[t];r.uniform3fv(e.pos,h?Object(C.b)(s.dist,s.dir,h,R):s.pos),r.uniform3fv(e.dir,s.dir)}}}}if(o.id!==this._lastMaterialId){const t=o.fillColor,i=o.backfaces;e.backfaces!==i&&(i?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=i),r.uniform4f(this._uFillColor,t[0],t[1],t[2],o.fillAlpha),this._lastMaterialId=o.id}r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,t.worldMatrix),this._uModelNormalMatrix&&r.uniformMatrix4fv(this._uModelNormalMatrix,r.FALSE,t.worldNormalMatrix),this._uClippable&&r.uniform1i(this._uClippable,l.clippable),r.uniform3fv(this._uOffset,l.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._uUVDecodeMatrix&&r.uniformMatrix3fv(this._uUVDecodeMatrix,!1,n.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(n.normalsBuf),e.bindArray++),n.indicesBuf?(n.indicesBuf.bind(),e.bindArray++):n.positionsBuf,this._lastGeometryId=n.id),n.indicesBuf?(r.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positionsBuf&&(r.drawArrays(r.TRIANGLES,0,n.positionsBuf.numItems),e.drawArrays++)},T.prototype._allocate=function(e){const t=e.scene,i=t._lightsState,s=t._sectionPlanesState,a=t.canvas.gl;if(this._program=new P.a(a,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uModelNormalMatrix=r.getLocation("modelNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let o=0,l=i.lights.length;o<l;o++){switch(i.lights[o].type){case"ambient":this._uLightAmbient[o]=r.getLocation("lightAmbient");break;case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}}this._uSectionPlanes=[];for(let o=0,l=s.sectionPlanes.length;o<l;o++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+o),pos:r.getLocation("sectionPlanePos"+o),dir:r.getLocation("sectionPlaneDir"+o)});this._uFillColor=r.getLocation("fillColor"),this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},T.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState,a=t.camera,r=a.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}for(let o=0,l=s.lights.length;o<l;o++){const e=s.lights[o];this._uLightAmbient[o]?i.uniform4f(this._uLightAmbient[o],e.color[0],e.color[1],e.color[2],e.intensity):(this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],e.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],e.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],e.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class N{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,a=e._state.billboard,r=e._state.stationary,o=[];o.push("// Edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("attribute vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec4 edgeColor;"),o.push("uniform vec3 offset;"),s&&o.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"));i&&o.push("varying vec4 vWorldPosition;");o.push("varying vec4 vColor;"),("spherical"===a||"cylindrical"===a)&&(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = 1.0;"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===a&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = 1.0;"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),o.push("vec4 worldPosition;"),s&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),r&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===a||"cylindrical"===a?(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"),o.push("billboard(modelViewMatrix);"),o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(o.push("worldPosition = modelMatrix2 * localPosition;"),o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));o.push("vColor = edgeColor;"),i&&o.push("vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")));return o.push("gl_Position = clipPos;"),o.push("}"),o}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,a=i.sectionPlanes.length>0,r=[];r.push("// Edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));s&&(r.push("uniform float gammaFactor;"),r.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),r.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),r.push("}"));if(a){r.push("varying vec4 vWorldPosition;"),r.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),a){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");s?r.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):r.push("gl_FragColor = vColor;");return r.push("}"),r}(e)}}const I=new g.a({}),U=r.a.vec3(),O=function(e,t){this.id=I.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new N(t),this._allocate(t)},G={};O.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=G[t];return i||(i=new O(t,e),G[t]=i,y.a.memory.programs++),i._useCount++,i},O.prototype.put=function(){0===--this._useCount&&(I.removeItem(this.id),this._program&&this._program.destroy(),delete G[this._hash],y.a.memory.programs--)},O.prototype.webglContextRestored=function(){this._program=null},O.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,a=s.camera,r=s.canvas.gl;let o;const l=t._state,n=t._geometry,h=n._state,u=t.rtcCenter;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.uniformMatrix4fv(this._uViewMatrix,!1,u?e.getRTCViewMatrix(l.rtcCenterHash,u):a.viewMatrix),l.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,a=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],s=a.sectionPlanesActivePerLayer[t];if(r.uniform1i(e.active,s?1:0),s){const s=i[t];r.uniform3fv(e.pos,u?Object(C.b)(s.dist,s.dir,u,U):s.pos),r.uniform3fv(e.dir,s.dir)}}}}switch(i){case 0:o=t._xrayMaterial._state;break;case 1:o=t._highlightMaterial._state;break;case 2:o=t._selectedMaterial._state;break;case 3:default:o=t._edgeMaterial._state}if(o.id!==this._lastMaterialId){const t=o.backfaces;if(e.backfaces!==t&&(t?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=t),e.lineWidth!==o.edgeWidth&&(r.lineWidth(o.edgeWidth),e.lineWidth=o.edgeWidth),this._uEdgeColor){const e=o.edgeColor,t=o.edgeAlpha;r.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t)}this._lastMaterialId=o.id}let c;r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,t.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,l.clippable),r.uniform3fv(this._uOffset,l.offset),h.primitive===r.TRIANGLES?c=n._getEdgeIndices():h.primitive===r.LINES&&(c=h.indicesBuf),c&&(h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),e.bindArray++),c.bind(),e.bindArray++,this._lastGeometryId=h.id),r.drawElements(r.LINES,c.numItems,c.itemType,0),e.drawElements++)},O.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new P.a(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uSectionPlanes=[];for(let r=0,o=s.sectionPlanes.length;r<o;r++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+r),pos:a.getLocation("sectionPlanePos"+r),dir:a.getLocation("sectionPlaneDir"+r)});this._uEdgeColor=a.getLocation("edgeColor"),this._aPosition=a.getAttribute("position"),this._uClippable=a.getLocation("clippable"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uOffset=a.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},O.prototype._bindProgram=function(e){const t=this._program,i=this._scene,s=i.canvas.gl,a=i.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(a.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class z{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,a=e._state.billboard,r=e._state.stationary,o=[];o.push("// Mesh picking vertex shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("attribute vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("varying vec4 vViewPosition;"),o.push("uniform vec3 offset;"),s&&o.push("uniform mat4 positionsDecodeMatrix;");i&&o.push("varying vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"));"spherical"!==a&&"cylindrical"!==a||(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = 1.0;"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===a&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = 1.0;"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),s&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),r&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==a&&"cylindrical"!==a||(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"));o.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&o.push("   vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")));return o.push("gl_Position = clipPos;"),o.push("}"),o}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,a=[];a.push("// Mesh picking fragment shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));if(a.push("uniform vec4 pickColor;"),s){a.push("uniform bool clippable;"),a.push("varying vec4 vWorldPosition;");for(var r=0;r<i.sectionPlanes.length;r++)a.push("uniform bool sectionPlaneActive"+r+";"),a.push("uniform vec3 sectionPlanePos"+r+";"),a.push("uniform vec3 sectionPlaneDir"+r+";")}if(a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(r=0;r<i.sectionPlanes.length;r++)a.push("if (sectionPlaneActive"+r+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return a.push("   gl_FragColor = pickColor; "),a.push("}"),a}(e)}}const V=r.a.vec3(),k=function(e,t){this._hash=e,this._shaderSource=new z(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},X={};k.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=X[t];if(!i){if(i=new k(t,e),i.errors)return console.log(i.errors.join("\n")),null;X[t]=i,y.a.memory.programs++}return i._useCount++,i},k.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete X[this._hash],y.a.memory.programs--)},k.prototype.webglContextRestored=function(){this._program=null},k.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,a=t._state,r=t._material._state,o=t._geometry._state,l=t.rtcCenter;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCPickViewMatrix(a.rtcCenterHash,l):e.pickViewMatrix),a.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const a=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],i=r.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=a[t];s.uniform3fv(e.pos,l?Object(C.b)(i.dist,i.dir,l,V):i.pos),s.uniform3fv(e.dir,i.dir)}}}}if(r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=r.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=r.id}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=o.id);var n=t._state.pickID;const h=n>>24&255,u=n>>16&255,c=n>>8&255,p=255&n;s.uniform4f(this._uPickColor,p/255,c/255,u/255,h/255),o.indicesBuf?(s.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&s.drawArrays(s.TRIANGLES,0,o.positions.numItems)},k.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new P.a(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let a=0,r=t._sectionPlanesState.sectionPlanes.length;a<r;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null},k.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastGeometryId=null};class j{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,a=(e._state.billboard,e._state.stationary,[]);a.push("// Surface picking vertex shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("attribute vec4 color;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),i&&(a.push("uniform bool clippable;"),a.push("varying vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));a.push("varying vec4 vColor;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("   vec4 worldPosition = modelMatrix * localPosition; "),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("   vColor = color;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,a=[];a.push("// Surface picking fragment shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),a.push("varying vec4 vColor;"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));if(s){a.push("uniform bool clippable;"),a.push("varying vec4 vWorldPosition;");for(let e=0;e<i.sectionPlanes.length;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";")}if(a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(let e=0;e<i.sectionPlanes.length;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return a.push("   gl_FragColor = vColor;"),a.push("}"),a}(e)}}const W=r.a.vec3(),H=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new j(t),this._allocate(t)},q={};H.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=q[t];if(!i){if(i=new H(t,e),i.errors)return console.log(i.errors.join("\n")),null;q[t]=i,y.a.memory.programs++}return i._useCount++,i},H.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete q[this._hash],y.a.memory.programs--)},H.prototype.webglContextRestored=function(){this._program=null},H.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,a=t._state,r=t._material._state,o=t._geometry,l=t._geometry._state,n=t.rtcCenter,h=r.backfaces,u=r.frontface,c=i.camera.project,p=o._getPickTrianglePositions(),d=o._getPickTriangleColors();if(this._program.bind(),e.useProgram++,i.logarithmicDepthBufferEnabled){const e=2/(Math.log(c.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,n?e.getRTCPickViewMatrix(a.rtcCenterHash,n):e.pickViewMatrix),a.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const a=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],i=r.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=a[t];s.uniform3fv(e.pos,n?Object(C.b)(i.dist,i.dir,n,W):i.pos),s.uniform3fv(e.dir,i.dir)}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),e.backfaces!==h&&(h?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=h),e.frontface!==u&&(u?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=u),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(p,l.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(p),d.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),s.drawArrays(l.primitive,0,p.numItems/3)},H.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new P.a(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let a=0,r=t._sectionPlanesState.sectionPlanes.length;a<r;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class Y{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,a=e._state.billboard,r=e._state.stationary,o=[];o.push("// Mesh occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("attribute vec3 position;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec3 offset;"),s&&o.push("uniform mat4 positionsDecodeMatrix;");i&&o.push("varying vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"));"spherical"!==a&&"cylindrical"!==a||(o.push("void billboard(inout mat4 mat) {"),o.push("   mat[0][0] = 1.0;"),o.push("   mat[0][1] = 0.0;"),o.push("   mat[0][2] = 0.0;"),"spherical"===a&&(o.push("   mat[1][0] = 0.0;"),o.push("   mat[1][1] = 1.0;"),o.push("   mat[1][2] = 0.0;")),o.push("   mat[2][0] = 0.0;"),o.push("   mat[2][1] = 0.0;"),o.push("   mat[2][2] =1.0;"),o.push("}"));o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),s&&o.push("localPosition = positionsDecodeMatrix * localPosition;");o.push("mat4 viewMatrix2 = viewMatrix;"),o.push("mat4 modelMatrix2 = modelMatrix;"),r&&o.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==a&&"cylindrical"!==a||(o.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),o.push("billboard(modelMatrix2);"),o.push("billboard(viewMatrix2);"));o.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&o.push("   vWorldPosition = worldPosition;");o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")));return o.push("gl_Position = clipPos;"),o.push("}"),o}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,a=[];a.push("// Mesh occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));if(s){a.push("uniform bool clippable;"),a.push("varying vec4 vWorldPosition;");for(var r=0;r<i.sectionPlanes.length;r++)a.push("uniform bool sectionPlaneActive"+r+";"),a.push("uniform vec3 sectionPlanePos"+r+";"),a.push("uniform vec3 sectionPlaneDir"+r+";")}if(a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(r=0;r<i.sectionPlanes.length;r++)a.push("if (sectionPlaneActive"+r+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}a.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&w.a.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return a.push("}"),a}(e)}}const Q=r.a.vec3(),Z=function(e,t){this._hash=e,this._shaderSource=new Y(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},K={};Z.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=K[t];if(!i){if(i=new Z(t,e),i.errors)return console.log(i.errors.join("\n")),null;K[t]=i,y.a.memory.programs++}return i._useCount++,i},Z.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete K[this._hash],y.a.memory.programs--)},Z.prototype.webglContextRestored=function(){this._program=null},Z.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,a=t._material._state,r=t._state,o=t._geometry._state,l=t.rtcCenter;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.id!==this._lastMaterialId){const t=a.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=a.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=a.id}const n=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCViewMatrix(r.rtcCenterHash,l):n.viewMatrix),r.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const a=i._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t],i=r.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=a[t];s.uniform3fv(e.pos,l?Object(C.b)(i.dist,i.dir,l,Q):i.pos),s.uniform3fv(e.dir,i.dir)}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,n._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=o.id),o.indicesBuf?(s.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),e.drawElements++):o.positions&&s.drawArrays(s.TRIANGLES,0,o.positions.numItems)},Z.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new P.a(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let a=0,r=t._sectionPlanesState.sectionPlanes.length;a<r;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Z.prototype._bindProgram=function(e){const t=this._scene,i=t.camera.project,s=t.canvas.gl;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class J{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=[];s.push("// Mesh shadow vertex shader"),s.push("attribute vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");t&&s.push("varying vec4 vWorldPosition;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&s.push("vWorldPosition = worldPosition;");return s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene,i=(t.canvas.gl,t._sectionPlanesState),s=i.sectionPlanes.length>0,a=[];if(a.push("// Mesh shadow fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),s){a.push("uniform bool clippable;"),a.push("varying vec4 vWorldPosition;");for(var r=0;r<i.sectionPlanes.length;r++)a.push("uniform bool sectionPlaneActive"+r+";"),a.push("uniform vec3 sectionPlanePos"+r+";"),a.push("uniform vec3 sectionPlaneDir"+r+";")}if(a.push("vec4 encodeFloat( const in float depth ) {"),a.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),a.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),a.push("  vec4 comp = fract(depth * bitShift);"),a.push("  comp -= comp.xxyz * bitMask;"),a.push("  return comp;"),a.push("}"),a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(r=0;r<i.sectionPlanes.length;r++)a.push("if (sectionPlaneActive"+r+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return a.push("gl_FragColor = encodeFloat(gl_FragCoord.z);"),a.push("}"),a}(e)}}const $=function(e,t){this._hash=e,this._shaderSource=new J(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},ee={};$.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let s=ee[i];if(!s){if(s=new $(i,e),s.errors)return console.log(s.errors.join("\n")),null;ee[i]=s,y.a.memory.programs++}return s._useCount++,s},$.prototype.put=function(){0===--this._useCount&&(this._program&&this._program.destroy(),delete ee[this._hash],y.a.memory.programs--)},$.prototype.webglContextRestored=function(){this._program=null},$.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene.canvas.gl,s=t._material._state,a=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){const t=s.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const a=s.frontface;e.frontface!==a&&(a?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=a),e.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),e.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),a.combineGeometry){const s=t.vertexBufs;s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),a.combineGeometry?a.indicesBufCombined&&(a.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=a.id),a.combineGeometry?a.indicesBufCombined&&(i.drawElements(a.primitive,a.indicesBufCombined.numItems,a.indicesBufCombined.itemType,0),e.drawElements++):a.indicesBuf?(i.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++):a.positions&&(i.drawArrays(i.TRIANGLES,0,a.positions.numItems),e.drawArrays++)},$.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new P.a(i,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let a=0,r=t._sectionPlanesState.sectionPlanes.length;a<r;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},$.prototype._bindProgram=function(e){this._program||this._allocate(mesh);const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let e,t,a,r,o;for(let l=0,n=this._uSectionPlanes.length;l<n;l++)e=this._uSectionPlanes[l],t=e.active,a=s.sectionPlanes[l],t&&i.uniform1i(t,a.active),r=e.pos,r&&i.uniform3fv(e.pos,a.pos),o=e.dir,o&&i.uniform3fv(e.dir,a.dir)}};var te=i("jSXj"),ie=i("ZzC7");const se=r.a.OBB3(),ae=r.a.vec4(),re=r.a.vec4(),oe=r.a.vec4(),le=r.a.vec3([1,0,0]),ne=r.a.vec3([0,1,0]),he=r.a.vec3([0,0,1]),ue=r.a.vec3(3),ce=r.a.vec3(3),pe=r.a.identityMat4();class de extends s.a{get type(){return"Mesh"}constructor(e,t={}){if(super(e,t),this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new ie.a,this._state=new f.a({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:r.a.vec3(),rtcCenter:null,rtcCenterHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=r.a.vec3(),this._quaternion=r.a.identityQuaternion(),this._rotation=r.a.vec3(),this._position=r.a.vec3(),this._worldMatrix=r.a.identityMat4(),this._worldNormalMatrix=r.a.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,t.rtcCenter&&(this._state.rtcCenter=r.a.vec3(t.rtcCenter),this._state.rtcCenterHash=t.rtcCenter.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=e}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get isMesh(){return!0}get parent(){return this._parentNode}_checkBillboard(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=S.get(this),this._emphasisFillRenderer=T.get(this),this._emphasisEdgesRenderer=O.get(this));const t=this._makePickHash();this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=k.get(this));const i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=Z.get(this))}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)r.a.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=r.a.mat4()),r.a.transposeMat4(this._worldMatrix,this._worldNormalMatrix),r.a.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=r.a.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){r.a.transformOBB3(e,this._geometry.obb,se),r.a.OBB3ToAABB3(se,t);const i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.rtcCenter){const e=this._state.rtcCenter;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}}get geometry(){return this._geometry}get material(){return this._material}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),r.a.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),r.a.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this.__localMatrix||(this.__localMatrix=r.a.identityMat4()),this.__localMatrix.set(e||pe),r.a.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=r.a.identityMat4()),r.a.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}rotate(e,t){return ae[0]=e[0],ae[1]=e[1],ae[2]=e[2],ae[3]=t*r.a.DEGTORAD,r.a.angleAxisToQuaternion(ae,re),r.a.mulQuaternions(this.quaternion,re,oe),this.quaternion=oe,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return ae[0]=e[0],ae[1]=e[1],ae[2]=e[2],ae[3]=t*r.a.DEGTORAD,r.a.angleAxisToQuaternion(ae,re),r.a.mulQuaternions(re,this.quaternion,re),this}rotateX(e){return this.rotate(le,e)}rotateY(e){return this.rotate(ne,e)}rotateZ(e){return this.rotate(he,e)}translate(e,t){return r.a.vec3ApplyQuaternion(this.quaternion,e,ue),r.a.mulVec3Scalar(ue,t,ce),r.a.addVec3(this.position,ce,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(le,e)}translateY(e){return this.translate(ne,e)}translateZ(e){return this.translate(he,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set rtcCenter(e){e?(this._state.rtcCenter||(this._state.rtcCenter=r.a.vec3()),this._state.rtcCenter.set(e),this._state.rtcCenterHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.rtcCenter&&(this._state.rtcCenter=null,this._state.rtcCenterHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this._state.rtcCenter}get numTriangles(){return this._numTriangles}set visible(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}get visible(){return this._state.visible}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}get xrayed(){return this._state.xrayed}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}get highlighted(){return this._state.highlighted}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}get selected(){return this._state.selected}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set culled(e){this._state.culled=!!e,this.glRedraw()}get culled(){return this._state.culled}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get clippable(){return this._state.clippable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get collidable(){return this._state.collidable}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}get pickable(){return this._state.pickable}set castsShadow(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get castsShadow(){return this._state.castsShadow}set receivesShadow(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get receivesShadow(){return this._state.receivesShadow}get saoEnabled(){return!1}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get colorize(){return this._state.colorize}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const i=null!==e&&void 0!==e;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get layer(){return this._state.layer}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get offset(){return this._state.offset}get isDrawable(){return!0}get isStateSortable(){return!0}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const t=this._xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges){this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0}if(t.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const t=e[i],s=this.renderFlags;if(t.active)if(this._state.rtcCenter){const e=r.a.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return!1;const a=0===e;s.sectionPlanesActivePerLayer[i]=a}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=S.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=S.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=T.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=T.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=T.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=O.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=O.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=O.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=O.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=O.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._occlusionRenderer||(this._occlusionRenderer=Z.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=$.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=k.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=H.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i){_e(this,e,t,i)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const _e=function(){const e=r.a.vec3(),t=r.a.vec3(),i=r.a.vec3(),s=r.a.vec3(),a=r.a.vec3(),o=r.a.vec3(),l=r.a.vec4(),n=r.a.vec3(),h=r.a.vec3(),u=r.a.vec3(),c=r.a.vec3(),p=r.a.vec3(),d=r.a.vec3(),_=r.a.vec3(),m=r.a.vec3(),f=r.a.vec3(),g=r.a.vec4(),M=r.a.vec4(),v=r.a.vec4(),x=r.a.vec3(),b=r.a.vec3(),P=r.a.vec3(),y=r.a.vec3(),w=r.a.vec3(),C=r.a.vec3(),E=r.a.vec3(),D=r.a.vec3(),S=r.a.vec3(),L=r.a.vec3(),F=r.a.vec3();return function(A,R,T,B){var N=B.primIndex;if(void 0!==N&&null!==N&&N>-1){const G=A.geometry._state,z=A.scene,V=z.camera,k=z.canvas;if("triangles"===G.primitiveName){B.primitive="triangle";const z=N,X=G.indices,j=G.positions;let W,H,q,Y;if(X){var I=X[z+0],U=X[z+1],O=X[z+2];o[0]=I,o[1]=U,o[2]=O,B.indices=o,W=3*I,H=3*U,q=3*O}else W=3*z,H=W+3,q=H+3;if(i[0]=j[W+0],i[1]=j[W+1],i[2]=j[W+2],s[0]=j[H+0],s[1]=j[H+1],s[2]=j[H+2],a[0]=j[q+0],a[1]=j[q+1],a[2]=j[q+2],G.compressGeometry){const e=G.positionsDecodeMatrix;e&&(te.a.decompressPosition(i,e,i),te.a.decompressPosition(s,e,s),te.a.decompressPosition(a,e,a))}B.canvasPos?(Y=B.canvasPos,r.a.canvasPosToLocalRay(k.canvas,R,T,A.worldMatrix,Y,e,t)):B.origin&&B.direction&&r.a.worldRayToLocalRay(A.worldMatrix,B.origin,B.direction,e,t),r.a.normalizeVec3(t),r.a.rayPlaneIntersect(e,t,i,s,a,l),B.localPos=l,B.position=l,g[0]=l[0],g[1]=l[1],g[2]=l[2],g[3]=1,r.a.transformVec4(A.worldMatrix,g,M),n[0]=M[0],n[1]=M[1],n[2]=M[2],B.worldPos=n,r.a.transformVec4(V.matrix,M,v),h[0]=v[0],h[1]=v[1],h[2]=v[2],B.viewPos=h,r.a.cartesianToBarycentric(l,i,s,a,u),B.bary=u;const Q=G.normals;if(Q){if(G.compressGeometry){const e=3*I,t=3*U,i=3*O;te.a.decompressNormal(Q.subarray(e,e+2),c),te.a.decompressNormal(Q.subarray(t,t+2),p),te.a.decompressNormal(Q.subarray(i,i+2),d)}else c[0]=Q[W],c[1]=Q[W+1],c[2]=Q[W+2],p[0]=Q[H],p[1]=Q[H+1],p[2]=Q[H+2],d[0]=Q[q],d[1]=Q[q+1],d[2]=Q[q+2];const e=r.a.addVec3(r.a.addVec3(r.a.mulVec3Scalar(c,u[0],x),r.a.mulVec3Scalar(p,u[1],b),P),r.a.mulVec3Scalar(d,u[2],y),w);B.worldNormal=r.a.normalizeVec3(r.a.transformVec3(A.worldNormalMatrix,e,C))}const Z=G.uv;if(Z){if(_[0]=Z[2*I],_[1]=Z[2*I+1],m[0]=Z[2*U],m[1]=Z[2*U+1],f[0]=Z[2*O],f[1]=Z[2*O+1],G.compressGeometry){const e=G.uvDecodeMatrix;e&&(te.a.decompressUV(_,e,_),te.a.decompressUV(m,e,m),te.a.decompressUV(f,e,f))}B.uv=r.a.addVec3(r.a.addVec3(r.a.mulVec2Scalar(_,u[0],E),r.a.mulVec2Scalar(m,u[1],D),S),r.a.mulVec2Scalar(f,u[2],L),F)}}}}}();var me=i("MXr8");function fe(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);let s=e.xSegments||1;s<0&&(console.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=e.xSegments||1;r<0&&(console.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const o=e.center,l=o?o[0]:0,n=o?o[1]:0,h=o?o[2]:0,u=t/2,c=i/2,p=Math.floor(s)||1,d=Math.floor(r)||1,_=p+1,m=d+1,f=t/p,g=i/d,M=new Float32Array(_*m*3),v=new Float32Array(_*m*3),x=new Float32Array(_*m*2);let b,P,y,w,C,E,D,S=0,L=0;for(b=0;b<m;b++){const e=b*g-c;for(P=0;P<_;P++)y=P*f-u,M[S]=y+l,M[S+1]=n,M[S+2]=-e+h,v[S+2]=-1,x[L]=P/p,x[L+1]=(d-b)/d,S+=3,L+=2}S=0;const F=new(M.length/3>65535?Uint32Array:Uint16Array)(p*d*6);for(b=0;b<d;b++)for(P=0;P<p;P++)w=P+_*b,C=P+_*(b+1),E=P+1+_*(b+1),D=P+1+_*b,F[S]=D,F[S+1]=C,F[S+2]=w,F[S+3]=D,F[S+4]=E,F[S+5]=C,S+=6;return a.a.apply(e,{positions:M,normals:v,uv:x,indices:F})}const ge={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function Me(e,t,i){if(void 0===t)return i;const s=ge[t];return void 0===s?i:e[s]}const ve=new Uint8Array([0,0,0,1]);class xe{constructor(e,t){this.gl=e,this.target=t||e.TEXTURE_2D,this.texture=e.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}setPreloadColor(e){e?(ve[0]=Math.floor(255*e[0]),ve[1]=Math.floor(255*e[1]),ve[2]=Math.floor(255*e[2]),ve[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(ve[0]=0,ve[1]=0,ve[2]=0,ve[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,t.NEAREST),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=e.length;i<s;i++)t.texImage2D(e[i],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,ve)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,ve);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t){const i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t.flipY),this.target===i.TEXTURE_CUBE_MAP){if(a.a.isArray(e)){const t=e,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,a=s.length;e<a;e++)i.texImage2D(s[e],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t[e])}}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);i.bindTexture(this.target,null)}setProps(e){const t=this.gl;if(t.bindTexture(this.target,this.texture),e.minFilter){const i=Me(t,e.minFilter);i&&(t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(e.magFilter){const i=Me(t,e.magFilter);i&&t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i)}if(e.wrapS){const i=Me(t,e.wrapS);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_S,i)}if(e.wrapT){const i=Me(t,e.wrapT);i&&t.texParameteri(this.target,t.TEXTURE_WRAP_T,i)}t.bindTexture(this.target,null)}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function be(e){if(!Pe(e.width)||!Pe(e.height)){const t=document.createElement("canvas");t.width=ye(e.width),t.height=ye(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function Pe(e){return 0===(e&e-1)}function ye(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class we extends s.a{get type(){return"Texture"}constructor(e,t={}){super(e,t),this._state=new f.a({texture:new xe(this.scene.canvas.gl),matrix:r.a.identityMat4(),hasMatrix:t.translate&&(0!==t.translate[0]||0!==t.translate[1])||!!t.rotate||t.scale&&(0!==t.scale[0]||0!==t.scale[1]),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=r.a.vec2([0,0]),this._scale=r.a.vec2([1,1]),this._rotate=r.a.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),y.a.memory.textures++}_checkMinFilter(e){return"linear"!==(e=e||"linearMipmapLinear")&&"linearMipmapNearest"!==e&&"linearMipmapLinear"!==e&&"nearestMipmapLinear"!==e&&"nearestMipmapNearest"!==e&&(this.error("Unsupported value for 'minFilter': '"+e+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),e="linearMipmapLinear"),e}_checkMagFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkFilter(e){return"linear"!==(e=e||"linear")&&"nearest"!==e&&(this.error("Unsupported value for 'magFilter': '"+e+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),e="linear"),e}_checkWrapS(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapS': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkWrapT(e){return"clampToEdge"!==(e=e||"repeat")&&"mirroredRepeat"!==e&&"repeat"!==e&&(this.error("Unsupported value for 'wrapT': '"+e+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),e="repeat"),e}_checkFlipY(e){return!!e}_checkEncoding(e){return"linear"!==(e=e||"linear")&&"sRGB"!==e&&"gamma"!==e&&(this.error("Unsupported value for 'encoding': '"+e+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),e="linear"),e}_webglContextRestored(){this._state.texture=new xe(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;0===this._translate[0]&&0===this._translate[1]||(t=r.a.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=r.a.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?r.a.mulMat4(t,i):i),0!==this._rotate&&(i=r.a.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?r.a.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this.glRedraw()}set image(e){this._image=be(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=be(i),t._state.texture.setImage(i,t._state),t._state.texture.setProps(t._state),t.scene.loading--,t.scene.canvas.spinner.processes--,t.glRedraw()},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),y.a.memory.textures--}}function Ce(e={}){let t=e.size||1;t<0&&(console.error("negative size not allowed - will invert"),t*=-1);let i=e.divisions||1;i<0&&(console.error("negative divisions not allowed - will invert"),i*=-1),i<1&&(i=1),t=t||10,i=i||10;const s=t/i,r=t/2,o=[],l=[];let n=0;for(let a=0,h=-r;a<=i;a++,h+=s)o.push(-r),o.push(0),o.push(h),o.push(r),o.push(0),o.push(h),o.push(h),o.push(0),o.push(-r),o.push(h),o.push(0),o.push(r),l.push(n++),l.push(n++),l.push(n++),l.push(n++);return a.a.apply(e,{primitive:"lines",positions:o,indices:l})}var Ee=i("bY37");const De=r.a.vec3(),Se=r.a.vec3(),Le=(r.a.vec3(),r.a.vec3([0,-1,0])),Fe=r.a.vec4([0,0,0,1]);class Ae extends s.a{constructor(e,t={}){super(e,t),this._src=null,this._image=null,this._pos=r.a.vec3(),this._rtcCenter=r.a.vec3(),this._rtcPos=r.a.vec3(),this._dir=r.a.vec3(),this._size=1,this._imageSize=r.a.vec2(),this._texture=new we(this),this._plane=new de(this,{geometry:new Ee.a(this,fe({center:[0,0,0],xSize:1,zSize:1,xSegments:10,zSegments:10})),material:new me.a(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0}),clippable:t.clippable}),this._grid=new de(this,{geometry:new Ee.a(this,Ce({size:1,divisions:10})),material:new me.a(this,{diffuse:[0,0,0],ambient:[0,0,0],emissive:[.2,.8,.2]}),position:[0,.001,0],clippable:t.clippable}),this._node=new m(this,{rotation:[0,0,0],position:[0,0,0],scale:[1,1,1],clippable:!1,children:[this._plane,this._grid]}),this._gridVisible=!1,this.visible=!0,this.gridVisible=t.gridVisible,this.position=t.position,this.rotation=t.rotation,this.dir=t.dir,this.size=t.size,this.collidable=t.collidable,this.clippable=t.clippable,this.pickable=t.pickable,this.opacity=t.opacity,t.image?this.image=t.image:this.src=t.src}set visible(e){this._plane.visible=e,this._grid.visible=this._gridVisible&&e}get visible(){return this._plane.visible}set gridVisible(e){e=!1!==e,this._gridVisible=e,this._grid.visible=this._gridVisible&&this.visible}get gridVisible(){return this._gridVisible}set image(e){this._image=e,this._image&&(this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}get image(){return this._image}set src(e){if(this._src=e,this._src){this._image=null;const e=new Image;e.onload=()=>{this._texture.image=e,this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage()},e.src=this._src}}get src(){return this._src}set position(e){this._pos.set(e||[0,0,0]),Object(C.c)(this._pos,this._rtcCenter,this._rtcPos),this._node.rtcCenter=this._rtcCenter,this._node.position=this._rtcPos}get position(){return this._pos}set rotation(e){this._node.rotation=e}get rotation(){return this._node.rotation}set size(e){this._size=void 0===e||null===e?1:e,this._image&&this._updatePlaneSizeFromImage()}get size(){return this._size}set dir(e){if(this._dir.set(e||[0,0,-1]),e){const t=this.scene.center,i=[-this._dir[0],-this._dir[1],-this._dir[2]];r.a.subVec3(t,this.position,De);const s=-r.a.dotVec3(i,De);r.a.normalizeVec3(i),r.a.mulVec3Scalar(i,s,Se),r.a.vec3PairToQuaternion(Le,e,Fe),this._node.quaternion=Fe}}get dir(){return this._dir}set collidable(e){this._node.collidable=!1!==e}get collidable(){return this._node.collidable}set clippable(e){this._node.clippable=!1!==e}get clippable(){return this._node.clippable}set pickable(e){this._node.pickable=!1!==e}get pickable(){return this._node.pickable}set opacity(e){this._node.opacity=e}get opacity(){return this._node.opacity}destroy(){this._state.destroy(),super.destroy()}_updatePlaneSizeFromImage(){const e=this._size,t=this._imageSize[0],i=this._imageSize[1],s=i/t;this._node.scale=t>i?[e,1,e*s]:[e*s,1,e]}}}}]);