(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[12],{RFN9:function(e,t,i){"use strict";function s(e,t){const i=e.rootMetaObject;return i?n(i,t):(t.push("Can't build storeys hierarchy: model is empty"),!1)}function n(e,t,i=0,s,o){s=s||{foundIFCBuildingStoreys:!1};const r=e.type,d=e.children;if("IfcBuilding"===r)o=!0;else if("IfcBuildingStorey"===r){if(!o)return t.push("Can't build storeys hierarchy: IfcBuildingStorey found without parent IfcBuilding"),!1;s.foundIFCBuildingStoreys=!0}if(d)for(let h=0,c=d.length;h<c;h++){if(!n(d[h],t,i+1,s,o))return!1}return 0===i&&s.foundIFCBuildingStoreys,!0}i.r(t),i.d(t,"TreeViewPlugin",(function(){return h}));const o=new(i("jWoc").a);class r{constructor(e,t,i,s,n){if(!n.containerElement)throw"Config expected: containerElement";const r=s.rootMetaObject;r&&(this.errors=[],this.valid=!0,this.metaModel=s,this._id=o.addItem(),this._baseId=""+this._id,this._viewer=e,this._treeViewPlugin=t,this._rootMetaObject=r,this._containerElement=n.containerElement,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._rootName=n.rootName,this._sortNodes=n.sortNodes,this._pruneEmptyNodes=n.pruneEmptyNodes,this._showListItemElementId=null,this._containerElement.oncontextmenu=e=>{e.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",(e=>{if(this._muteSceneEvents)return;const t=e.id,i=this._objectNodes[t];if(!i)return;const s=e.visible;if(!(s!==i.checked))return;this._muteTreeEvents=!0,i.checked=s,s?i.numVisibleEntities++:i.numVisibleEntities--;const n=document.getElementById(i.nodeId);n&&(n.checked=s);let o=i.parent;for(;o;){o.checked=s,s?o.numVisibleEntities++:o.numVisibleEntities--;const e=document.getElementById(o.nodeId);if(e){const t=o.numVisibleEntities>0;t!==e.checked&&(e.checked=t)}o=o.parent}this._muteTreeEvents=!1})),this.switchExpandHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._expandSwitchElement(t)},this.switchCollapseHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._collapseSwitchElement(t)},this._checkboxChangeHandler=e=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const t=e.target,i=t.checked,s=t.id,n=this._nodeToObjectID(s),o=this._objectNodes[n],r=this._viewer.scene.objects;let d=0;this._withNodeTree(o,(e=>{const t=e.objectId,s=e.nodeId,n=r[t],o=0===e.children.length;e.numVisibleEntities=i?e.numEntities:0,o&&i!==e.checked&&d++,e.checked=i;const h=document.getElementById(s);h&&(h.checked=i),n&&(n.visible=i)}));let h=o.parent;for(;h;){h.checked=i;const e=document.getElementById(h.nodeId);i?h.numVisibleEntities+=d:h.numVisibleEntities-=d;const t=h.numVisibleEntities>0;t!==e.checked&&(e.checked=t),h=h.parent}this._muteSceneEvents=!1},this._hierarchy=n.hierarchy||"containment",this._autoExpandDepth=n.autoExpandDepth||0,this._createNodes())}_nodeToObjectID(e){return e.substring(this._baseId.length)}_objectToNodeID(e){return this._baseId+e}setAutoExpandDepth(e=0){this._autoExpandDepth=e}setHierarchy(e){this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._validate(),this.valid?this._createEnabledNodes():this._createDisabledNodes()}_validate(){switch(this.errors=[],this._hierarchy){case"storeys":this.valid=s(this.metaModel,this.errors);break;case"types":this.valid=(e=this.metaModel,t=this.errors,!!e.rootMetaObject||(t.push("Can't build types hierarchy: model is empty"),!1));break;case"containment":default:this.valid=function(e,t){return!!e.rootMetaObject||(t.push("Can't build containment hierarchy: model is empty"),!1)}(this.metaModel,this.errors)}var e,t;return this.valid}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - perhaps this model is not an IFC model?");break;case"types":this._createTypesNodes();break;case"containment":default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}_createDisabledNodes(){const e=this._rootMetaObject,t=e.type,i=e.name,s=i&&""!==i&&"Undefined"!==i&&"Default"!==i?i:t,n=document.createElement("ul"),o=document.createElement("li");n.appendChild(o),this._containerElement.appendChild(n),this._rootElement=n;const r=document.createElement("a");r.href="#",r.textContent="!",r.classList.add("warn"),r.classList.add("warning"),o.appendChild(r);const d=document.createElement("span");d.textContent=s,o.appendChild(d)}_findEmptyNodes(e=this._rootMetaObject,t=0){const i=this._treeViewPlugin.viewer.scene,s=e.children,n=e.id,o=i.objects[n];if(e._countEntities=0,o&&e._countEntities++,s)for(let r=0,d=s.length;r<d;r++){const t=s[r];t._countEntities=this._findEmptyNodes(t),e._countEntities+=t._countEntities}return e._countEntities}_createStoreysNodes(e=this._rootMetaObject,t,i,s){if(this._pruneEmptyNodes&&0===e._countEntities)return;const n=e.type,o=e.name,r=e.children,d=e.id;if("IfcBuilding"===n)t={nodeId:this._objectToNodeID(d),objectId:d,title:this._rootName||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:n),type:n,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t;else if("IfcBuildingStorey"===n){if(!t)return void this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");i={nodeId:this._objectToNodeID(d),objectId:d,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:n,type:n,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},t.children.push(i),this._objectNodes[i.objectId]=i,s={}}else if(i){if(this._viewer.scene.objects[d]){let e=(s=s||{})[n];if(!e){const t=i.objectId+"."+n;e={nodeId:this._objectToNodeID(t),objectId:t,title:n,type:n,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},i.children.push(e),this._objectNodes[t]=e,s[n]=e}const t={nodeId:this._objectToNodeID(d),objectId:d,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:n,type:n,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};e.children.push(t),this._objectNodes[t.objectId]=t}}if(r)for(let h=0,c=r.length;h<c;h++){const e=r[h];this._createStoreysNodes(e,t,i,s)}}_createTypesNodes(e=this._rootMetaObject,t,i){if(this._pruneEmptyNodes&&0===e._countEntities)return;const s=e.type,n=e.name,o=e.children,r=e.id;if(e.id===this._rootMetaObject.id)t={nodeId:this._objectToNodeID(r),objectId:r,title:this._rootName||(n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,i={};else if(t){if(this._viewer.scene.objects[r]){let e=i[s];e||(e={nodeId:this._objectToNodeID(t.objectId+"."+s),objectId:t.objectId+"."+s,title:s,type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},t.children.push(e),this._objectNodes[e.objectId]=e,i[s]=e);const o={nodeId:this._objectToNodeID(r),objectId:r,title:n&&""!==n&&"Default"!==n?n:s,type:s,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};e.children.push(o),this._objectNodes[o.objectId]=o}}if(o)for(let d=0,h=o.length;d<h;d++){const e=o[d];this._createTypesNodes(e,t,i)}}_createContainmentNodes(e=this._rootMetaObject,t){if(this._pruneEmptyNodes&&0===e._countEntities)return;const i=e.type,s=e.name||i,n=e.children,o=e.id,r={nodeId:this._objectToNodeID(o),objectId:o,title:t?s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:i:this._rootName||s,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};if(t?t.children.push(r):this._rootNodes.push(r),this._objectNodes[r.objectId]=r,n)for(let d=0,h=n.length;d<h;d++){const e=n[d];this._createContainmentNodes(e,r)}}_doSortNodes(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e];this._sortChildren(t)}}_sortChildren(e){const t=e.children;if(t&&0!==t.length){"storeys"===this._hierarchy&&"IfcBuilding"===e.type?t.sort(this._getSpatialSortFunc()):t.sort(this._alphaSortFunc);for(let e=0,i=t.length;e<i;e++){const i=t[e];this._sortChildren(i)}}}_getSpatialSortFunc(){const e=this._treeViewPlugin.viewer,t=e.scene,i=t.camera,s=e.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=(e,n)=>{e.aabb&&n.aabb||(e.aabb||(e.aabb=t.getAABB(s.getObjectIDsInSubtree(e.objectId))),n.aabb||(n.aabb=t.getAABB(s.getObjectIDsInSubtree(n.objectId))));let o=0;return o=i.xUp?0:i.yUp?1:2,e.aabb[o]>n.aabb[o]?-1:e.aabb[o]<n.aabb[o]?1:0})}_alphaSortFunc(e,t){const i=e.title.toUpperCase(),s=t.title.toUpperCase();return i<s?-1:i>s?1:0}_synchNodesToEntities(){const e=this._rootMetaObject.getObjectIDsInSubtree(),t=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects;for(let s=0,n=e.length;s<n;s++){const n=e[s];if(t[n]){const e=this._objectNodes[n];if(e){const t=i[n];if(t){const i=t.visible;e.numEntities=1,i?(e.numVisibleEntities=1,e.checked=!0):(e.numVisibleEntities=0,e.checked=!1);let s=e.parent;for(;s;)s.numEntities++,i&&(s.numVisibleEntities++,s.checked=!0),s=s.parent}}}}}_withNodeTree(e,t){t(e);const i=e.children;if(i)for(let s=0,n=i.length;s<n;s++)this._withNodeTree(i[s],t)}_createTrees(){if(0===this._rootNodes.length)return;const e=this._rootNodes.map((e=>this._createNodeElement(e))),t=document.createElement("ul");e.forEach((e=>{t.appendChild(e)})),this._containerElement.appendChild(t),this._rootElement=t}_createNodeElement(e){const t=document.createElement("li"),i=e.nodeId;if(t.id="node-"+i,e.children.length>0){const e="switch-"+i,s=document.createElement("a");s.href="#",s.id=e,s.textContent="+",s.classList.add("plus"),s.addEventListener("click",this.switchExpandHandler),t.appendChild(s)}const s=document.createElement("input");s.id=i,s.type="checkbox",s.checked=e.checked,s.style["pointer-events"]="all",s.addEventListener("change",this._checkboxChangeHandler),t.appendChild(s);const n=document.createElement("span");return n.textContent=e.title,t.appendChild(n),n.oncontextmenu=t=>{this._treeViewPlugin.fire("contextmenu",{event:t,viewer:this._viewer,treeViewPlugin:this._treeViewPlugin,treeViewNode:e}),t.preventDefault()},n.onclick=t=>{this._treeViewPlugin.fire("nodeTitleClicked",{event:t,viewer:this._viewer,treeViewPlugin:this._treeViewPlugin,treeViewNode:e}),t.preventDefault()},t}expandToDepth(e){const t=(i,s)=>{if(s===e)return;const n="switch-"+i.nodeId,o=document.getElementById(n);if(o){this._expandSwitchElement(o);const e=i.children;for(var r=0,d=e.length;r<d;r++){const i=e[r];t(i,s+1)}}};for(let i=0,s=this._rootNodes.length;i<s;i++){const e=this._rootNodes[i];t(e,0)}}collapse(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e].objectId;this._collapseNode(t)}}showNode(e){this._showListItemElementId&&this.unShowNode();const t=this._objectNodes[e];if(!t)return;const i=t.nodeId,s="switch-"+i,n=document.getElementById(s);if(n)return this._expandSwitchElement(n),void n.scrollIntoView();const o=[];o.unshift(t);let r=t.parent;for(;r;)o.unshift(r),r=r.parent;for(let c=0,l=o.length;c<l;c++){const e="switch-"+o[c].nodeId,t=document.getElementById(e);t&&this._expandSwitchElement(t)}const d="node-"+i,h=document.getElementById(d);h.scrollIntoView({block:"center"}),h.classList.add("highlighted-node"),this._showListItemElementId=d}unShowNode(){if(!this._showListItemElementId)return;const e=document.getElementById(this._showListItemElementId);e?(e.classList.remove("highlighted-node"),this._showListItemElementId=null):this._showListItemElementId=null}_expandSwitchElement(e){const t=e.parentElement;if(t.getElementsByTagName("li")[0])return;const i=t.id.replace("node-",""),s=this._nodeToObjectID(i),n=this._objectNodes[s].children.map((e=>this._createNodeElement(e))),o=document.createElement("ul");n.forEach((e=>{o.appendChild(e)})),t.appendChild(o),e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",this.switchExpandHandler),e.addEventListener("click",this.switchCollapseHandler)}_collapseNode(e){const t="switch-"+this._objectToNodeID(e),i=document.getElementById(t);this._collapseSwitchElement(i)}_collapseSwitchElement(e){if(!e)return;const t=e.parentElement;if(!t)return;const i=t.querySelector("ul");i&&(t.removeChild(i),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",this.switchCollapseHandler),e.addEventListener("click",this.switchExpandHandler))}destroy(){this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0,o.removeItem(this._id))}}var d=i("nJY8");class h extends d.a{constructor(e,t={}){if(super("TreeViewPlugin",e),t.containerElement){if(this._containerElement=t.containerElement,this._modelTreeViews={},this._autoAddModels=!1!==t.autoAddModels,this._autoExpandDepth=t.autoExpandDepth||0,this._sortNodes=!1!==t.sortNodes,this._pruneEmptyNodes=!1!==t.pruneEmptyNodes,this._autoAddModels){const e=Object.keys(this.viewer.scene.models);for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addModel(i)}this.viewer.scene.on("modelLoaded",(e=>{this.viewer.metaScene.metaModels[e]&&this.addModel(e)}))}this.hierarchy=t.hierarchy}else this.error("Config expected: containerElement")}get modelTreeViews(){return this._modelTreeViews}set hierarchy(e){"containment"!==(e=e||"containment")&&"storeys"!==e&&"types"!==e&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy=e;for(let t in this._modelTreeViews)this._modelTreeViews.hasOwnProperty(t)&&this._modelTreeViews[t].setHierarchy(this._hierarchy)}get hierarchy(){return this._hierarchy}addModel(e,t={}){if(!this._containerElement)return;const i=this.viewer.scene.models[e];if(!i)throw"Model not found: "+e;const s=this.viewer.metaScene.metaModels[e];if(!s)return void this.error("MetaModel not found: "+e);if(this._modelTreeViews[e])return void this.warn("Model already added: "+e);const n=new r(this.viewer,this,i,s,{containerElement:this._containerElement,autoExpandDepth:this._autoExpandDepth,hierarchy:this._hierarchy,sortNodes:this._sortNodes,pruneEmptyNodes:this._pruneEmptyNodes,rootName:t.rootName});return this._modelTreeViews[e]=n,i.on("destroyed",(()=>{this.removeModel(i.id)})),n}removeModel(e){if(!this._containerElement)return;const t=this._modelTreeViews[e];t?(t.destroy(),delete this._modelTreeViews[e]):this.warn("Model not added: "+e)}collapse(){for(let e in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(e)){this._modelTreeViews[e].collapse()}}showNode(e){this.unShowNode();const t=this.viewer.metaScene.metaObjects[e];if(!t)return void this.error("MetaObject not found: "+e);const i=t.metaModel.id,s=this._modelTreeViews[i];s?s.showNode(e):this.error("Object not in this TreeView: "+e)}unShowNode(){for(let e in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(e)){this._modelTreeViews[e].unShowNode()}}expandToDepth(e){for(let t in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(t)){const i=this._modelTreeViews[t];i.collapse(),i.expandToDepth(e)}}withNodeTree(e,t){t(e);const i=e.children;if(i)for(let s=0,n=i.length;s<n;s++)this.withNodeTree(i[s],t)}destroy(){if(this._containerElement){for(let e in this._modelTreeViews)this._modelTreeViews.hasOwnProperty(e)&&this._modelTreeViews[e].destroy();this._modelTreeViews={},super.destroy()}}}}}]);